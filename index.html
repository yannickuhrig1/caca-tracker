<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>ğŸ’© Les cacas de ClÃ©mence</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="CacaTracker" />
  <meta name="theme-color" content="#d97706" id="theme-color-meta" />

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="logo.png" />

  <!-- Apple Touch Icon PWA iOS -->
  <link rel="apple-touch-icon" href="logo.png">
  <link rel="apple-touch-icon" sizes="180x180" href="logo.png">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Space+Mono:wght@400;700&display=swap');

    /* ===================== THEMES ===================== */
    :root {
      --bg-from: #fef3c7; --bg-via: #fff7ed; --bg-to: #fdf2f8;
      --header-from: #d97706; --header-to: #ea580c;
      --card-bg: rgba(255,255,255,0.7);
      --card-border: rgba(255,255,255,0.5);
      --text-primary: #0f172a; --text-secondary: #475569;
      --nav-bg: rgba(255,255,255,0.92);
      --btn-shadow: #92400e;
      --accent: #f59e0b;
      --font: 'Fredoka', system-ui, sans-serif;
    }

    [data-theme="dark"] {
      --bg-from: #0f172a; --bg-via: #1e1b4b; --bg-to: #0c0a09;
      --header-from: #1e293b; --header-to: #312e81;
      --card-bg: rgba(30,27,75,0.7);
      --card-border: rgba(99,102,241,0.3);
      --text-primary: #e2e8f0; --text-secondary: #94a3b8;
      --nav-bg: rgba(15,23,42,0.95);
      --btn-shadow: #312e81;
      --accent: #818cf8;
      --font: 'Fredoka', system-ui, sans-serif;
    }

    [data-theme="medical"] {
      --bg-from: #f0fdf4; --bg-via: #f0f9ff; --bg-to: #f8fafc;
      --header-from: #059669; --header-to: #0284c7;
      --card-bg: rgba(255,255,255,0.9);
      --card-border: rgba(5,150,105,0.2);
      --text-primary: #134e4a; --text-secondary: #64748b;
      --nav-bg: rgba(255,255,255,0.97);
      --btn-shadow: #047857;
      --accent: #059669;
      --font: 'Space Mono', monospace;
    }

    /* ===================== BASE ===================== */
    * { box-sizing: border-box; }
    body {
      font-family: var(--font);
      background: linear-gradient(135deg, var(--bg-from), var(--bg-via), var(--bg-to));
      min-height: 100vh;
      min-height: 100dvh;
      padding-bottom: max(96px, env(safe-area-inset-bottom, 0px) + 80px);
      color: var(--text-primary);
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior-y: contain;
      transition: background 0.4s ease;
    }

    /* safe area top for iPhone notch */
    header {
      padding-top: max(24px, env(safe-area-inset-top, 0px) + 16px) !important;
    }

    /* safe area bottom for iPhone home indicator */
    nav {
      padding-bottom: max(12px, env(safe-area-inset-bottom, 0px)) !important;
    }

    /* ===================== HEADER ===================== */
    .app-header {
      background: linear-gradient(135deg, var(--header-from), var(--header-to));
      transition: background 0.4s ease;
    }

    /* ===================== CARDS ===================== */
    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      transition: background 0.4s ease;
    }

    /* ===================== POOP BTN ===================== */
    .poop-btn {
      box-shadow: 0 14px 0 0 var(--btn-shadow);
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .poop-btn:active {
      transform: translateY(10px) scale(.97);
      box-shadow: 0 4px 0 0 var(--btn-shadow);
    }

    /* ===================== TABS ===================== */
    .tab-content { display:none; }
    .tab-content.active { display:block; animation: slideUp .22s ease-out; }
    @keyframes slideUp { from{ opacity:0; transform:translateY(12px);} to{opacity:1; transform:translateY(0);} }

    /* ===================== NAV ===================== */
    .bottom-nav {
      background: var(--nav-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-top: 1px solid var(--card-border);
      transition: background 0.4s ease;
    }
    .tab-btn { color: var(--text-secondary); border-radius: 1rem; transition: all .15s ease; }
    .tab-btn.active { color: var(--accent); background: color-mix(in srgb, var(--accent) 12%, transparent); }

    /* ===================== TOGGLE ===================== */
    .toggle-wrap { display: inline-flex; align-items: center; gap: 10px; cursor: pointer; }
    .toggle-wrap input { display: none; }
    .toggle-track {
      width: 52px; height: 28px; background: #e2e8f0; border-radius: 99px;
      position: relative; transition: background .2s;
      flex-shrink: 0;
    }
    .toggle-wrap input:checked ~ .toggle-track { background: var(--accent); }
    .toggle-thumb {
      position: absolute; top: 4px; left: 4px;
      width: 20px; height: 20px;
      background: white; border-radius: 50%;
      transition: transform .2s; box-shadow: 0 2px 6px #0003;
    }
    .toggle-wrap input:checked ~ .toggle-track .toggle-thumb { transform: translateX(24px); }

    /* ===================== STAT BARS ===================== */
    .stat-bar { height: 12px; border-radius: 99px; background: color-mix(in srgb, var(--text-secondary) 15%, transparent); overflow: hidden; }
    .stat-fill { height: 100%; border-radius: 99px; transition: width .6s cubic-bezier(.4,0,.2,1); }
    .stat-row { display: grid; grid-template-columns: 75px 1fr 55px; align-items: center; gap: 8px; }

    /* ===================== CONFETTI ===================== */
    .confetti { position: fixed; pointer-events:none; z-index: 9999; animation: fall 3s linear forwards; font-size: 28px; }
    @keyframes fall { 0%{transform:translateY(-80px) rotate(0deg);opacity:1;} 100%{transform:translateY(110vh) rotate(720deg);opacity:0;} }

    /* ===================== THEME PICKER ===================== */
    .theme-dot { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: border-color .15s, transform .15s; flex-shrink: 0; }
    .theme-dot.selected { border-color: white; transform: scale(1.2); box-shadow: 0 0 0 2px var(--accent); }

    /* ===================== DRAWER ===================== */
    #drawer { overscroll-behavior: contain; }
    .drawer-inner { max-height: 92dvh; overflow-y: auto; -webkit-overflow-scrolling: touch; }

    /* ===================== DARK TEXT ON DARK THEME ===================== */
    [data-theme="dark"] .text-slate-600 { color: #94a3b8; }
    [data-theme="dark"] .text-slate-700 { color: #cbd5e1; }
    [data-theme="dark"] .text-slate-900 { color: #e2e8f0; }
    [data-theme="dark"] .bg-white\/60, [data-theme="dark"] .bg-white\/70 {
      background: rgba(30,27,75,0.7) !important;
    }
    [data-theme="dark"] .border-gray-200 { border-color: rgba(99,102,241,0.2); }
    [data-theme="dark"] #drawer > div { background: #1e1b4b; }
    [data-theme="dark"] .bg-white { background: #1e1b4b !important; }
    [data-theme="dark"] .border-b { border-color: rgba(99,102,241,0.2); }
    [data-theme="dark"] textarea, [data-theme="dark"] input[type="datetime-local"] {
      background: #0f172a; color: #e2e8f0; border-color: #4338ca;
    }
    [data-theme="dark"] .text-slate-800 { color: #e2e8f0; }
    [data-theme="dark"] .bg-gray-200 { background: #334155; }
    [data-theme="dark"] .bg-amber-50 { background: #1e1b4b; }
    [data-theme="dark"] .bg-green-50 { background: rgba(5,150,105,0.15); }
    [data-theme="dark"] .bg-red-50 { background: rgba(239,68,68,0.15); }
    [data-theme="dark"] .bg-yellow-50 { background: rgba(234,179,8,0.12); }
    [data-theme="dark"] .bg-orange-50 { background: rgba(249,115,22,0.12); }
    [data-theme="dark"] .bg-gray-50 { background: #1e293b; }
    [data-theme="dark"] .bg-amber-100 { background: rgba(245,158,11,0.15); }
    [data-theme="dark"] .texture-btn { background: #1e293b; border-color: #334155; color: #e2e8f0; }
    [data-theme="dark"] .texture-btn.selected { border-color: #818cf8 !important; background: #312e81 !important; }

    /* ===================== GALAXY DARK THEME OVERRIDES ===================== */
    [data-theme="galaxy"] .text-slate-600 { color: #b39ddb; }
    [data-theme="galaxy"] .text-slate-700 { color: #ce93d8; }
    [data-theme="galaxy"] .text-slate-800, [data-theme="galaxy"] .text-slate-900 { color: #e8d5ff; }
    [data-theme="galaxy"] .text-slate-500 { color: #9e87c7; }
    [data-theme="galaxy"] .text-gray-400, [data-theme="galaxy"] .text-gray-500 { color: #9e87c7; }
    [data-theme="galaxy"] .bg-white { background: #1a0533 !important; }
    [data-theme="galaxy"] .bg-white\/60, [data-theme="galaxy"] .bg-white\/70 { background: rgba(26,5,51,0.7) !important; }
    [data-theme="galaxy"] .bg-gray-50, [data-theme="galaxy"] .bg-gray-100 { background: #0d0221; }
    [data-theme="galaxy"] .bg-gray-200 { background: #2e1065; }
    [data-theme="galaxy"] .border-gray-200 { border-color: rgba(167,89,255,0.2); }
    [data-theme="galaxy"] .border-b { border-color: rgba(167,89,255,0.15); }
    [data-theme="galaxy"] .bg-amber-50, [data-theme="galaxy"] .bg-yellow-50 { background: rgba(167,89,255,0.12); }
    [data-theme="galaxy"] .bg-green-50 { background: rgba(167,89,255,0.1); }
    [data-theme="galaxy"] .bg-red-50 { background: rgba(239,68,68,0.15); }
    [data-theme="galaxy"] textarea, [data-theme="galaxy"] input[type="datetime-local"] {
      background: #0d0221; color: #e8d5ff; border-color: #7c3aed;
    }
    [data-theme="galaxy"] .texture-btn { background: #1a0533; border-color: #5b21b6; color: #e8d5ff; }
    [data-theme="galaxy"] .texture-btn.selected { border-color: #c77dff !important; background: #2e1065 !important; }
    [data-theme="galaxy"] #drawer > div { background: #1a0533; }

    /* ===================== NEON DARK THEME OVERRIDES ===================== */
    [data-theme="neon"] .text-slate-600 { color: #39ff14; }
    [data-theme="neon"] .text-slate-700 { color: #00ff88; }
    [data-theme="neon"] .text-slate-800, [data-theme="neon"] .text-slate-900 { color: #00ff88; }
    [data-theme="neon"] .text-slate-500 { color: rgba(0,255,136,0.7); }
    [data-theme="neon"] .text-gray-400, [data-theme="neon"] .text-gray-500 { color: rgba(0,255,136,0.6); }
    [data-theme="neon"] .text-blue-400, [data-theme="neon"] .text-blue-500 { color: #00e5ff; }
    [data-theme="neon"] .text-emerald-500 { color: #00ff88; }
    [data-theme="neon"] .bg-white { background: #0a001a !important; }
    [data-theme="neon"] .bg-white\/60, [data-theme="neon"] .bg-white\/70 { background: rgba(0,0,0,0.75) !important; }
    [data-theme="neon"] .bg-gray-50, [data-theme="neon"] .bg-gray-100 { background: #001a0a; }
    [data-theme="neon"] .bg-gray-200 { background: #003320; }
    [data-theme="neon"] .border-gray-200 { border-color: rgba(0,255,136,0.2); }
    [data-theme="neon"] .border-b { border-color: rgba(0,255,136,0.15); }
    [data-theme="neon"] .bg-amber-50, [data-theme="neon"] .bg-yellow-50 { background: rgba(0,255,136,0.08); }
    [data-theme="neon"] .bg-green-50 { background: rgba(0,255,136,0.1); }
    [data-theme="neon"] .bg-red-50 { background: rgba(239,68,68,0.12); }
    [data-theme="neon"] textarea, [data-theme="neon"] input[type="datetime-local"] {
      background: #001a0a; color: #00ff88; border-color: #00ff88;
    }
    [data-theme="neon"] .texture-btn { background: #001a0a; border-color: rgba(0,255,136,0.4); color: #00ff88; }
    [data-theme="neon"] .texture-btn.selected { border-color: #00ff88 !important; background: #003320 !important; }
    [data-theme="neon"] #drawer > div { background: #0a001a; }

    /* MEDICAL THEME */
    [data-theme="medical"] body, [data-theme="medical"] { font-family: 'Space Mono', monospace; }
    [data-theme="medical"] h1, [data-theme="medical"] h3, [data-theme="medical"] h4 { letter-spacing: -0.02em; }
    [data-theme="medical"] .poop-btn { box-shadow: 0 14px 0 0 #047857; }

    /* ===================== KAWAII THEME ===================== */
    [data-theme="kawaii"] {
      --bg-from: #fce4ec; --bg-via: #fce4ec; --bg-to: #f3e5f5;
      --header-from: #e91e8c; --header-to: #9c27b0;
      --card-bg: rgba(255,255,255,0.78);
      --card-border: rgba(233,30,140,0.18);
      --text-primary: #4a0030; --text-secondary: #880e4f;
      --nav-bg: rgba(255,240,248,0.97);
      --btn-shadow: #ad1457;
      --accent: #e91e8c;
      --font: 'Fredoka', system-ui, sans-serif;
    }
    [data-theme="kawaii"] .poop-btn { box-shadow: 0 14px 0 0 #ad1457; }
    [data-theme="kawaii"] .texture-btn.selected { border-color: #e91e8c !important; background: #fce4ec !important; }

    /* ===================== FORÃŠT THEME ===================== */
    [data-theme="foret"] {
      --bg-from: #e8f5e9; --bg-via: #f1f8e9; --bg-to: #e0f2f1;
      --header-from: #2e7d32; --header-to: #558b2f;
      --card-bg: rgba(255,255,255,0.78);
      --card-border: rgba(67,160,71,0.2);
      --text-primary: #1b5e20; --text-secondary: #2e7d32;
      --nav-bg: rgba(240,249,240,0.97);
      --btn-shadow: #1b5e20;
      --accent: #43a047;
      --font: 'Fredoka', system-ui, sans-serif;
    }
    [data-theme="foret"] .poop-btn { box-shadow: 0 14px 0 0 #1b5e20; }
    [data-theme="foret"] .texture-btn.selected { border-color: #43a047 !important; background: #e8f5e9 !important; }

    /* ===================== OCÃ‰AN THEME ===================== */
    [data-theme="ocean"] {
      --bg-from: #e0f7fa; --bg-via: #e3f2fd; --bg-to: #e8eaf6;
      --header-from: #0277bd; --header-to: #00838f;
      --card-bg: rgba(255,255,255,0.78);
      --card-border: rgba(2,136,209,0.2);
      --text-primary: #01579b; --text-secondary: #014f8c;
      --nav-bg: rgba(224,247,250,0.97);
      --btn-shadow: #01579b;
      --accent: #0288d1;
      --font: 'Fredoka', system-ui, sans-serif;
    }
    [data-theme="ocean"] .poop-btn { box-shadow: 0 14px 0 0 #01579b; }
    [data-theme="ocean"] .texture-btn.selected { border-color: #0288d1 !important; background: #e0f7fa !important; }

    /* ===================== THÃˆMES ADDITIONNELS ===================== */
    [data-theme="sunset"] {
      --bg-from:#ffd6a5; --bg-via:#ffafcc; --bg-to:#bde0fe;
      --header-from:#ff6b6b; --header-to:#c77dff;
      --card-bg:rgba(255,255,255,0.78); --card-border:rgba(255,107,107,0.2);
      --text-primary:#3d0066; --text-secondary:#7b2d8b;
      --nav-bg:rgba(255,214,165,0.97); --btn-shadow:#c77dff; --accent:#ff6b6b;
      --font:'Fredoka',system-ui,sans-serif;
    }
    [data-theme="sunset"] .poop-btn { box-shadow:0 14px 0 0 #c77dff; }
    [data-theme="sunset"] .texture-btn.selected { border-color:#ff6b6b!important; background:#ffd6a5!important; }

    [data-theme="galaxy"] {
      --bg-from:#0d0221; --bg-via:#1a0533; --bg-to:#0a0e27;
      --header-from:#6a0572; --header-to:#3a0ca3;
      --card-bg:rgba(26,5,51,0.85); --card-border:rgba(167,89,255,0.3);
      --text-primary:#e8d5ff; --text-secondary:#b39ddb;
      --nav-bg:rgba(13,2,33,0.97); --btn-shadow:#6a0572; --accent:#c77dff;
      --font:'Fredoka',system-ui,sans-serif;
    }
    [data-theme="galaxy"] .poop-btn { box-shadow:0 14px 0 0 #6a0572; }
    [data-theme="galaxy"] .texture-btn.selected { border-color:#c77dff!important; background:#1a0533!important; }

    [data-theme="sakura"] {
      --bg-from:#ffb7c5; --bg-via:#ffd1dc; --bg-to:#ffe8ee;
      --header-from:#e91e8c; --header-to:#ff6b9d;
      --card-bg:rgba(255,255,255,0.82); --card-border:rgba(233,30,140,0.15);
      --text-primary:#2d0012; --text-secondary:#6a0032;
      --nav-bg:rgba(255,183,197,0.97); --btn-shadow:#e91e8c; --accent:#e91e8c;
      --font:'Fredoka',system-ui,sans-serif;
    }
    [data-theme="sakura"] .poop-btn { box-shadow:0 14px 0 0 #e91e8c; }
    [data-theme="sakura"] .texture-btn.selected { border-color:#e91e8c!important; background:#ffd1dc!important; }

    [data-theme="mint"] {
      --bg-from:#c8f7c5; --bg-via:#b7f5d8; --bg-to:#a8edea;
      --header-from:#00b894; --header-to:#00cec9;
      --card-bg:rgba(255,255,255,0.82); --card-border:rgba(0,184,148,0.2);
      --text-primary:#003d33; --text-secondary:#00473e;
      --nav-bg:rgba(200,247,197,0.97); --btn-shadow:#007a5e; --accent:#00b894;
      --font:'Fredoka',system-ui,sans-serif;
    }
    [data-theme="mint"] .poop-btn { box-shadow:0 14px 0 0 #007a5e; }
    [data-theme="mint"] .texture-btn.selected { border-color:#00b894!important; background:#b7f5d8!important; }

    [data-theme="lavande"] {
      --bg-from:#e6d9f7; --bg-via:#d4bef0; --bg-to:#ede0ff;
      --header-from:#7c3aed; --header-to:#9d4edd;
      --card-bg:rgba(255,255,255,0.82); --card-border:rgba(124,58,237,0.2);
      --text-primary:#1a0040; --text-secondary:#5b21b6;
      --nav-bg:rgba(230,217,247,0.97); --btn-shadow:#5b21b6; --accent:#7c3aed;
      --font:'Fredoka',system-ui,sans-serif;
    }
    [data-theme="lavande"] .poop-btn { box-shadow:0 14px 0 0 #5b21b6; }
    [data-theme="lavande"] .texture-btn.selected { border-color:#7c3aed!important; background:#e6d9f7!important; }

    [data-theme="rose-gold"] {
      --bg-from:#f9e4e8; --bg-via:#fcd5b5; --bg-to:#f8e4d1;
      --header-from:#c97b6a; --header-to:#e0a87c;
      --card-bg:rgba(255,255,255,0.82); --card-border:rgba(201,123,106,0.2);
      --text-primary:#3d1c14; --text-secondary:#874d37;
      --nav-bg:rgba(249,228,232,0.97); --btn-shadow:#a0523e; --accent:#c97b6a;
      --font:'Fredoka',system-ui,sans-serif;
    }
    [data-theme="rose-gold"] .poop-btn { box-shadow:0 14px 0 0 #a0523e; }
    [data-theme="rose-gold"] .texture-btn.selected { border-color:#c97b6a!important; background:#f9e4e8!important; }

    [data-theme="tropicale"] {
      --bg-from:#b3ffec; --bg-via:#a8edea; --bg-to:#b3e5fc;
      --header-from:#00b8a9; --header-to:#0097a7;
      --card-bg:rgba(255,255,255,0.82); --card-border:rgba(0,184,169,0.2);
      --text-primary:#00231e; --text-secondary:#00352c;
      --nav-bg:rgba(179,255,236,0.97); --btn-shadow:#007c6e; --accent:#00b8a9;
      --font:'Fredoka',system-ui,sans-serif;
    }
    [data-theme="tropicale"] .poop-btn { box-shadow:0 14px 0 0 #007c6e; }
    [data-theme="tropicale"] .texture-btn.selected { border-color:#00b8a9!important; background:#b3ffec!important; }

    [data-theme="nordique"] {
      --bg-from:#dce8f5; --bg-via:#e8eef4; --bg-to:#d6e4f0;
      --header-from:#2c5f8a; --header-to:#3a7bd5;
      --card-bg:rgba(255,255,255,0.85); --card-border:rgba(58,123,213,0.2);
      --text-primary:#0a1628; --text-secondary:#2c5f8a;
      --nav-bg:rgba(220,232,245,0.97); --btn-shadow:#1a3a5c; --accent:#3a7bd5;
      --font:'Space Mono',monospace;
    }
    [data-theme="nordique"] .poop-btn { box-shadow:0 14px 0 0 #1a3a5c; }
    [data-theme="nordique"] .texture-btn.selected { border-color:#3a7bd5!important; background:#dce8f5!important; }

    [data-theme="automne"] {
      --bg-from:#fde8c8; --bg-via:#fad4a0; --bg-to:#f8c47a;
      --header-from:#b45309; --header-to:#c2410c;
      --card-bg:rgba(255,255,255,0.82); --card-border:rgba(180,83,9,0.2);
      --text-primary:#1c0700; --text-secondary:#7c2d12;
      --nav-bg:rgba(253,232,200,0.97); --btn-shadow:#92400e; --accent:#b45309;
      --font:'Fredoka',system-ui,sans-serif;
    }
    [data-theme="automne"] .poop-btn { box-shadow:0 14px 0 0 #92400e; }
    [data-theme="automne"] .texture-btn.selected { border-color:#b45309!important; background:#fde8c8!important; }

    [data-theme="neon"] {
      --bg-from:#000000; --bg-via:#0a001a; --bg-to:#001a0a;
      --header-from:#00ff88; --header-to:#00e5cc;
      --card-bg:rgba(0,0,0,0.75); --card-border:rgba(0,255,136,0.3);
      --text-primary:#00ff88; --text-secondary:#39ff14;
      --nav-bg:rgba(0,0,0,0.97); --btn-shadow:#007a40; --accent:#00ff88;
      --font:'Space Mono',monospace;
    }
    [data-theme="neon"] .poop-btn { box-shadow:0 14px 0 0 #007a40; }
    [data-theme="neon"] .texture-btn.selected { border-color:#00ff88!important; background:#001a0a!important; }

    /* ===================== INSTALL BANNER ===================== */
    #install-banner {
      position: fixed; bottom: max(80px, env(safe-area-inset-bottom,0px) + 80px);
      left: 16px; right: 16px; z-index: 200;
      background: linear-gradient(135deg, #1e293b, #0f172a);
      color: white; padding: 14px 18px; border-radius: 20px;
      box-shadow: 0 8px 32px #0008;
      display: flex; align-items: center; gap: 12px;
      animation: slideUp .3s ease-out;
    }
    #install-banner.hidden { display: none; }
  </style>
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>

  <!-- BanniÃ¨re mise Ã  jour SW -->
  <div id="update-banner" class="hidden fixed top-0 left-0 right-0 z-[100] py-3 text-center text-sm font-bold text-white cursor-pointer"
       style="background:linear-gradient(90deg,#10b981,#059669);box-shadow:0 2px 12px rgba(0,0,0,0.2)">
    ğŸ†• Mise Ã  jour disponible â€” Appuie pour actualiser
  </div>

  <!-- PWA Install Banner (iOS) -->
  <div id="install-banner" class="hidden">
    <span class="text-3xl">ğŸ’©</span>
    <div class="flex-1 text-sm">
      <div class="font-bold">Installer l'app</div>
      <div class="opacity-75 text-xs">Appuie sur <i class="fas fa-share-from-square"></i> puis "Sur l'Ã©cran d'accueil"</div>
    </div>
    <button id="dismiss-banner" class="text-white/60 text-xl px-2">âœ•</button>
  </div>

  <!-- HEADER -->
  <header class="app-header px-4 pt-3 pb-3 text-white shadow-2xl sticky top-0 z-50 rounded-b-[2rem]">
    <div class="max-w-md mx-auto flex items-center gap-3">
      <!-- Logo (crops bottom text, shows character only) -->
      <div style="width:48px;height:48px;overflow:hidden;border-radius:12px;flex-shrink:0;box-shadow:0 2px 12px rgba(0,0,0,0.3)">
        <img src="logo.png" alt="Logo" style="width:76px;height:76px;margin-left:-14px;margin-top:0;display:block;object-fit:none" />
      </div>
      <!-- Titre -->
      <div class="flex-1 min-w-0">
        <h1 class="font-extrabold leading-tight truncate"
            style="font-size:1.05rem;text-shadow:0 2px 12px rgba(0,0,0,0.3);letter-spacing:0.03em">
          Les cacas de ClÃ©mence ğŸ’–
        </h1>
        <div class="flex items-center gap-2 mt-0.5 opacity-55">
          <span class="text-[8px] tracking-[0.18em] uppercase font-medium">Cacaâ€‘Tracker Â· v2.8.0</span>
        </div>
      </div>
      <!-- Boutons -->
      <div class="flex items-center gap-1.5 flex-shrink-0">
        <button id="timer-btn" class="bg-white/20 px-2 py-1 rounded-full text-sm font-bold hover:bg-white/30 transition" title="Chrono de sÃ©ance">
          â±ï¸ <span id="timer-display" class="hidden font-mono text-xs">00:00</span>
        </button>
        <div id="streak-badge" class="bg-red-500 px-2 py-1 rounded-full items-center gap-1 text-sm font-bold" style="display:none">
          <i class="fas fa-fire"></i><span id="streak-val">0</span> j ğŸ”¥
        </div>
        <button id="user-badge" class="bg-white/20 px-2 py-1.5 rounded-full flex items-center gap-1 text-sm font-bold hover:bg-white/30 transition">
          <span id="admin-hero" class="hidden" title="Admin">ğŸ¦¸</span>
          <span id="user-avatar">ğŸ‘¤</span>
          <span id="user-name" class="text-xs max-w-[72px] truncate">Connexion</span>
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-md mx-auto px-4 py-6">

    <!-- ====== DASHBOARD ====== -->
    <section id="dashboard-tab" class="tab-content active">
      <div class="mb-5 text-center">
        <div class="text-sm opacity-70">âœ¨ Mission du jour :</div>
        <div class="font-bold text-lg">Que ClÃ©mence rÃ¨gne sur les statistiques ğŸ’©</div>
      </div>

      <div class="grid grid-cols-2 gap-4 mb-6">
        <div class="card p-5 rounded-[2rem] shadow-xl text-center">
          <div class="text-4xl font-bold mb-1" style="color:var(--accent)" id="today-count">0</div>
          <div class="text-sm" style="color:var(--text-secondary)">Aujourd'hui</div>
        </div>
        <div class="card p-5 rounded-[2rem] shadow-xl text-center">
          <div class="text-4xl font-bold text-emerald-500 mb-1" id="total-count">0</div>
          <div class="text-sm" style="color:var(--text-secondary)">Total</div>
        </div>
      </div>

      <div class="card p-5 rounded-[2rem] shadow mb-4 text-center">
        <div class="text-3xl font-bold text-blue-400 mb-1" id="mass">0.0 kg</div>
        <div class="text-sm" style="color:var(--text-secondary)">âš–ï¸ Tonnage estimÃ©</div>
      </div>

      <!-- Objectif du jour -->
      <div class="card p-4 rounded-[2rem] shadow mb-6">
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center gap-2">
            <span class="text-lg">ğŸ¯</span>
            <span class="font-bold text-sm">Objectif du jour</span>
          </div>
          <div class="flex items-center gap-1">
            <button id="goal-minus" class="w-7 h-7 rounded-full font-bold text-lg flex items-center justify-center"
              style="background:color-mix(in srgb,var(--accent) 15%,transparent);color:var(--accent)">âˆ’</button>
            <span id="goal-value" class="font-bold text-sm w-5 text-center">1</span>
            <button id="goal-plus" class="w-7 h-7 rounded-full font-bold text-lg flex items-center justify-center"
              style="background:color-mix(in srgb,var(--accent) 15%,transparent);color:var(--accent)">+</button>
          </div>
        </div>
        <div class="w-full rounded-full overflow-hidden mb-1" style="height:8px;background:rgba(0,0,0,0.08)">
          <div id="goal-bar" class="h-full rounded-full transition-all duration-500" style="width:0%;background:var(--accent)"></div>
        </div>
        <div id="goal-label" class="text-xs text-center opacity-60">0 / 1 caca aujourd'hui</div>
        <div id="goal-streak" class="hidden text-xs text-center font-bold mt-1" style="color:var(--accent)"></div>
      </div>

      <div class="flex justify-center mb-4">
        <button id="poop-btn" class="poop-btn w-36 h-36 rounded-full text-6xl flex items-center justify-center"
          style="background:linear-gradient(135deg,var(--header-from),var(--header-to))">
          ğŸ’©
        </button>
      </div>

      <!-- Partager mes stats -->
      <div class="flex justify-center mb-6">
        <button id="share-stats-btn" class="py-2 px-5 rounded-full text-sm font-bold"
          style="background:color-mix(in srgb,var(--accent) 12%,transparent);color:var(--accent);border:1.5px solid color-mix(in srgb,var(--accent) 30%,transparent)">
          ğŸ“¤ Partager mes stats
        </button>
      </div>

      <!-- Blague du jour -->
      <div class="card p-4 rounded-[2rem] shadow mb-4">
        <div class="flex items-center gap-2 mb-2">
          <span class="text-2xl">ğŸ¤£</span>
          <h4 class="font-bold text-sm">Blague de merde du jour</h4>
        </div>
        <p id="daily-joke" class="text-sm italic opacity-80 mb-3">â€”</p>
        <button id="random-joke-btn" class="w-full py-2 rounded-[1rem] text-sm font-bold transition"
          style="background:color-mix(in srgb, var(--accent) 15%, transparent);color:var(--accent)">
          ğŸ”„ Autre blague
        </button>
      </div>

      <!-- PrÃ©diction + compte Ã  rebours -->
      <div class="card p-4 rounded-[2rem] shadow mb-4">
        <div class="flex items-center gap-3 mb-2">
          <span class="text-2xl flex-shrink-0">ğŸ”®</span>
          <p id="prediction-text" class="text-sm font-bold" style="color:var(--text-secondary)">Ajoute des cacas pour obtenir une prÃ©dictionâ€¦</p>
        </div>
        <div id="countdown-container" class="items-center gap-2 pt-2 border-t" style="display:none;border-color:rgba(0,0,0,0.06)">
          <span class="text-lg">â±ï¸</span>
          <div>
            <div class="text-xs opacity-60">Compte Ã  rebours</div>
            <div id="countdown-display" class="font-bold text-sm" style="color:var(--accent)">â€”</div>
          </div>
        </div>
      </div>

      <!-- Tendance de santÃ© -->
      <div id="health-trend-banner" class="hidden card p-3 rounded-[2rem] shadow mb-4 text-sm font-bold text-center"></div>

      <!-- Rappel intelligent -->
      <div id="smart-reminder-banner" class="hidden card p-3 rounded-[2rem] shadow mb-4 text-sm font-bold text-center" style="color:var(--accent)"></div>

      <!-- DÃ©fi Streak 7 jours -->
      <div class="card p-4 rounded-[2rem] shadow mb-4">
        <div class="flex items-center gap-2 mb-2">
          <span class="text-xl">ğŸ¯</span>
          <span class="font-bold text-sm flex-1">DÃ©fi : 7 jours de suite !</span>
          <span id="streak-challenge-badge" class="hidden text-xs px-2 py-0.5 rounded-full font-bold" style="background:#fef3c7;color:#b45309">ComplÃ©tÃ© ğŸ†</span>
        </div>
        <div class="flex items-center gap-2 mb-1">
          <div class="flex-1 rounded-full overflow-hidden" style="height:8px;background:rgba(0,0,0,0.08)">
            <div id="streak-challenge-bar" class="h-full rounded-full transition-all duration-700" style="width:0%;background:var(--accent)"></div>
          </div>
          <span id="streak-challenge-label" class="text-xs font-bold opacity-60 w-8 text-right">0/7</span>
        </div>
        <div id="streak-challenge-msg" class="text-xs opacity-60 text-center mt-1"></div>
      </div>

      <!-- Anniversaire de caca -->
      <div id="anniversary-banner" class="hidden card p-4 rounded-[2rem] shadow mb-4 text-center" style="background:linear-gradient(135deg,#7c3aed,#ec4899);color:#fff"></div>

      <!-- RÃ©sumÃ© de la semaine -->
      <div class="card p-4 rounded-[2rem] shadow mb-4">
        <div class="flex items-center gap-2 mb-3">
          <span class="text-xl">ğŸ“Š</span>
          <span class="font-bold text-sm flex-1">RÃ©sumÃ© de la semaine</span>
          <span id="week-trend" class="text-lg"></span>
        </div>
        <div id="week-summary" class="grid grid-cols-3 gap-3 text-center"></div>
      </div>

      <div class="card p-5 rounded-[2rem] shadow">
        <div class="mb-3">
          <h3 class="font-bold text-lg">7 derniers jours</h3>
        </div>
        <div style="height:200px; position:relative;">
          <canvas id="week-chart"></canvas>
          <div id="chart-fallback" class="hidden text-sm text-center py-12 opacity-60">
            Graphique non disponible (Chart.js absent)
          </div>
        </div>
      </div>
    </section>

    <!-- ====== STATS ====== -->
    <section id="stats-tab" class="tab-content">
      <h3 class="font-bold text-2xl mb-1 text-center">ğŸ“Š ClÃ©mence vs le Monde</h3>
      <p class="text-center text-xs opacity-60 mb-6">Ã‰tudes Ã©pidÃ©miologiques digestives 2019-2023</p>

      <!-- FrÃ©quence -->
      <div class="card rounded-[2rem] p-5 mb-4 shadow">
        <h4 class="font-bold mb-1">ğŸ’© FrÃ©quence quotidienne</h4>
        <p class="text-xs opacity-60 mb-4">Moyenne sur tes 7 derniers jours</p>
        <div class="space-y-3">
          <div class="stat-row">
            <span class="text-sm font-bold" style="color:var(--accent)">Toi ğŸ«µ</span>
            <div class="stat-bar"><div id="bar-me" class="stat-fill" style="width:0%;background:var(--accent)"></div></div>
            <span class="text-sm font-bold" id="val-me">0.0/j</span>
          </div>
          <div class="stat-row">
            <span class="text-sm font-bold text-blue-500">ğŸ‡«ğŸ‡· France</span>
            <div class="stat-bar"><div class="stat-fill bg-blue-400" style="width:50%"></div></div>
            <span class="text-sm font-bold text-blue-500">1.1/j</span>
          </div>
          <div class="stat-row">
            <span class="text-sm font-bold text-emerald-500">ğŸŒ Monde</span>
            <div class="stat-bar"><div class="stat-fill bg-emerald-400" style="width:45%"></div></div>
            <span class="text-sm font-bold text-emerald-500">1.0/j</span>
          </div>
        </div>
        <div id="freq-verdict" class="mt-4 text-center text-sm font-bold p-3 rounded-2xl opacity-90">â€”</div>
      </div>

      <!-- Transit -->
      <div class="card rounded-[2rem] p-5 mb-4 shadow">
        <h4 class="font-bold mb-1">â±ï¸ Transit intestinal moyen</h4>
        <p class="text-xs opacity-60 mb-4">Intervalle moyen entre tes cacas</p>
        <div class="space-y-3">
          <div class="stat-row">
            <span class="text-sm font-bold" style="color:var(--accent)">Toi ğŸ«µ</span>
            <div class="stat-bar"><div id="bar-transit-me" class="stat-fill" style="width:0%;background:var(--accent)"></div></div>
            <span class="text-sm font-bold" id="val-transit-me">â€”</span>
          </div>
          <div class="stat-row">
            <span class="text-sm font-bold text-blue-500">ğŸ‡«ğŸ‡· France</span>
            <div class="stat-bar"><div class="stat-fill bg-blue-400" style="width:55%"></div></div>
            <span class="text-sm font-bold text-blue-500">~22h</span>
          </div>
          <div class="stat-row">
            <span class="text-sm font-bold text-emerald-500">ğŸŒ Monde</span>
            <div class="stat-bar"><div class="stat-fill bg-emerald-400" style="width:50%"></div></div>
            <span class="text-sm font-bold text-emerald-500">~24h</span>
          </div>
        </div>
      </div>

      <!-- Textures -->
      <div class="card rounded-[2rem] p-5 mb-4 shadow">
        <h4 class="font-bold mb-3">ğŸ¨ RÃ©partition des textures</h4>
        <div id="texture-stats" class="space-y-2"></div>
        <div class="mt-3 p-3 rounded-2xl text-xs font-bold" style="background:rgba(5,150,105,0.12);color:#059669">
          âœ… IdÃ©al mÃ©dical : 75â€“85% Normal, &lt;5% Liquide/Explosif
        </div>
      </div>

      <!-- Comparaison mensuelle -->
      <div id="month-compare-container" class="mb-4"></div>
      <!-- Score santÃ© -->
      <div id="health-score-container" class="mb-4"></div>

      <!-- Records personnels -->
      <div id="records-container" class="mb-4"></div>

      <!-- Bristol Scale -->
      <div id="bristol-container" class="mb-4"></div>

      <!-- Heatmap calendrier (injectÃ©e par charts.js) -->
      <div id="heatmap-container" class="mb-4"></div>

      <!-- Graphiques avancÃ©s (injectÃ©s par charts.js) -->
      <div id="advanced-charts-container" class="mb-4"></div>

      <!-- Export stats -->
      <button id="export-pdf-btn" class="w-full py-3 rounded-[1.5rem] font-bold mb-3 flex items-center justify-center gap-2 text-sm"
        style="background:color-mix(in srgb,#ef4444 12%,transparent);color:#ef4444;border:1.5px solid color-mix(in srgb,#ef4444 30%,transparent)">
        ğŸ¥ PDF mÃ©dical
      </button>

      <!-- AnnÃ©e en review -->
      <button id="wrapped-btn" class="w-full py-4 rounded-[1.5rem] font-bold text-white shadow mb-4 flex items-center justify-center gap-2"
        style="background:linear-gradient(135deg,#f59e0b,#ec4899)">
        ğŸ¬ Mon annÃ©e en review
      </button>

      <!-- Fun facts -->
      <div class="rounded-[2rem] p-5 text-white shadow" style="background:linear-gradient(135deg,#7c3aed,#db2777)">
        <h4 class="font-bold text-lg mb-3">ğŸŒŸ Le saviez-vous ?</h4>
        <ul class="space-y-2 text-sm list-none">
          <li>ğŸ’© Un FranÃ§ais produit ~<strong>150 g</strong> de selles/jour</li>
          <li>ğŸŒ La moyenne mondiale est de <strong>128 g/jour</strong></li>
          <li>â³ Le transit dure entre <strong>12 et 72h</strong> selon les individus</li>
          <li>ğŸ† Record de rÃ©tention documentÃ© : <strong>28 jours</strong></li>
          <li>ğŸ”¬ L'<strong>Ã‰chelle de Bristol</strong> classe 7 types de selles</li>
        </ul>
      </div>
    </section>

    <!-- ====== BADGES ====== -->
    <section id="badges-tab" class="tab-content">
      <h3 class="font-bold text-2xl mb-6 text-center">ğŸ† Badges de ClÃ©mence</h3>
      <div class="grid grid-cols-2 gap-4" id="badges-grid">
        <!-- injected by JS -->
      </div>
    </section>

    <!-- ====== SOCIAL ====== -->
    <section id="social-tab" class="tab-content">

      <!-- Partager l'application -->
      <div class="card p-4 rounded-[2rem] shadow mb-4">
        <div class="flex items-center gap-2 mb-3">
          <span class="text-xl">ğŸ”—</span>
          <span class="font-bold text-sm">Partager l'application</span>
        </div>
        <button id="share-app-btn" class="w-full py-3 rounded-[1.25rem] font-bold text-sm text-white"
          style="background:linear-gradient(135deg,var(--header-from),var(--header-to))">
          ğŸ“¤ Partager le lien
        </button>
        <div id="share-app-feedback" class="hidden text-xs text-center mt-2 opacity-60"></div>
      </div>

      <!-- Non connectÃ© -->
      <div id="social-guest" class="text-center py-12">
        <div class="text-6xl mb-4">ğŸ‘¥</div>
        <h3 class="font-bold text-xl mb-2">Rejoins tes amies !</h3>
        <p class="text-sm opacity-60 mb-6">CrÃ©e un compte pour comparer tes stats, rejoindre des groupes et te challenger avec tes copines.</p>
        <button id="social-login-btn" class="w-full py-4 rounded-[1.25rem] font-bold text-white"
          style="background:linear-gradient(135deg,var(--header-from),var(--header-to))">
          ğŸ‘¤ Se connecter / CrÃ©er un compte
        </button>
      </div>

      <!-- ConnectÃ© -->
      <div id="social-connected" class="hidden space-y-4">

        <!-- Mes groupes -->
        <div class="card p-5 rounded-[2rem] shadow">
          <div class="flex items-center justify-between mb-3">
            <h4 class="font-bold">ğŸ‘¥ Mes groupes</h4>
            <button id="create-group-btn" class="text-xs font-bold px-3 py-1.5 rounded-full"
              style="background:color-mix(in srgb,var(--accent) 15%,transparent);color:var(--accent)">
              + CrÃ©er
            </button>
          </div>
          <div id="groups-list" class="space-y-2 mb-3">
            <div class="text-sm opacity-60 text-center py-2">Aucun groupe</div>
          </div>
          <div class="flex gap-2">
            <input id="invite-code-input" type="text" placeholder="Code d'invitation (ex: A1B2C3D4)"
              class="flex-1 p-3 border rounded-[1rem] text-sm focus:outline-none focus:ring-2"
              style="border-color:var(--card-border);background:var(--card-bg);color:var(--text-primary)" maxlength="8" />
            <button id="join-group-btn" class="px-4 py-2 rounded-[1rem] font-bold text-white text-sm"
              style="background:linear-gradient(135deg,var(--header-from),var(--header-to))">Rejoindre</button>
          </div>
        </div>

        <!-- Groupe sÃ©lectionnÃ© -->
        <div id="group-content" class="hidden space-y-4">

          <!-- SÃ©lecteur de groupe -->
          <div class="flex items-center gap-2">
            <select id="group-selector" class="flex-1 p-3 rounded-[1rem] text-sm font-bold border focus:outline-none"
              style="border-color:var(--card-border);background:var(--card-bg);color:var(--text-primary)"></select>
            <button id="share-group-btn" class="px-3 py-2 rounded-[1rem] text-sm font-bold flex items-center gap-1"
              style="background:color-mix(in srgb,var(--accent) 15%,transparent);color:var(--accent)">
              ğŸ“· QR
            </button>
            <button id="manage-group-btn" class="p-3 rounded-[1rem]"
              style="background:color-mix(in srgb,var(--accent) 15%,transparent);color:var(--accent)"
              title="GÃ©rer le groupe">
              âš™ï¸
            </button>
          </div>

          <!-- Panel de gestion du groupe (masquÃ© par dÃ©faut) -->
          <div id="group-management" class="hidden card p-4 rounded-[1.5rem]">
            <div class="flex items-center justify-between mb-3">
              <span class="font-bold text-sm">âš™ï¸ Gestion du groupe</span>
              <button id="close-management-btn" class="text-xs opacity-60 px-2 py-1">âœ•</button>
            </div>
            <div id="members-management-list" class="space-y-2 mb-4"></div>
            <div class="space-y-2">
              <button id="leave-group-btn" class="w-full py-3 rounded-[1.25rem] font-bold text-sm text-orange-500"
                style="background:rgba(249,115,22,0.1);border:1.5px solid rgba(249,115,22,0.3)">
                ğŸšª Quitter le groupe
              </button>
              <button id="delete-group-btn" class="hidden w-full py-3 rounded-[1.25rem] font-bold text-sm text-red-500"
                style="background:rgba(239,68,68,0.1);border:1.5px solid rgba(239,68,68,0.3)">
                ğŸ—‘ï¸ Supprimer le groupe
              </button>
            </div>
          </div>

          <!-- Podium -->
          <div class="card p-5 rounded-[2rem] shadow">
            <h4 class="font-bold mb-4 text-center">ğŸ† Podium du mois</h4>
            <div id="podium-container" class="flex items-end justify-center gap-3 mb-4" style="min-height:160px"></div>
            <div id="podium-list" class="space-y-2"></div>
          </div>

          <!-- Comparatif 7 jours -->
          <div class="card p-5 rounded-[2rem] shadow">
            <h4 class="font-bold mb-4">ğŸ“Š Comparatif 7 jours</h4>
            <div id="compare-chart" class="space-y-3"></div>
          </div>

          <!-- DÃ©fi de la semaine -->
          <div id="challenge-card" class="card p-5 rounded-[2rem] shadow">
            <div class="flex items-center justify-between mb-3">
              <h4 class="font-bold">ğŸ¯ DÃ©fi de la semaine</h4>
              <div class="flex items-center gap-2">
                <button id="edit-challenge-btn" class="hidden text-xs font-bold px-2 py-1 rounded-lg"
                  style="background:color-mix(in srgb,var(--accent) 15%,transparent);color:var(--accent)"
                  title="Personnaliser le dÃ©fi">âœï¸ Modifier</button>
                <span id="challenge-countdown" class="text-xs opacity-60"></span>
              </div>
            </div>
            <p id="challenge-title" class="text-sm mb-3 font-bold" style="color:var(--accent)">Qui fera le plus de cacas cette semaine ?</p>
            <div id="challenge-bars" class="space-y-2"></div>
          </div>

          <!-- Feed d'activitÃ© -->
          <div class="card p-5 rounded-[2rem] shadow">
            <div class="flex items-center justify-between mb-3">
              <h4 class="font-bold">ğŸ“£ ActivitÃ©</h4>
              <select id="feed-member-filter" class="text-xs border rounded-xl px-2 py-1 focus:outline-none"
                style="background:var(--card-bg);color:var(--text-primary);border-color:var(--card-border)">
                <option value="">Tous</option>
              </select>
            </div>
            <div class="flex gap-1 mb-3 flex-wrap">
              <button class="feed-tab-btn text-xs font-bold px-3 py-1.5 rounded-full transition" data-period="today">Aujourd'hui</button>
              <button class="feed-tab-btn text-xs font-bold px-3 py-1.5 rounded-full transition" data-period="week">Semaine</button>
              <button class="feed-tab-btn text-xs font-bold px-3 py-1.5 rounded-full transition" data-period="month">Mois</button>
              <button class="feed-tab-btn text-xs font-bold px-3 py-1.5 rounded-full transition" data-period="year">AnnÃ©e</button>
            </div>
            <div id="activity-feed" class="space-y-2">
              <div class="text-sm opacity-60 text-center py-2">Aucune activitÃ© rÃ©cente</div>
            </div>
          </div>

        </div>
      </div>
    </section>

    <!-- ====== HISTORIQUE ====== -->
    <section id="admin-tab" class="tab-content">
      <h3 class="font-bold text-xl mb-4">ğŸ“œ Historique</h3>
      <div id="history-list" class="space-y-3" style="max-height:72vh;overflow-y:auto;"></div>
    </section>

    <!-- ====== PARAMÃˆTRES ====== -->
    <section id="settings-tab" class="tab-content">
      <h3 class="font-bold text-xl mb-5">âš™ï¸ ParamÃ¨tres</h3>

      <!-- ğŸ”Š Sons -->
      <div class="card p-4 rounded-[1.5rem] mb-4">
        <div class="font-bold mb-3 text-sm">ğŸ”Š Sons</div>
        <div id="sound-settings"></div>
      </div>

      <!-- ğŸ”” Notifications -->
      <div class="card p-4 rounded-[1.5rem] mb-4">
        <div class="font-bold mb-3 text-sm">ğŸ”” Notifications</div>

        <!-- Rappel automatique -->
        <div class="flex items-center justify-between mb-3 text-sm">
          <span>Activer les rappels</span>
          <label class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" id="notif-toggle" class="sr-only peer" />
            <div class="w-10 h-5 rounded-full bg-gray-200 peer-checked:bg-amber-400 transition-colors"></div>
            <div class="absolute left-0.5 top-0.5 w-4 h-4 bg-white rounded-full shadow transition-transform peer-checked:translate-x-5"></div>
          </label>
        </div>
        <div class="flex items-center justify-between mb-3 text-sm">
          <span class="opacity-80">Si pas de caca depuis</span>
          <select id="notif-threshold" class="border rounded-lg px-2 py-1 text-sm" style="background:var(--card-bg);color:var(--text-primary);border-color:rgba(0,0,0,0.15)">
            <option value="12">12h</option>
            <option value="24" selected>24h</option>
            <option value="36">36h</option>
            <option value="48">48h</option>
          </select>
        </div>

        <!-- Rappel Ã  heure fixe -->
        <div class="flex items-center justify-between mb-3 text-sm pt-3 border-t" style="border-color:rgba(0,0,0,0.07)">
          <div>
            <div class="font-medium">â° Ã€ heure fixe</div>
            <div class="text-xs opacity-60">Si pas de caca Ã  cette heure</div>
          </div>
          <div class="flex items-center gap-2">
            <input type="time" id="custom-reminder-time" value="20:00"
              class="border rounded-lg px-2 py-1 text-sm"
              style="background:var(--card-bg);color:var(--text-primary);border-color:rgba(0,0,0,0.15)" />
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" id="custom-reminder-enabled" class="sr-only peer" />
              <div class="w-10 h-5 rounded-full bg-gray-200 peer-checked:bg-indigo-500 transition-colors"></div>
              <div class="absolute left-0.5 top-0.5 w-4 h-4 bg-white rounded-full shadow transition-transform peer-checked:translate-x-5"></div>
            </label>
          </div>
        </div>

        <button id="notif-permission-btn" class="w-full py-2 text-sm rounded-[1rem] font-bold mb-2"
          style="background:color-mix(in srgb,var(--accent) 15%,transparent);color:var(--accent);border:1.5px solid var(--accent)">
          ğŸ”” Autoriser les notifications navigateur
        </button>
        <div id="notif-status" class="text-xs opacity-60 text-center"></div>
      </div>

      <!-- ğŸ“¤ Export -->
      <div class="card p-4 rounded-[1.5rem] mb-4">
        <div class="font-bold mb-3 text-sm">ğŸ“¤ Export</div>
        <button id="export-ical-btn" class="w-full py-3 rounded-[1.25rem] font-bold text-sm flex items-center justify-center gap-2"
          style="background:color-mix(in srgb,var(--accent) 15%,transparent);color:var(--accent)">
          ğŸ“… Calendrier iCal (.ics)
        </button>
        <div class="text-xs opacity-50 text-center mt-2">Compatible iPhone Calendrier, Google Calendarâ€¦</div>
      </div>

      <!-- ğŸ“Œ Bandeau titre persistant -->
      <div class="card p-4 rounded-[1.5rem] mb-4">
        <div class="font-bold mb-3 text-sm">ğŸ“Œ Affichage</div>
        <div class="flex items-center justify-between text-sm">
          <div>
            <div class="font-medium">Header toujours visible</div>
            <div class="text-xs opacity-60">DÃ©sactivÃ© = le titre dÃ©file avec la page</div>
          </div>
          <button id="sticky-header-toggle" onclick="toggleStickyHeader()"
            class="relative w-11 h-6 rounded-full transition-colors duration-300 focus:outline-none"
            style="background:#4f46e5" aria-label="Sticky header">
            <span id="sticky-header-knob"
              class="absolute top-[2px] left-[2px] w-5 h-5 bg-white rounded-full shadow transition-transform duration-300"
              style="transform:translateX(20px)"></span>
          </button>
        </div>
      </div>

      <!-- ğŸ“– Guide des fonctionnalitÃ©s -->
      <div class="card p-4 rounded-[1.5rem] mb-4">
        <div class="font-bold mb-4 text-sm flex items-center gap-2">ğŸ“– Guide des fonctionnalitÃ©s</div>

        <!-- Accueil -->
        <details class="mb-2 rounded-[1.25rem] overflow-hidden" style="background:color-mix(in srgb,var(--accent) 6%,transparent)">
          <summary class="px-4 py-3 cursor-pointer font-bold text-sm flex items-center gap-2 select-none">
            ğŸ  Accueil
          </summary>
          <div class="px-4 pb-4 space-y-2 text-sm opacity-80 leading-relaxed">
            <p><strong>ğŸ’© Bouton central</strong> â€” Enregistre un caca maintenant. Tu peux choisir la texture, la couleur et ajouter un commentaire.</p>
            <p><strong>ğŸ¯ Objectif du jour</strong> â€” Fixe le nombre de cacas souhaitÃ©s dans la journÃ©e. La barre se remplit au fil des enregistrements.</p>
            <p><strong>ğŸ”® PrÃ©diction</strong> â€” Calcule automatiquement ton prochain caca estimÃ© en fonction de l'intervalle moyen de tes 7 derniers jours.</p>
            <p><strong>â° Rappel intelligent</strong> â€” Si l'heure Ã  laquelle tu cacas habituellement est passÃ©e et qu'aucun caca n'est enregistrÃ© aujourd'hui, un message d'alerte s'affiche.</p>
            <p><strong>ğŸ¯ DÃ©fi 7 jours</strong> â€” Barre de progression vers un streak de 7 jours consÃ©cutifs.</p>
            <p><strong>ğŸ“Š RÃ©sumÃ© de la semaine</strong> â€” Comparatif cette semaine vs semaine derniÃ¨re + meilleur jour.</p>
            <p><strong>ğŸ¤£ Blague du jour</strong> â€” Une blague de caca diffÃ©rente chaque jour. Bouton ğŸ”„ pour en tirer une au hasard.</p>
            <p><strong>ğŸ“ˆ Graphique 7 jours</strong> â€” Visualise tes cacas jour par jour sur la semaine en cours.</p>
            <p><strong>ğŸ“¤ Partager mes stats</strong> â€” GÃ©nÃ¨re une image de tes statistiques Ã  partager sur Instagram, WhatsAppâ€¦</p>
            <p><strong>â±ï¸ Chrono</strong> â€” DÃ©marre un minuteur pour mesurer la durÃ©e de ta sÃ©ance aux toilettes.</p>
          </div>
        </details>

        <!-- Stats -->
        <details class="mb-2 rounded-[1.25rem] overflow-hidden" style="background:color-mix(in srgb,var(--accent) 6%,transparent)">
          <summary class="px-4 py-3 cursor-pointer font-bold text-sm flex items-center gap-2 select-none">
            ğŸ“Š Stats
          </summary>
          <div class="px-4 pb-4 space-y-2 text-sm opacity-80 leading-relaxed">
            <p><strong>ğŸ“Š ClÃ©mence vs le Monde</strong> â€” Compare ta frÃ©quence aux moyennes franÃ§aises et mondiales (1â€“2 fois/jour).</p>
            <p><strong>â±ï¸ Transit intestinal</strong> â€” Calcule le temps moyen entre tes cacas.</p>
            <p><strong>ğŸ¨ RÃ©partition des textures</strong> â€” Graphique en barres de tes textures les plus frÃ©quentes (normal, dur, mou, sprayâ€¦).</p>
            <p><strong>ğŸ“… 3 colonnes mensuelles</strong> â€” Comparatif mois dernier / ce mois-ci / mÃªme mois l'an dernier.</p>
            <p><strong>ğŸ¥ Score de santÃ© intestinale</strong> â€” Score calculÃ© sur la rÃ©gularitÃ©, la texture et la frÃ©quence.</p>
            <p><strong>ğŸ† Records personnels</strong> â€” Meilleur streak, meilleur jour, meilleure semaine, meilleur mois.</p>
            <p><strong>ğŸ”¬ Ã‰chelle de Bristol</strong> â€” RÃ©partition de tes cacas sur les 7 niveaux de l'Ã©chelle mÃ©dicale de Bristol.</p>
            <p><strong>ğŸ“… Carte thermique annuelle</strong> â€” Vue d'ensemble de l'annÃ©e entiÃ¨re : chaque case = un jour, plus c'est foncÃ©, plus tu as cacÃ©.</p>
            <p><strong>ğŸ¥ PDF mÃ©dical</strong> â€” GÃ©nÃ¨re un rapport imprimable avec toutes tes stats pour ton mÃ©decin.</p>
          </div>
        </details>

        <!-- Badges -->
        <details class="mb-2 rounded-[1.25rem] overflow-hidden" style="background:color-mix(in srgb,var(--accent) 6%,transparent)">
          <summary class="px-4 py-3 cursor-pointer font-bold text-sm flex items-center gap-2 select-none">
            ğŸ… Badges
          </summary>
          <div class="px-4 pb-4 space-y-2 text-sm opacity-80 leading-relaxed">
            <p><strong>58 badges Ã  dÃ©bloquer</strong> â€” RÃ©compenses basÃ©es sur la frÃ©quence, les streaks, les textures, les heures, les recordsâ€¦</p>
            <p>Chaque badge a 3 niveaux : Bronze ğŸ¥‰, Argent ğŸ¥ˆ, Or ğŸ¥‡.</p>
            <p>Les badges dÃ©bloquÃ©s apparaissent en couleur, les autres sont grisÃ©s avec leur condition affichÃ©e.</p>
          </div>
        </details>

        <!-- Historique -->
        <details class="mb-2 rounded-[1.25rem] overflow-hidden" style="background:color-mix(in srgb,var(--accent) 6%,transparent)">
          <summary class="px-4 py-3 cursor-pointer font-bold text-sm flex items-center gap-2 select-none">
            ğŸ“œ Historique
          </summary>
          <div class="px-4 pb-4 space-y-2 text-sm opacity-80 leading-relaxed">
            <p><strong>Liste des 20 derniers cacas</strong> â€” Date, texture, couleur, humeur et commentaire.</p>
            <p><strong>âª Date rÃ©troactive</strong> â€” Lors de l'enregistrement, tu peux indiquer une heure passÃ©e si tu as oubliÃ© de noter.</p>
            <p><strong>ğŸ—‘ï¸ Supprimer</strong> â€” Bouton poubelle pour effacer une entrÃ©e. Si tu es connectÃ©e, la suppression se synchronise dans le cloud.</p>
          </div>
        </details>

        <!-- Social -->
        <details class="mb-2 rounded-[1.25rem] overflow-hidden" style="background:color-mix(in srgb,var(--accent) 6%,transparent)">
          <summary class="px-4 py-3 cursor-pointer font-bold text-sm flex items-center gap-2 select-none">
            ğŸ‘¥ Social
          </summary>
          <div class="px-4 pb-4 space-y-2 text-sm opacity-80 leading-relaxed">
            <p><strong>ğŸ‘¤ Connexion / Inscription</strong> â€” CrÃ©e un compte avec email + mot de passe pour accÃ©der aux fonctions sociales.</p>
            <p><strong>ğŸ‘¥ Groupes</strong> â€” CrÃ©e un groupe ou rejoins-en un avec un code d'invitation (8 lettres). Tu peux aussi scanner un QR code.</p>
            <p><strong>ğŸ† Podium du mois</strong> â€” Classe les membres du groupe par nombre de cacas ce mois-ci.</p>
            <p><strong>ğŸ“Š Comparatif 7 jours</strong> â€” Barres cÃ´te Ã  cÃ´te pour comparer chaque membre sur les 7 derniers jours.</p>
            <p><strong>ğŸ“£ Fil d'activitÃ©</strong> â€” Les 200 derniÃ¨res activitÃ©s du groupe avec filtres (Aujourd'hui / Semaine / Mois / AnnÃ©e) et rÃ©actions emoji.</p>
            <p><strong>ğŸ¯ DÃ©fi hebdomadaire</strong> â€” Challenge automatique chaque semaine. Le crÃ©ateur du groupe peut personnaliser le titre.</p>
            <p><strong>ğŸ”— Partager le lien</strong> â€” Copie le lien de l'app pour l'envoyer par SMS, WhatsApp, mailâ€¦</p>
            <p><strong>â˜ï¸ Sync cloud</strong> â€” Toutes tes donnÃ©es sont synchronisÃ©es dans le cloud. Si tu changes de tÃ©lÃ©phone, reconnecte-toi et tout rÃ©apparaÃ®t.</p>
          </div>
        </details>

        <!-- RÃ©glages -->
        <details class="rounded-[1.25rem] overflow-hidden" style="background:color-mix(in srgb,var(--accent) 6%,transparent)">
          <summary class="px-4 py-3 cursor-pointer font-bold text-sm flex items-center gap-2 select-none">
            âš™ï¸ RÃ©glages
          </summary>
          <div class="px-4 pb-4 space-y-2 text-sm opacity-80 leading-relaxed">
            <p><strong>ğŸ”Š Sons</strong> â€” Active/dÃ©sactive les bruitages et rÃ¨gle le volume.</p>
            <p><strong>ğŸ”” Rappel automatique</strong> â€” ReÃ§ois une notification si tu n'as pas cacÃ© depuis X heures (12h, 24h, 36h ou 48h).</p>
            <p><strong>â° Rappel Ã  heure fixe</strong> â€” Notif quotidienne Ã  une heure choisie si aucun caca ce jour-lÃ .</p>
            <p><strong>ğŸ“… Export iCal</strong> â€” TÃ©lÃ©charge un fichier .ics avec tous tes cacas comme Ã©vÃ©nements de calendrier (compatible iPhone, Google Calendar).</p>
            <p><strong>ğŸ¨ ThÃ¨me</strong> â€” 16 thÃ¨mes disponibles dans ton profil (clic sur ton avatar en haut). Dont ğŸŒ™ mode nuit automatique de 22h Ã  7h.</p>
            <p><strong>ğŸ–¼ï¸ Avatar</strong> â€” 30 emojis disponibles comme photo de profil.</p>
            <p><strong>ğŸ“¤ Export JSON</strong> â€” Sauvegarde toutes tes donnÃ©es dans un fichier. Utile pour faire une copie de sauvegarde.</p>
            <p><strong>ğŸ“¥ Import JSON</strong> â€” Restaure des donnÃ©es depuis un fichier exportÃ© prÃ©cÃ©demment.</p>
          </div>
        </details>
      </div>

      <!-- â„¹ï¸ Ã€ propos -->
      <div class="card p-4 rounded-[1.5rem] text-xs text-center opacity-50 space-y-1">
        <div>ğŸ’© Les cacas de ClÃ©mence</div>
        <div>Version 2.8.0 â€” FÃ©vrier 2026</div>
        <div>Fait avec â¤ï¸ par Papa</div>
      </div>
    </section>

  </main>

  <!-- NAV BOTTOM -->
  <nav class="bottom-nav fixed bottom-0 left-0 right-0 p-2 z-40">
    <div class="max-w-md mx-auto flex justify-around">
      <button class="tab-btn active py-2 px-1.5 flex flex-col items-center gap-0.5" data-tab="dashboard">
        <i class="fas fa-home text-lg"></i><span class="text-[10px]">Accueil</span>
      </button>
      <button class="tab-btn py-2 px-1.5 flex flex-col items-center gap-0.5" data-tab="stats">
        <i class="fas fa-chart-bar text-lg"></i><span class="text-[10px]">Stats</span>
      </button>
      <button class="tab-btn py-2 px-1.5 flex flex-col items-center gap-0.5" data-tab="badges">
        <i class="fas fa-trophy text-lg"></i><span class="text-[10px]">Badges</span>
      </button>
      <button class="tab-btn py-2 px-1.5 flex flex-col items-center gap-0.5" data-tab="admin">
        <i class="fas fa-list text-lg"></i><span class="text-[10px]">Historique</span>
      </button>
      <button class="tab-btn py-2 px-1.5 flex flex-col items-center gap-0.5" data-tab="social">
        <i class="fas fa-users text-lg"></i><span class="text-[10px]">Social</span>
      </button>
      <button class="tab-btn py-2 px-1.5 flex flex-col items-center gap-0.5" data-tab="settings">
        <i class="fas fa-cog text-lg"></i><span class="text-[10px]">RÃ©glages</span>
      </button>
    </div>
  </nav>

  <!-- AUTH MODAL -->
  <div id="auth-modal" class="fixed inset-0 z-[60] hidden" style="background:rgba(0,0,0,0.7);backdrop-filter:blur(8px);">
    <div class="flex items-center justify-center h-full p-4">
      <div id="auth-inner" class="bg-white w-full max-w-sm rounded-[2rem] shadow-2xl overflow-hidden">

        <!-- Tabs -->
        <div class="flex border-b border-gray-100">
          <button id="auth-tab-login" class="flex-1 py-4 text-sm font-bold border-b-2 transition" style="border-color:var(--accent);color:var(--accent)">
            Connexion
          </button>
          <button id="auth-tab-signup" class="flex-1 py-4 text-sm font-bold border-b-2 border-transparent opacity-60 transition">
            CrÃ©er un compte
          </button>
        </div>

        <div class="p-6 space-y-4">

          <!-- LOGIN FORM -->
          <div id="form-login" class="space-y-3">
            <input id="auth-email" type="email" placeholder="Email" autocomplete="email"
              class="w-full p-3 border border-gray-200 rounded-[1rem] text-sm focus:outline-none focus:ring-2 focus:ring-amber-400" />
            <input id="auth-password" type="password" placeholder="Mot de passe" autocomplete="current-password"
              class="w-full p-3 border border-gray-200 rounded-[1rem] text-sm focus:outline-none focus:ring-2 focus:ring-amber-400" />
            <div id="auth-error" class="hidden text-xs text-red-500 font-bold px-1"></div>
            <div class="text-right -mt-1">
              <button id="forgot-password-btn" type="button" class="text-xs opacity-50 hover:opacity-100 underline">Mot de passe oubliÃ© ?</button>
            </div>
            <button id="auth-submit" class="w-full py-4 rounded-[1.25rem] font-bold text-white"
              style="background:linear-gradient(135deg,var(--header-from),var(--header-to))">
              Se connecter
            </button>
          </div>

          <!-- SIGNUP FORM (hidden by default) -->
          <div id="form-signup" class="space-y-3 hidden">
            <input id="signup-username" type="text" placeholder="Pseudo (ex: ClÃ©mence)" maxlength="20"
              class="w-full p-3 border border-gray-200 rounded-[1rem] text-sm focus:outline-none focus:ring-2 focus:ring-amber-400" />
            <input id="signup-email" type="email" placeholder="Email" autocomplete="email"
              class="w-full p-3 border border-gray-200 rounded-[1rem] text-sm focus:outline-none focus:ring-2 focus:ring-amber-400" />
            <input id="signup-password" type="password" placeholder="Mot de passe (min. 6 caractÃ¨res)"
              class="w-full p-3 border border-gray-200 rounded-[1rem] text-sm focus:outline-none focus:ring-2 focus:ring-amber-400" />
            <div>
              <div class="text-xs font-bold mb-2 opacity-70">Avatar</div>
              <div id="avatar-picker" class="flex gap-2 flex-wrap">
                <button class="avatar-opt text-2xl p-2 rounded-xl border-2 border-transparent hover:border-amber-400 selected" data-avatar="ğŸ’©">ğŸ’©</button>
                <button class="avatar-opt text-2xl p-2 rounded-xl border-2 border-transparent hover:border-amber-400" data-avatar="ğŸ¦„">ğŸ¦„</button>
                <button class="avatar-opt text-2xl p-2 rounded-xl border-2 border-transparent hover:border-amber-400" data-avatar="ğŸŒ¸">ğŸŒ¸</button>
                <button class="avatar-opt text-2xl p-2 rounded-xl border-2 border-transparent hover:border-amber-400" data-avatar="ğŸ”¥">ğŸ”¥</button>
                <button class="avatar-opt text-2xl p-2 rounded-xl border-2 border-transparent hover:border-amber-400" data-avatar="â­">â­</button>
                <button class="avatar-opt text-2xl p-2 rounded-xl border-2 border-transparent hover:border-amber-400" data-avatar="ğŸ€">ğŸ€</button>
              </div>
            </div>
            <div id="signup-error" class="hidden text-xs text-red-500 font-bold px-1"></div>
            <button id="signup-submit" class="w-full py-4 rounded-[1.25rem] font-bold text-white"
              style="background:linear-gradient(135deg,var(--header-from),var(--header-to))">
              CrÃ©er mon compte
            </button>
          </div>

          <button id="auth-guest-btn" class="w-full py-3 text-sm opacity-60 font-bold">
            Continuer sans compte â†’
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- PROFILE MODAL -->
  <div id="profile-modal" class="fixed inset-0 z-[60] hidden" style="background:rgba(0,0,0,0.7);backdrop-filter:blur(8px);">
    <div class="flex items-center justify-center h-full p-4">
      <div class="bg-white w-full max-w-sm rounded-[2rem] shadow-2xl p-6 space-y-4 overflow-y-auto" style="max-height:90vh">
        <div class="text-center">
          <div id="profile-avatar-display" class="text-5xl mb-2">ğŸ’©</div>
          <div id="profile-username-display" class="font-bold text-xl"></div>
          <div id="profile-email-display" class="text-xs opacity-60 mt-1"></div>
        </div>
        <div class="p-3 rounded-2xl text-sm text-center" style="background:color-mix(in srgb,var(--accent) 10%,transparent)">
          <span id="profile-stats-display"></span>
        </div>

        <!-- Photo de profil -->
        <div class="rounded-[1.5rem] p-4 space-y-2" style="background:color-mix(in srgb,var(--accent) 5%,transparent);border:1.5px solid color-mix(in srgb,var(--accent) 15%,transparent)">
          <div class="font-bold text-sm opacity-70">ğŸ–¼ï¸ Photo de profil</div>
          <div id="avatar-picker-grid" class="grid grid-cols-6 gap-1.5 text-2xl text-center"></div>
        </div>

        <!-- ThÃ¨me -->
        <div class="rounded-[1.5rem] p-4 space-y-3" style="background:color-mix(in srgb,var(--accent) 5%,transparent);border:1.5px solid color-mix(in srgb,var(--accent) 15%,transparent)">
          <div class="font-bold text-sm opacity-70">ğŸ¨ ThÃ¨me</div>
          <div id="profile-theme-grid" class="grid grid-cols-4 gap-2"></div>
          <!-- Toggle mode nuit auto -->
          <div class="flex items-center justify-between pt-2 border-t" style="border-color:color-mix(in srgb,var(--accent) 15%,transparent)">
            <div>
              <div class="text-sm font-bold">ğŸŒ™ Mode nuit auto</div>
              <div class="text-xs opacity-60">ThÃ¨me sombre de 22h Ã  7h</div>
            </div>
            <button id="auto-night-toggle" onclick="toggleAutoNight()"
              class="relative w-11 h-6 rounded-full transition-colors duration-300 focus:outline-none"
              style="background:rgba(0,0,0,0.15)" aria-label="Mode nuit auto">
              <span id="auto-night-knob"
                class="absolute top-[2px] left-[2px] w-5 h-5 bg-white rounded-full shadow transition-transform duration-300"></span>
            </button>
          </div>
        </div>

        <!-- Sync cloud -->
        <button id="sync-cloud-btn" class="w-full py-3 rounded-[1.25rem] font-bold text-sm"
          style="background:color-mix(in srgb,var(--accent) 15%,transparent);color:var(--accent)">
          â˜ï¸ Synchroniser mes donnÃ©es
        </button>
        <div id="sync-error-msg" class="hidden text-xs text-red-500 text-center -mt-2 px-2"></div>

        <!-- Gestion des donnÃ©es -->
        <div class="rounded-[1.5rem] p-4 space-y-3" style="background:color-mix(in srgb,var(--accent) 5%,transparent);border:1.5px solid color-mix(in srgb,var(--accent) 15%,transparent)">
          <div class="font-bold text-sm opacity-70">ğŸ—‚ï¸ Gestion des donnÃ©es</div>
          <button id="export-btn" class="w-full bg-blue-500 text-white py-2.5 rounded-[1rem] font-bold text-sm">ğŸ“¤ Exporter JSON</button>
          <label class="w-full bg-green-500 text-white py-2.5 rounded-[1rem] font-bold text-sm cursor-pointer flex items-center justify-center gap-2">
            ğŸ“¥ Importer JSON
            <input type="file" id="import-input" accept=".json" class="hidden" />
          </label>
          <button id="clear-btn" class="w-full bg-red-500 text-white py-2.5 rounded-[1rem] font-bold text-sm">ğŸ—‘ï¸ Tout supprimer</button>
        </div>

        <a id="admin-link" href="admin.html"
           class="hidden w-full py-3 rounded-[1.25rem] font-bold text-sm text-center block"
           style="background:color-mix(in srgb,#7c3aed 12%,transparent);color:#7c3aed">
          âš™ï¸ Administration
        </a>
        <button id="profile-login-btn" class="hidden w-full py-3 rounded-[1.25rem] font-bold text-sm text-white"
          style="background:linear-gradient(135deg,var(--header-from),var(--header-to))">
          ğŸ‘¤ Se connecter / CrÃ©er un compte
        </button>
        <button id="signout-btn" class="hidden w-full py-3 rounded-[1.25rem] font-bold text-sm bg-red-50 text-red-500">
          ğŸšª Se dÃ©connecter
        </button>
        <button id="close-profile-modal" class="w-full py-2 text-sm opacity-50">Fermer</button>
      </div>
    </div>
  </div>

  <!-- QR CODE MODAL -->
  <div id="qr-modal" class="fixed inset-0 z-[80] hidden" style="background:rgba(0,0,0,0.85);backdrop-filter:blur(8px)">
    <div class="flex items-center justify-center h-full p-4">
      <div class="bg-white rounded-[2rem] p-6 w-full max-w-xs text-center space-y-4">
        <h3 class="font-bold text-xl">ğŸ“· QR Code du groupe</h3>
        <div id="qr-group-name" class="text-sm opacity-60"></div>
        <canvas id="qr-canvas" class="mx-auto rounded-2xl border-4 border-gray-100"></canvas>
        <div class="font-mono text-xl font-bold tracking-widest px-4 py-2 rounded-2xl bg-gray-50" id="qr-code-text"></div>
        <p class="text-xs opacity-50">Tes amies scannent le QR code ou saisissent le code pour rejoindre</p>
        <button id="close-qr-modal" class="w-full py-3 rounded-[1.25rem] font-bold text-sm" style="background:color-mix(in srgb,var(--accent) 15%,transparent);color:var(--accent)">Fermer</button>
      </div>
    </div>
  </div>

  <!-- TIMER OVERLAY (flottant) -->
  <div id="timer-overlay" class="hidden fixed bottom-24 left-1/2 z-[60]" style="transform:translateX(-50%)">
    <div class="flex items-center gap-3 px-5 py-3 rounded-[2rem] shadow-2xl text-white font-bold"
         style="background:linear-gradient(135deg,#7c3aed,#ec4899)">
      <span class="text-2xl">â±ï¸</span>
      <div>
        <div class="text-xs opacity-80">SÃ©ance en cours</div>
        <div id="timer-overlay-display" class="text-2xl font-mono">00:00</div>
      </div>
      <button id="timer-stop-btn" class="ml-2 bg-white/20 px-3 py-2 rounded-[1rem] text-sm">
        âœ… TerminÃ©
      </button>
    </div>
  </div>

  <!-- MODAL DÃ‰TAIL DU JOUR (clic heatmap) -->
  <div id="day-detail-modal" class="fixed inset-0 z-[75] hidden" style="background:rgba(0,0,0,0.85);backdrop-filter:blur(8px);">
    <div class="flex flex-col h-full p-4 max-w-sm mx-auto">
      <div class="flex items-center justify-between mb-4 pt-2">
        <h2 id="day-detail-title" class="font-bold text-xl text-white">ğŸ“…</h2>
        <button id="close-day-detail-btn" class="text-white opacity-60 text-2xl">âœ•</button>
      </div>
      <div id="day-detail-content" class="flex-1 overflow-y-auto space-y-2 pb-4"></div>
    </div>
  </div>

  <!-- MODAL ANNÃ‰E EN REVIEW ğŸ¬ -->
  <div id="wrapped-modal" class="fixed inset-0 z-[70] hidden" style="background:rgba(0,0,0,0.9);backdrop-filter:blur(8px);">
    <div class="flex flex-col h-full p-4 max-w-sm mx-auto">
      <div class="flex items-center justify-between mb-4 pt-2">
        <h2 class="font-bold text-xl text-white">ğŸ¬ Mon annÃ©e en review</h2>
        <button id="close-wrapped-btn" class="text-white opacity-60 text-2xl">âœ•</button>
      </div>
      <div id="wrapped-content" class="flex-1 overflow-y-auto space-y-3 pb-4"></div>
    </div>
  </div>

  <!-- CANVAS PARTAGE STATS (invisible) -->
  <canvas id="share-canvas" class="hidden" width="600" height="340"></canvas>

  <!-- NOUVEAU MOT DE PASSE MODAL (retour du lien de reset) -->
  <div id="new-password-modal" class="fixed inset-0 z-[70] hidden" style="background:rgba(0,0,0,0.85);backdrop-filter:blur(8px);">
    <div class="flex items-center justify-center h-full p-4">
      <div class="bg-white w-full max-w-sm rounded-[2rem] shadow-2xl p-6 space-y-4">
        <div class="text-center">
          <div class="text-5xl mb-2">ğŸ”</div>
          <h2 class="font-bold text-xl">Nouveau mot de passe</h2>
          <p class="text-xs opacity-60 mt-1">Choisis ton nouveau mot de passe</p>
        </div>
        <input id="new-password-input" type="password" placeholder="Nouveau mot de passe (min. 6 caractÃ¨res)"
          class="w-full p-3 border border-gray-200 rounded-[1rem] text-sm focus:outline-none focus:ring-2 focus:ring-amber-400" />
        <input id="new-password-confirm" type="password" placeholder="Confirmer le mot de passe"
          class="w-full p-3 border border-gray-200 rounded-[1rem] text-sm focus:outline-none focus:ring-2 focus:ring-amber-400" />
        <div id="new-password-error" class="hidden text-xs text-red-500 font-bold px-1"></div>
        <button id="new-password-submit" class="w-full py-4 rounded-[1.25rem] font-bold text-white"
          style="background:linear-gradient(135deg,var(--header-from),var(--header-to))">
          Enregistrer le mot de passe
        </button>
      </div>
    </div>
  </div>

  <!-- DRAWER -->
  <div id="drawer" class="fixed inset-0 z-50 hidden" style="background:rgba(0,0,0,0.6);backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);">
    <div class="flex items-end justify-center h-full" id="drawer-outer">
      <div class="drawer-inner bg-white w-full max-w-md rounded-t-[2.5rem] shadow-2xl" id="drawer-inner">

        <!-- Handle -->
        <div class="flex justify-center pt-4 pb-2">
          <div class="w-12 h-1.5 rounded-full bg-gray-200"></div>
        </div>

        <div class="px-6 pb-3 border-b border-gray-100">
          <h2 class="text-2xl font-bold text-center text-slate-900">Nouveau ğŸ’©</h2>
          <p class="text-center text-slate-500 text-sm">Texture + couleur obligatoires</p>
        </div>

        <div class="p-6 space-y-5">

          <!-- Toggle rÃ©tro -->
          <div class="bg-amber-50 border border-amber-200 rounded-[1.5rem] p-4">
            <label class="toggle-wrap" for="retro-chk">
              <input type="checkbox" id="retro-chk">
              <div class="toggle-track"><div class="toggle-thumb"></div></div>
              <div>
                <div class="font-bold text-sm text-slate-800">âª Caca en retard</div>
                <div class="text-xs text-slate-500">Saisir date/heure passÃ©e</div>
              </div>
            </label>
            <div id="retro-date-wrap" class="hidden mt-3">
              <label class="text-xs font-bold text-slate-600 block mb-1">Date et heure du caca :</label>
              <input type="datetime-local" id="retro-date"
                class="w-full p-3 border border-amber-300 bg-white rounded-[1rem] text-sm font-bold text-slate-800 focus:outline-none focus:ring-2 focus:ring-amber-400" />
            </div>
          </div>

          <!-- Texture -->
          <div>
            <div class="text-sm font-bold mb-3 text-slate-800">Texture <span id="texture-err" class="text-red-500 text-xs hidden">â† obligatoire</span></div>
            <div class="grid grid-cols-3 gap-3">
              <button class="texture-btn p-3 rounded-[1.25rem] border-2 border-gray-200 text-center text-slate-800 hover:border-amber-400 transition-colors" data-texture="normal">ğŸ’©<div class="text-xs mt-1">Normal</div></button>
              <button class="texture-btn p-3 rounded-[1.25rem] border-2 border-gray-200 text-center text-slate-800 hover:border-amber-400 transition-colors" data-texture="dur">ğŸ—¿<div class="text-xs mt-1">Dur</div></button>
              <button class="texture-btn p-3 rounded-[1.25rem] border-2 border-gray-200 text-center text-slate-800 hover:border-amber-400 transition-colors" data-texture="mou">ğŸ®<div class="text-xs mt-1">Mou</div></button>
              <button class="texture-btn p-3 rounded-[1.25rem] border-2 border-gray-200 text-center text-slate-800 hover:border-amber-400 transition-colors" data-texture="spray">ğŸ’¦<div class="text-xs mt-1">Spray</div></button>
              <button class="texture-btn p-3 rounded-[1.25rem] border-2 border-gray-200 text-center text-slate-800 hover:border-amber-400 transition-colors" data-texture="liquide">ğŸŒŠ<div class="text-xs mt-1">Liquide</div></button>
              <button class="texture-btn p-3 rounded-[1.25rem] border-2 border-gray-200 text-center text-slate-800 hover:border-amber-400 transition-colors" data-texture="explosif">ğŸ’¥<div class="text-xs mt-1">Explosif</div></button>
            </div>
          </div>

          <!-- Couleur -->
          <div>
            <div class="text-sm font-bold mb-3 text-slate-800">Couleur <span id="color-err" class="text-red-500 text-xs hidden">â† obligatoire</span></div>
            <div class="flex gap-3 flex-wrap">
              <button class="color-btn w-12 h-12 rounded-[1rem] border-4 border-white shadow-md transition-transform" style="background:#8B4513" data-color="marron" title="Marron"></button>
              <button class="color-btn w-12 h-12 rounded-[1rem] border-4 border-white shadow-md transition-transform" style="background:#FFD700" data-color="jaune" title="Jaune"></button>
              <button class="color-btn w-12 h-12 rounded-[1rem] border-4 border-white shadow-md transition-transform" style="background:#228B22" data-color="vert" title="Vert"></button>
              <button class="color-btn w-12 h-12 rounded-[1rem] border-4 border-white shadow-md transition-transform" style="background:#111" data-color="noir" title="Noir"></button>
              <button class="color-btn w-12 h-12 rounded-[1rem] border-4 border-white shadow-md transition-transform" style="background:linear-gradient(45deg,#ff69b4,#ffd700,#00ced1,#9370db)" data-color="arc-en-ciel" title="Arc-en-ciel"></button>
              <button class="color-btn w-12 h-12 rounded-[1rem] border-4 border-white shadow-md transition-transform" style="background:#ef4444" data-color="rouge" title="Rouge"></button>
            </div>
          </div>

          <!-- Note -->
          <div>
            <div class="text-sm font-bold mb-2 text-slate-800">Note (optionnel)</div>
            <textarea id="comment" class="w-full p-3 border border-gray-200 rounded-[1.25rem] resize-none text-slate-800 focus:outline-none focus:ring-2 focus:ring-amber-400" rows="2" placeholder="Ex: Record perso !"></textarea>
          </div>

          <!-- Humeur (optionnel) -->
          <div>
            <div class="text-sm font-bold mb-2 text-slate-800">Humeur (optionnel)</div>
            <div class="grid grid-cols-4 gap-2">
              <button class="mood-btn p-2 rounded-[1rem] border-2 border-gray-200 text-center text-slate-800" data-mood="normal">ğŸ˜Š<div class="text-xs mt-0.5">Normal</div></button>
              <button class="mood-btn p-2 rounded-[1rem] border-2 border-gray-200 text-center text-slate-800" data-mood="douloureux">ğŸ˜«<div class="text-xs mt-0.5">Douloureux</div></button>
              <button class="mood-btn p-2 rounded-[1rem] border-2 border-gray-200 text-center text-slate-800" data-mood="urgent">âš¡<div class="text-xs mt-0.5">Urgent</div></button>
              <button class="mood-btn p-2 rounded-[1rem] border-2 border-gray-200 text-center text-slate-800" data-mood="difficile">ğŸ˜´<div class="text-xs mt-0.5">Difficile</div></button>
            </div>
          </div>

          <!-- Boutons -->
          <div class="flex gap-3 pb-2">
            <button id="cancel-drawer" class="flex-1 bg-gray-100 text-slate-700 py-4 rounded-[1.25rem] font-bold">Annuler</button>
            <button id="save-poop" class="flex-1 text-white py-4 rounded-[1.25rem] font-bold" style="background:linear-gradient(135deg,#10b981,#059669)">ğŸ’¥ Valider</button>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script>
  // ===================================================
  //  UTILS
  // ===================================================
  const $id = id => document.getElementById(id);
  const $debug = msg => {
    const el = $id('debug-box');
    if (!el) return;
    el.textContent = (String(msg) + '\n' + el.textContent).slice(0, 3000);
  };
  window.addEventListener('error', e => $debug('âŒ ' + e.message));
  window.addEventListener('unhandledrejection', e => $debug('âŒ promise: ' + (e.reason?.message || e.reason)));

  // ===================================================
  //  STORAGE
  // ===================================================
  const STORAGE_KEY = 'cacaTracker.v2';
  let _memFallback = null;

  function lsAvailable() {
    try { localStorage.setItem('__t','1'); localStorage.removeItem('__t'); return true; } catch { return false; }
  }
  const LS_OK = lsAvailable();

  function loadState() {
    try {
      const raw = LS_OK ? localStorage.getItem(STORAGE_KEY) : null;
      return raw ? JSON.parse(raw) : _memFallback;
    } catch(e) { $debug('load err: ' + e.message); return null; }
  }

  function saveState(s) {
    try {
      if (LS_OK) localStorage.setItem(STORAGE_KEY, JSON.stringify(s));
      else _memFallback = s;
    } catch(e) { $debug('save err: ' + e.message); _memFallback = s; }
  }

  // ===================================================
  //  STATE
  // ===================================================
  let state = { logs: [], theme: 'default' };
  let selectedTexture = null;
  let selectedColor   = null;
  let selectedMood    = null;
  let weekChart = null;

  // ===================================================
  //  INIT
  // ===================================================
  document.addEventListener('DOMContentLoaded', () => {
    // Load
    const saved = loadState();
    if (saved?.logs && Array.isArray(saved.logs)) state = { ...state, ...saved };

    // Theme
    applyTheme(state.theme || 'default');
    applyAutoNight();
    setInterval(() => { applyAutoNight(); checkCustomReminder(); }, 60000);

    // Sticky header
    applyStickyHeader();

    // Datetime max
    refreshRetroMax();

    // Status
    $id('status-pill') && ($id('status-pill').textContent = [LS_OK ? 'localStorage âœ…' : 'MÃ©moire âš ï¸', navigator.onLine ? 'ğŸŒ' : 'âœˆï¸'].join(' '));

    // Events
    setupEvents();
    buildBadgesGrid();
    renderAll();
    initChart();

    // PWA
    registerSW();
    showInstallBanner();

    // Modules v2.0 init
    window.JokesModule?.displayDailyJoke();

    // Sons : injecter le contrÃ´leur dans l'onglet Historique
    const soundSettingsEl = $id('sound-settings');
    if (soundSettingsEl && typeof createSoundControl === 'function') {
      soundSettingsEl.innerHTML = createSoundControl();
    }

    // VÃ©rifier si une notification de rappel doit Ãªtre affichÃ©e
    checkPoopNotification();

    // Supabase : Ã©couter l'Ã©vÃ©nement de rÃ©cupÃ©ration de mot de passe
    // (doit Ãªtre enregistrÃ© AVANT initAuthListener pour ne pas rater l'Ã©vÃ©nement)
    window.addEventListener('supabase-password-recovery', () => {
      $id('new-password-modal').classList.remove('hidden');
    });

    // Supabase : dÃ©marrer le listener auth EN PREMIER pour capturer PASSWORD_RECOVERY
    if (window.SupabaseClient) {
      window.SupabaseClient.initAuthListener();
    }

    // Supabase : restaurer session si dÃ©jÃ  connectÃ©
    if (window.SupabaseClient) {
      window.SupabaseClient.getSession().then(async profile => {
        if (profile) {
          updateUserBadge(profile);
          await syncCloudData();   // â† pull cloud data into local state
          $debug('â˜ï¸ session restored: ' + profile.username);
        }
      }).catch(() => {});
    }

    // Initialiser les features supplÃ©mentaires
    setupGoal();
    startCountdown();
    setupTimer();
    $id('wrapped-btn')?.addEventListener('click', openWrapped);
    $id('close-wrapped-btn')?.addEventListener('click', () => $id('wrapped-modal').classList.add('hidden'));
    $id('close-day-detail-btn')?.addEventListener('click', () => $id('day-detail-modal').classList.add('hidden'));
    $id('share-stats-btn')?.addEventListener('click', shareStats);
    $id('share-app-btn')?.addEventListener('click', shareApp);
    $id('export-ical-btn')?.addEventListener('click', exportIcal);

    // Auto-join via ?join=CODE in URL
    const urlJoinCode = new URLSearchParams(window.location.search).get('join');
    if (urlJoinCode) {
      // Remove the param from URL to avoid double-join on refresh
      history.replaceState({}, '', window.location.pathname);
      // Wait for session to restore, then try to join
      setTimeout(async () => {
        if (!window.SupabaseClient?.isLoggedIn()) {
          // Not logged in â€” go to social tab and prefill code
          switchTab('social');
          const inp = $id('invite-code-input');
          if (inp) inp.value = urlJoinCode.toUpperCase();
          alert('Connecte-toi pour rejoindre le groupe avec le code : ' + urlJoinCode.toUpperCase());
        } else {
          try {
            const g = await window.SupabaseClient.joinGroup(urlJoinCode);
            alert(`ğŸ‰ Tu as rejoint le groupe "${g.name}" !`);
            switchTab('social');
            window.SocialModule?.renderSocialTab();
          } catch(e) {
            alert('Impossible de rejoindre : ' + e.message);
          }
        }
      }, 1500);
    }

    $debug('âœ… ready. logs=' + state.logs.length);
  });

  // ===================================================
  //  OBJECTIF DU JOUR ğŸ¯
  // ===================================================
  function setupGoal() {
    const stored = parseInt(localStorage.getItem('dailyGoal') || '1');
    updateGoalUI(stored);

    $id('goal-minus')?.addEventListener('click', () => {
      const v = Math.max(1, parseInt(localStorage.getItem('dailyGoal') || '1') - 1);
      localStorage.setItem('dailyGoal', v);
      updateGoalUI(v);
    });
    $id('goal-plus')?.addEventListener('click', () => {
      const v = Math.min(10, parseInt(localStorage.getItem('dailyGoal') || '1') + 1);
      localStorage.setItem('dailyGoal', v);
      updateGoalUI(v);
    });
  }

  function updateGoalUI(goal) {
    const goalVal = goal || parseInt(localStorage.getItem('dailyGoal') || '1');
    const today = new Date().toDateString();
    const todayCount = state.logs.filter(l => new Date(l.date).toDateString() === today).length;
    const pct = Math.min(100, Math.round((todayCount / goalVal) * 100));
    const bar = $id('goal-bar');
    const label = $id('goal-label');
    const valEl = $id('goal-value');
    if (valEl) valEl.textContent = goalVal;
    if (bar) {
      bar.style.width = pct + '%';
      bar.style.background = pct >= 100 ? '#10b981' : 'var(--accent)';
    }
    if (label) {
      label.textContent = pct >= 100
        ? `ğŸ‰ Objectif atteint ! ${todayCount} / ${goalVal} caca${goalVal > 1 ? 's' : ''}`
        : `${todayCount} / ${goalVal} caca${goalVal > 1 ? 's' : ''} aujourd'hui`;
    }
    // Streak d'objectifs
    const goalStreakEl = $id('goal-streak');
    if (goalStreakEl) {
      const gs = calculateGoalStreak(goalVal);
      goalStreakEl.textContent = gs > 0 ? `ğŸ”¥ ${gs}j d'affilÃ©e` : '';
      goalStreakEl.classList.toggle('hidden', gs === 0);
    }
  }

  function calculateGoalStreak(goal) {
    let streak = 0;
    const today = new Date();
    for (let i = 0; i < 90; i++) {
      const d = new Date(today);
      d.setDate(today.getDate() - i);
      const ds = d.toDateString();
      const count = state.logs.filter(l => new Date(l.date).toDateString() === ds).length;
      if (count >= goal) streak++;
      else break;
    }
    return streak;
  }

  // ===================================================
  //  COMPTE Ã€ REBOURS â±ï¸
  // ===================================================
  let _countdownInterval = null;

  function startCountdown() {
    if (_countdownInterval) clearInterval(_countdownInterval);
    _countdownInterval = setInterval(tickCountdown, 60000);
    tickCountdown();
  }

  function tickCountdown() {
    const container = $id('countdown-container');
    const display   = $id('countdown-display');
    if (!container || !display) return;

    if (state.logs.length < 2 || typeof PredictionEngine === 'undefined') {
      container.style.display = 'none';
      return;
    }
    try {
      const pred = new PredictionEngine(state.logs).predictNextPoop();
      if (!pred || !pred.nextTime) { container.style.display = 'none'; return; }

      const diffMs = pred.nextTime - Date.now();
      if (diffMs <= 0) {
        display.textContent = 'Maintenant ? ğŸš¨';
        container.style.display = 'flex';
        return;
      }
      const h = Math.floor(diffMs / 3600000);
      const m = Math.floor((diffMs % 3600000) / 60000);
      display.textContent = h > 0 ? `${h}h ${m}min` : `${m} min`;
      container.style.display = 'flex';
    } catch(e) {
      container.style.display = 'none';
    }
  }

  // ===================================================
  //  ANNÃ‰E EN REVIEW ğŸ¬
  // ===================================================
  function openWrapped() {
    const modal = $id('wrapped-modal');
    const content = $id('wrapped-content');
    if (!modal || !content) return;

    const logs = state.logs;
    if (!logs.length) {
      content.innerHTML = '<div class="text-white text-center opacity-60 py-8">Ajoute des cacas pour voir ton annÃ©e en review !</div>';
      modal.classList.remove('hidden');
      return;
    }

    const now = new Date();
    const yearStart = new Date(now.getFullYear(), 0, 1).getTime();
    const yearLogs  = logs.filter(l => l.date >= yearStart);
    const allLogs   = logs;

    // Mois le plus actif (cette annÃ©e)
    const monthCounts = {};
    yearLogs.forEach(l => {
      const m = new Date(l.date).getMonth();
      monthCounts[m] = (monthCounts[m] || 0) + 1;
    });
    const bestMonthIdx = Object.entries(monthCounts).sort((a,b) => b[1]-a[1])[0];
    const monthNames = ['Jan','FÃ©v','Mar','Avr','Mai','Jun','Jul','AoÃ»','Sep','Oct','Nov','DÃ©c'];

    // Texture prÃ©fÃ©rÃ©e
    const textureCounts = {};
    allLogs.forEach(l => { textureCounts[l.texture] = (textureCounts[l.texture] || 0) + 1; });
    const favTexture = Object.entries(textureCounts).sort((a,b) => b[1]-a[1])[0];
    const textureEmoji = {normal:'ğŸ’©',dur:'ğŸ—¿',mou:'ğŸ®',spray:'ğŸ’¦',liquide:'ğŸŒŠ',explosif:'ğŸ’¥'};

    // Heure prÃ©fÃ©rÃ©e
    const hourCounts = new Array(24).fill(0);
    allLogs.forEach(l => { hourCounts[new Date(l.date).getHours()]++; });
    const peakHour = hourCounts.indexOf(Math.max(...hourCounts));

    // Streak max
    const days = [...new Set(allLogs.map(l => new Date(l.date).toDateString()))].sort();
    let maxStreak = 0, curStreak = 0;
    days.forEach((d, i) => {
      if (i === 0) { curStreak = 1; }
      else {
        const prev = new Date(days[i-1]); prev.setDate(prev.getDate()+1);
        curStreak = prev.toDateString() === d ? curStreak + 1 : 1;
      }
      maxStreak = Math.max(maxStreak, curStreak);
    });

    // Jour de la semaine favori
    const dayNames = ['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'];
    const dowCounts = new Array(7).fill(0);
    allLogs.forEach(l => { dowCounts[new Date(l.date).getDay()]++; });
    const bestDow = dowCounts.indexOf(Math.max(...dowCounts));

    const cards = [
      { emoji:'ğŸ’©', label:'Total cette annÃ©e',  value:`${yearLogs.length} cacas`, sub:`${(yearLogs.length*0.15).toFixed(1)} kg produits` },
      { emoji:'ğŸ“…', label:'Mois le plus actif', value: bestMonthIdx ? `${monthNames[bestMonthIdx[0]]} (${bestMonthIdx[1]})` : 'â€”', sub:'Mois oÃ¹ t\'as le plus dÃ©fiÃ© la gravitÃ©' },
      { emoji: favTexture ? (textureEmoji[favTexture[0]] || 'ğŸ’©') : 'ğŸ’©', label:'Texture fav', value: favTexture ? `${favTexture[0]} (${favTexture[1]}Ã—)` : 'â€”', sub:'Ton style signature' },
      { emoji:'ğŸ•', label:'Heure de prÃ©dilection', value:`${String(peakHour).padStart(2,'0')}h`, sub:'Ton horloge intestinale' },
      { emoji:'ğŸ”¥', label:'Meilleur streak', value:`${maxStreak} jour${maxStreak>1?'s':''}`, sub:'Record de rÃ©gularitÃ©' },
      { emoji:'ğŸ“†', label:'Jour prÃ©fÃ©rÃ©', value:dayNames[bestDow], sub:'Les intestins ont leurs habitudes' },
      { emoji:'âš–ï¸', label:'Tonnage total', value:`${(allLogs.length * 0.15).toFixed(1)} kg`, sub:`Depuis le dÃ©but (${allLogs.length} cacas)` },
    ];

    content.innerHTML = cards.map(c => `
      <div class="rounded-[1.5rem] p-4 text-white" style="background:rgba(255,255,255,0.12);backdrop-filter:blur(4px)">
        <div class="text-3xl mb-1">${c.emoji}</div>
        <div class="text-xs opacity-70 uppercase tracking-widest mb-1">${c.label}</div>
        <div class="text-2xl font-bold mb-1">${c.value}</div>
        <div class="text-xs opacity-60">${c.sub}</div>
      </div>`).join('');

    modal.classList.remove('hidden');
  }

  // ===================================================
  //  PARTAGE STATS ğŸ“¤
  // ===================================================
  function shareStats() {
    const canvas = $id('share-canvas');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const W = canvas.width, H = canvas.height;

    const today = new Date().toDateString();
    const todayCount = state.logs.filter(l => new Date(l.date).toDateString() === today).length;
    const total  = state.logs.length;
    const streak = calculateStreak();
    const mass   = (total * 0.15).toFixed(1);

    // Fond dÃ©gradÃ©
    const grad = ctx.createLinearGradient(0,0,W,H);
    grad.addColorStop(0, '#d97706');
    grad.addColorStop(1, '#ec4899');
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, W, H);

    // Titre
    ctx.fillStyle = 'rgba(255,255,255,0.15)';
    ctx.font = 'bold 72px serif';
    ctx.fillText('ğŸ’©', 20, 80);

    ctx.fillStyle = '#fff';
    ctx.font = 'bold 28px sans-serif';
    ctx.fillText('Mes stats â€” Caca-Tracker 3000', 100, 50);
    ctx.font = '16px sans-serif';
    ctx.fillStyle = 'rgba(255,255,255,0.8)';
    ctx.fillText(new Date().toLocaleDateString('fr'), 100, 75);

    // Stats
    const stats = [
      { label: 'Aujourd\'hui', val: todayCount + ' caca' + (todayCount > 1 ? 's' : '') },
      { label: 'Total',        val: total + ' cacas' },
      { label: 'Streak',       val: 'ğŸ”¥ ' + streak + ' jour' + (streak > 1 ? 's' : '') },
      { label: 'Tonnage',      val: 'âš–ï¸ ' + mass + ' kg' },
    ];
    stats.forEach((s, i) => {
      const x = (i % 2) * (W/2) + 30;
      const y = 140 + Math.floor(i / 2) * 95;
      ctx.fillStyle = 'rgba(255,255,255,0.18)';
      ctx.beginPath();
      ctx.roundRect(x, y, W/2 - 50, 80, 16);
      ctx.fill();
      ctx.fillStyle = 'rgba(255,255,255,0.7)';
      ctx.font = '13px sans-serif';
      ctx.fillText(s.label, x + 14, y + 24);
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 26px sans-serif';
      ctx.fillText(s.val, x + 14, y + 60);
    });

    // Footer
    ctx.fillStyle = 'rgba(255,255,255,0.5)';
    ctx.font = '12px sans-serif';
    ctx.fillText('caca-tracker.vercel.app', W/2 - 70, H - 12);

    // Partager ou tÃ©lÃ©charger
    canvas.toBlob(blob => {
      const file = new File([blob], 'caca-stats.png', { type: 'image/png' });
      if (navigator.share && navigator.canShare?.({ files: [file] })) {
        navigator.share({ title: 'Mes stats ğŸ’©', files: [file] }).catch(() => downloadCanvas(canvas));
      } else {
        downloadCanvas(canvas);
      }
    });
  }

  function downloadCanvas(canvas) {
    const a = document.createElement('a');
    a.href = canvas.toDataURL('image/png');
    a.download = 'caca-stats.png';
    a.click();
  }

  // ===================================================
  //  DÃ‰TAIL DU JOUR ğŸ“…
  // ===================================================
  function showDayDetail(dateKey) {
    const modal   = $id('day-detail-modal');
    const title   = $id('day-detail-title');
    const content = $id('day-detail-content');
    if (!modal) return;

    const [year, month, day] = dateKey.split('-').map(Number);
    const d = new Date(year, month - 1, day);
    const label = d.toLocaleDateString('fr', { weekday:'long', day:'numeric', month:'long', year:'numeric' });
    if (title) title.textContent = 'ğŸ“… ' + label;

    const dayLogs = state.logs.filter(l => {
      const ld = new Date(l.date);
      return ld.getFullYear() === year && ld.getMonth() === month - 1 && ld.getDate() === day;
    }).sort((a,b) => a.date - b.date);

    const textureEmoji = { normal:'ğŸ’©',dur:'ğŸ—¿',mou:'ğŸ®',spray:'ğŸ’¦',liquide:'ğŸŒŠ',explosif:'ğŸ’¥' };
    const moodEmoji    = { normal:'ğŸ˜Š',douloureux:'ğŸ˜«',urgent:'âš¡',difficile:'ğŸ˜´' };

    content.innerHTML = dayLogs.length === 0
      ? '<div class="text-white opacity-60 text-center py-8">Aucun caca ce jour-lÃ </div>'
      : dayLogs.map(l => {
          const t = new Date(l.date).toLocaleTimeString('fr', { hour:'2-digit', minute:'2-digit' });
          return `
            <div class="rounded-[1.25rem] p-3 text-white" style="background:rgba(255,255,255,0.12)">
              <div class="flex items-center gap-2">
                <span class="text-2xl">${textureEmoji[l.texture] || 'ğŸ’©'}</span>
                <div class="flex-1">
                  <div class="font-bold">${l.texture} <span class="opacity-70 text-sm">Ã  ${t}</span></div>
                  <div class="text-xs opacity-70">${l.color}${l.mood ? ' Â· ' + (moodEmoji[l.mood] || '') + ' ' + l.mood : ''}${l.comment ? ' Â· ' + l.comment : ''}</div>
                </div>
              </div>
            </div>`;
        }).join('');

    modal.classList.remove('hidden');
  }

  // ===================================================
  //  SCORE SANTÃ‰ ğŸ¥
  // ===================================================
  function renderHealthScore() {
    const el = $id('health-score-container');
    if (!el || state.logs.length < 5) { if (el) el.innerHTML = ''; return; }

    const sorted = [...state.logs].sort((a,b) => a.date - b.date);
    const intervals = [];
    for (let i = 1; i < sorted.length; i++) {
      intervals.push((sorted[i].date - sorted[i-1].date) / 3600000);
    }
    const avg = intervals.reduce((a,b) => a+b, 0) / intervals.length;
    const stdDev = Math.sqrt(intervals.map(x => Math.pow(x - avg, 2)).reduce((a,b) => a+b, 0) / intervals.length);
    const cv = avg > 0 ? stdDev / avg : 1;
    const streak = calculateStreak();

    // Grille de score
    let score = 100;
    // Intervalle idÃ©al : 12-36h
    if (avg < 8 || avg > 72) score -= 30;
    else if (avg < 12 || avg > 48) score -= 15;
    // RÃ©gularitÃ© (coefficient de variation)
    if (cv > 0.8)      score -= 30;
    else if (cv > 0.5) score -= 15;
    else if (cv > 0.3) score -= 5;
    // Streak
    if (streak >= 7)  score += 10;
    else if (streak < 2) score -= 10;
    score = Math.max(0, Math.min(100, score));

    const grade = score >= 80 ? 'A' : score >= 60 ? 'B' : score >= 40 ? 'C' : 'D';
    const gradeColor = { A:'#10b981', B:'#f59e0b', C:'#f97316', D:'#ef4444' }[grade];
    const gradeMsg   = { A:'Excellent â€” intestins en or !', B:'Bien â€” rÃ©gularitÃ© correcte', C:'Moyen â€” pense Ã  t\'hydrater', D:'Ã€ amÃ©liorer â€” consulte un mÃ©decin ?' }[grade];
    const avgH = Math.round(avg);
    const cvPct = Math.round(cv * 100);

    el.innerHTML = `
      <div class="card p-4 rounded-[1.5rem]">
        <div class="font-bold mb-3 text-sm">ğŸ¥ Score de rÃ©gularitÃ© intestinale</div>
        <div class="flex items-center gap-4">
          <div class="w-16 h-16 rounded-full flex items-center justify-center text-2xl font-bold text-white flex-shrink-0"
               style="background:${gradeColor}">${grade}</div>
          <div class="flex-1">
            <div class="font-bold" style="color:${gradeColor}">${gradeMsg}</div>
            <div class="text-xs opacity-60 mt-1">Intervalle moyen : ${avgH}h Â· VariabilitÃ© : ${cvPct}% Â· Streak : ${streak}j</div>
            <div class="w-full rounded-full overflow-hidden mt-2" style="height:6px;background:rgba(0,0,0,0.08)">
              <div style="width:${score}%;height:100%;border-radius:99px;background:${gradeColor};transition:width .6s"></div>
            </div>
          </div>
        </div>
      </div>`;
  }

  // ===================================================
  //  RECORDS PERSONNELS ğŸ…  (feature 9)
  // ===================================================
  function renderPersonalRecords() {
    const el = $id('records-container');
    if (!el || state.logs.length < 3) { if (el) el.innerHTML = ''; return; }

    const logs = state.logs;

    // Best single day
    const dayCounts = {};
    logs.forEach(l => {
      const k = new Date(l.date).toDateString();
      dayCounts[k] = (dayCounts[k] || 0) + 1;
    });
    const bestDay = Math.max(...Object.values(dayCounts));

    // Best streak (all time)
    const uniqueDays = [...new Set(logs.map(l => {
      const d = new Date(l.date);
      return new Date(d.getFullYear(), d.getMonth(), d.getDate()).getTime();
    }))].sort((a, b) => a - b);
    let bestStreak = 1, cur = 1;
    for (let i = 1; i < uniqueDays.length; i++) {
      if (uniqueDays[i] - uniqueDays[i-1] === 86400000) { cur++; bestStreak = Math.max(bestStreak, cur); }
      else cur = 1;
    }

    // Best week (sliding 7 days)
    let bestWeek = 0;
    const sortedDates = logs.map(l => l.date).sort((a, b) => a - b);
    for (let i = 0; i < sortedDates.length; i++) {
      const window7End = sortedDates[i] + 7 * 86400000;
      let count = 0;
      for (let j = i; j < sortedDates.length && sortedDates[j] <= window7End; j++) count++;
      bestWeek = Math.max(bestWeek, count);
    }

    // Best month
    const monthCounts = {};
    logs.forEach(l => {
      const d = new Date(l.date);
      const k = d.getFullYear() + '-' + d.getMonth();
      monthCounts[k] = (monthCounts[k] || 0) + 1;
    });
    const bestMonth = Math.max(...Object.values(monthCounts));

    // Current streak
    const curStreak = (() => {
      let s = 0;
      const today = new Date(); today.setHours(0,0,0,0);
      for (let i = 0; i < 366; i++) {
        const d = new Date(today); d.setDate(d.getDate() - i);
        if (dayCounts[d.toDateString()]) s++;
        else if (i > 0) break;
      }
      return s;
    })();

    const records = [
      { icon: 'ğŸ”¥', label: 'Streak record', value: bestStreak + ' j', sub: curStreak > 0 ? 'actuel: ' + curStreak + 'j' : '' },
      { icon: 'ğŸ“…', label: 'Meilleur jour', value: bestDay + ' ğŸ’©', sub: bestDay > 1 ? 'en une journÃ©e !' : '' },
      { icon: 'ğŸ“†', label: 'Meilleure semaine', value: bestWeek + ' ğŸ’©', sub: 'sur 7 jours glissants' },
      { icon: 'ğŸ†', label: 'Meilleur mois', value: bestMonth + ' ğŸ’©', sub: 'en un mois calendaire' },
    ];

    el.innerHTML = `
      <div class="card p-4 rounded-[1.5rem]">
        <div class="font-bold mb-3 text-sm">ğŸ… Tes records personnels</div>
        <div class="grid grid-cols-2 gap-3">
          ${records.map(r => `
            <div class="rounded-[1rem] p-3 text-center" style="background:color-mix(in srgb,var(--accent) 8%,transparent)">
              <div class="text-2xl mb-1">${r.icon}</div>
              <div class="text-xs opacity-60 mb-0.5">${r.label}</div>
              <div class="font-bold text-lg" style="color:var(--accent)">${r.value}</div>
              ${r.sub ? `<div class="text-xs opacity-50 mt-0.5">${r.sub}</div>` : ''}
            </div>`).join('')}
        </div>
      </div>`;
  }

  // ===================================================
  //  TENDANCES DE SANTÃ‰ ğŸ“ˆ  (feature 10)
  // ===================================================
  function checkHealthTrends() {
    const el = $id('health-trend-banner');
    if (!el) return;

    if (state.logs.length === 0) { el.classList.add('hidden'); return; }

    const sorted = [...state.logs].sort((a, b) => b.date - a.date);
    const last   = sorted[0];
    const hoursSinceLast = last ? (Date.now() - last.date) / 3600000 : Infinity;

    // Alertes par ordre de prioritÃ©
    const alerts = [];

    // Constipation (>48h)
    if (hoursSinceLast > 48) {
      const h = Math.round(hoursSinceLast);
      alerts.push({ msg: `âš ï¸ ${h}h sans caca â€” attention Ã  la constipation !`, color: '#ef4444', bg: 'rgba(239,68,68,0.1)' });
    }

    // Selles liquides/explosives consÃ©cutives (â‰¥3 derniÃ¨res)
    const last3 = sorted.slice(0, 3);
    if (last3.length === 3 && last3.every(l => l.texture === 'liquide' || l.texture === 'explosif')) {
      alerts.push({ msg: 'ğŸ’Š 3 selles liquides/explosives consÃ©cutives â€” hydrate-toi bien !', color: '#f97316', bg: 'rgba(249,115,22,0.1)' });
    }

    // Dures consÃ©cutives (â‰¥3)
    if (last3.length === 3 && last3.every(l => l.texture === 'dur')) {
      alerts.push({ msg: 'ğŸª¨ 3 selles dures consÃ©cutives â€” bois plus d\'eau !', color: '#7c3aed', bg: 'rgba(124,58,237,0.1)' });
    }

    // Message positif : streak > 7 sans alerte
    if (!alerts.length) {
      const streak = (() => {
        const days = new Set(state.logs.map(l => new Date(l.date).toDateString()));
        let s = 0, today = new Date();
        for (let i = 0; i < 30; i++) {
          const d = new Date(today); d.setDate(d.getDate() - i);
          if (days.has(d.toDateString())) s++;
          else if (i > 0) break;
        }
        return s;
      })();
      if (streak >= 7) {
        alerts.push({ msg: `ğŸŒŸ ${streak} jours de suite ! Super rÃ©gularitÃ© intestinale ğŸ’ª`, color: '#10b981', bg: 'rgba(16,185,129,0.1)' });
      }
    }

    if (!alerts.length) { el.classList.add('hidden'); return; }

    const a = alerts[0];
    el.style.cssText = `background:${a.bg};color:${a.color};border:1.5px solid color-mix(in srgb,${a.color} 30%,transparent)`;
    el.textContent = a.msg;
    el.classList.remove('hidden');
  }

  // ===================================================
  //  EXPORT PDF MÃ‰DICAL ğŸ¥  (feature 8)
  // ===================================================
  function exportMedicalPDF() {
    const el = $id('print-report');
    if (!el) return;

    const now = new Date();
    const logs = state.logs;
    if (!logs.length) { alert('Aucune donnÃ©e Ã  exporter !'); return; }

    const total = logs.length;
    const sorted = [...logs].sort((a, b) => a.date - b.date);
    const firstDate = new Date(sorted[0].date).toLocaleDateString('fr');
    const lastDate  = new Date(sorted[sorted.length - 1].date).toLocaleDateString('fr');
    const days      = Math.max(1, (sorted[sorted.length - 1].date - sorted[0].date) / 86400000);
    const avgPerDay = (total / days).toFixed(2);

    const textureCounts = {};
    logs.forEach(l => { textureCounts[l.texture] = (textureCounts[l.texture] || 0) + 1; });

    const intervals = [];
    for (let i = 1; i < sorted.length; i++) intervals.push((sorted[i].date - sorted[i-1].date) / 3600000);
    const avgTransit = intervals.length ? Math.round(intervals.reduce((a,b) => a+b, 0) / intervals.length) : null;

    const textureNames = { normal:'Normal (Bristol 3-4)', dur:'Dur (Bristol 1-2)', mou:'Mou (Bristol 5)', spray:'Floconneux (Bristol 6)', liquide:'Liquide (Bristol 7)', explosif:'Explosif (Bristol 7)' };

    el.innerHTML = `
      <div class="print-section">
        <h1 style="font-size:20pt;margin-bottom:4px">ğŸ“‹ Rapport intestinal mÃ©dical</h1>
        <p style="opacity:.6;font-size:10pt">GÃ©nÃ©rÃ© le ${now.toLocaleDateString('fr')} â€” Caca-Tracker 3000 Deluxe</p>
        <hr style="margin:12px 0">
        <p><strong>PÃ©riode :</strong> ${firstDate} â†’ ${lastDate}</p>
        <p><strong>Total d'entrÃ©es :</strong> ${total} selles</p>
        <p><strong>FrÃ©quence moyenne :</strong> ${avgPerDay}/jour</p>
        ${avgTransit !== null ? `<p><strong>Transit intestinal moyen :</strong> ${avgTransit}h</p>` : ''}
        <p><strong>Tonnage estimÃ© :</strong> ${(total * 0.15).toFixed(1)} kg</p>
      </div>
      <div class="print-section">
        <h2 style="font-size:14pt;margin-bottom:8px">RÃ©partition selon l'Ã‰chelle de Bristol</h2>
        ${Object.entries(textureCounts).map(([t, c]) => {
          const pct = Math.round(c / total * 100);
          return `<p style="margin-bottom:6px">
            <strong>${textureNames[t] || t} :</strong> ${c} (${pct}%)
            <div class="print-bar-bg"><div class="print-bar-fill" style="width:${pct}%"></div></div>
          </p>`;
        }).join('')}
        <p style="margin-top:12px;font-size:10pt;opacity:.7">âœ… IdÃ©al mÃ©dical : 75-85% Normal, moins de 5% Liquide/Explosif</p>
      </div>
      <div class="print-section">
        <h2 style="font-size:14pt;margin-bottom:8px">Note pour le mÃ©decin</h2>
        <p style="font-size:10pt;opacity:.7">Ces donnÃ©es ont Ã©tÃ© collectÃ©es via l'application Caca-Tracker 3000 Deluxe (enregistrement manuel). La classification des selles suit l'Ã‰chelle de Bristol (1-7). Les donnÃ©es sont Ã  titre indicatif et doivent Ãªtre interprÃ©tÃ©es par un professionnel de santÃ©.</p>
      </div>`;

    window.print();
  }

  // ===================================================
  //  COMPARAISON MENSUELLE ğŸ“†  (feature 19 â€” 3 colonnes)
  // ===================================================
  function renderMonthCompare() {
    const el = $id('month-compare-container');
    if (!el) return;
    const now = new Date();
    const thisStart  = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
    const lastStart  = new Date(now.getFullYear(), now.getMonth() - 1, 1).getTime();
    const lyStart    = new Date(now.getFullYear() - 1, now.getMonth(), 1).getTime();
    const lyEnd      = new Date(now.getFullYear() - 1, now.getMonth() + 1, 1).getTime();

    const thisCount = state.logs.filter(l => l.date >= thisStart).length;
    const lastCount = state.logs.filter(l => l.date >= lastStart && l.date < thisStart).length;
    const lyCount   = state.logs.filter(l => l.date >= lyStart && l.date < lyEnd).length;

    const delta  = thisCount - lastCount;
    const color  = delta > 0 ? '#10b981' : delta < 0 ? '#ef4444' : '#94a3b8';
    const arrow  = delta > 0 ? 'â†‘' : delta < 0 ? 'â†“' : '=';
    const pct    = lastCount > 0 ? Math.round(Math.abs(delta / lastCount) * 100) : null;

    const monthNames = ['Jan','FÃ©v','Mar','Avr','Mai','Jun','Jul','AoÃ»','Sep','Oct','Nov','DÃ©c'];
    const thisMonthName = monthNames[now.getMonth()];
    const lastMonthName = monthNames[(now.getMonth() + 11) % 12];
    const lyLabel       = thisMonthName + ' ' + (now.getFullYear() - 1);

    // Barre visuelle (max des 3 pour normaliser)
    const maxVal = Math.max(thisCount, lastCount, lyCount, 1);
    function bar(count) {
      const w = Math.round((count / maxVal) * 100);
      return `<div class="w-full rounded-full overflow-hidden mt-1" style="height:4px;background:rgba(0,0,0,0.08)">
        <div style="width:${w}%;height:100%;border-radius:99px;background:var(--accent);transition:width .5s"></div></div>`;
    }

    el.innerHTML = `
      <div class="card p-4 rounded-[1.5rem]">
        <div class="font-bold mb-3 text-sm">ğŸ“† Moi vs moi-mÃªme</div>
        <div class="grid grid-cols-3 gap-2 text-center">
          <div>
            <div class="text-xs opacity-50">${lastMonthName}</div>
            <div class="text-xl font-bold">${lastCount}</div>
            ${bar(lastCount)}
          </div>
          <div>
            <div class="text-xs font-bold" style="color:var(--accent)">${thisMonthName} âœ¨</div>
            <div class="text-xl font-bold" style="color:var(--accent)">${thisCount}</div>
            ${bar(thisCount)}
            ${pct !== null ? `<div class="text-xs font-bold mt-1" style="color:${color}">${delta > 0 ? '+' : ''}${delta !== 0 ? (delta > 0 ? '+' : '') + pct + '%' : '='}</div>` : ''}
          </div>
          <div>
            <div class="text-xs opacity-50">${lyLabel}</div>
            <div class="text-xl font-bold opacity-70">${lyCount}</div>
            ${bar(lyCount)}
          </div>
        </div>
        ${pct !== null ? `<div class="text-center text-xs mt-3 opacity-60">${arrow} ${Math.abs(delta)} caca${Math.abs(delta) > 1 ? 's' : ''} vs le mois dernier</div>` : ''}
      </div>`;
  }

  // ===================================================
  //  BRISTOL SCALE ğŸ”¬  (feature 17)
  // ===================================================
  function renderBristolScale() {
    const el = $id('bristol-container');
    if (!el || state.logs.length === 0) { if (el) el.innerHTML = ''; return; }

    const bristolLevels = [
      { num: 1, label: 'Type 1', desc: 'Petites boules dures sÃ©parÃ©es', textures: ['dur'], color: '#7c3aed', icon: 'âš«âš«âš«' },
      { num: 2, label: 'Type 2', desc: 'Saucisse grumeleuse et dure',   textures: ['dur'], color: '#9c4221', icon: 'ğŸŸ¤ğŸŸ¤' },
      { num: 3, label: 'Type 3', desc: 'Saucisse avec craquelures',     textures: ['normal'], color: '#d97706', icon: 'ğŸŸ«' },
      { num: 4, label: 'Type 4', desc: 'Saucisse lisse et molle âœ…',    textures: ['normal'], color: '#10b981', icon: 'ğŸ’©' },
      { num: 5, label: 'Type 5', desc: 'Morceaux mous aux bords nets',  textures: ['mou'], color: '#f59e0b', icon: 'ğŸŸ¡' },
      { num: 6, label: 'Type 6', desc: 'PÃ¢teux, morceaux effilochÃ©s',   textures: ['spray'], color: '#f97316', icon: 'ğŸ’¦' },
      { num: 7, label: 'Type 7', desc: 'EntiÃ¨rement liquide',           textures: ['liquide','explosif'], color: '#ef4444', icon: 'ğŸŒŠ' },
    ];

    // Compter par texture mappÃ©e sur Bristol
    const textureCounts = {};
    state.logs.forEach(l => { textureCounts[l.texture] = (textureCounts[l.texture] || 0) + 1; });

    const totalMapped = bristolLevels.reduce((sum, lvl) => {
      return sum + lvl.textures.reduce((s, t) => s + (textureCounts[t] || 0), 0);
    }, 0) || 1;

    const rows = bristolLevels.map(lvl => {
      const count = lvl.textures.reduce((s, t) => s + (textureCounts[t] || 0), 0);
      const pct   = Math.round((count / totalMapped) * 100);
      const isIdeal = lvl.num === 3 || lvl.num === 4;
      return `
        <div class="flex items-center gap-2 py-1.5" style="border-bottom:1px solid rgba(0,0,0,0.05)">
          <div class="w-6 text-center text-xs font-bold opacity-50">${lvl.num}</div>
          <div class="text-lg w-8 text-center">${lvl.icon}</div>
          <div class="flex-1 min-w-0">
            <div class="text-xs font-bold flex items-center gap-1">
              ${lvl.desc}
              ${isIdeal ? '<span class="text-xs px-1 rounded" style="background:rgba(16,185,129,0.15);color:#10b981">idÃ©al</span>' : ''}
            </div>
            <div class="w-full rounded-full overflow-hidden mt-1" style="height:4px;background:rgba(0,0,0,0.07)">
              <div style="width:${pct}%;height:100%;border-radius:99px;background:${lvl.color};transition:width .5s"></div>
            </div>
          </div>
          <div class="text-xs font-bold w-10 text-right" style="color:${count > 0 ? lvl.color : 'inherit'};opacity:${count > 0 ? 1 : 0.3}">
            ${count > 0 ? count + ' (' + pct + '%)' : 'â€”'}
          </div>
        </div>`;
    }).join('');

    el.innerHTML = `
      <div class="card p-4 rounded-[1.5rem]">
        <div class="font-bold mb-1 text-sm">ğŸ”¬ Ã‰chelle de Bristol</div>
        <div class="text-xs opacity-50 mb-3">Classification mÃ©dicale de tes ${state.logs.length} selles</div>
        ${rows}
        <div class="mt-3 p-2 rounded-xl text-xs text-center font-bold" style="background:rgba(16,185,129,0.1);color:#10b981">
          âœ… Types 3 et 4 = selles idÃ©ales selon la mÃ©decine
        </div>
      </div>`;
  }

  // ===================================================
  //  ANNIVERSAIRES DE CACAS ğŸ‚  (feature 18)
  // ===================================================
  function checkAnniversaries() {
    if (state.logs.length === 0) return null;
    const today = new Date();
    const todayMD = String(today.getMonth() + 1).padStart(2,'0') + '-' + String(today.getDate()).padStart(2,'0');
    const sorted  = [...state.logs].sort((a, b) => a.date - b.date);

    const milestones = [
      { count: 1,   emoji: 'â­', label: '1er caca enregistrÃ©' },
      { count: 10,  emoji: 'ğŸ…', label: '10Ã¨me caca' },
      { count: 50,  emoji: 'ğŸ¥ˆ', label: '50Ã¨me caca' },
      { count: 100, emoji: 'ğŸ’¯', label: '100Ã¨me caca' },
      { count: 200, emoji: 'ğŸ†', label: '200Ã¨me caca' },
      { count: 365, emoji: 'ğŸŒŸ', label: '365Ã¨me caca' },
    ];

    for (const m of milestones) {
      if (sorted.length < m.count) continue;
      const poopDate = new Date(sorted[m.count - 1].date);
      const poopMD   = String(poopDate.getMonth() + 1).padStart(2,'0') + '-' + String(poopDate.getDate()).padStart(2,'0');
      const yearsAgo = today.getFullYear() - poopDate.getFullYear();
      if (poopMD === todayMD && yearsAgo >= 1) {
        return { emoji: m.emoji, label: m.label, yearsAgo };
      }
    }
    return null;
  }

  // ===================================================
  //  TIMER DE SÃ‰ANCE â±ï¸
  // ===================================================
  let _timerStart   = null;
  let _timerInterval = null;

  function setupTimer() {
    $id('timer-btn')?.addEventListener('click', () => {
      if (_timerStart) {
        stopTimer(true); // annuler
      } else {
        startTimer();
      }
    });
    $id('timer-stop-btn')?.addEventListener('click', () => stopTimer(false));
  }

  function startTimer() {
    _timerStart = Date.now();
    $id('timer-overlay')?.classList.remove('hidden');
    const display = $id('timer-display');
    if (display) display.classList.remove('hidden');
    _timerInterval = setInterval(() => {
      const elapsed = Math.floor((Date.now() - _timerStart) / 1000);
      const m = String(Math.floor(elapsed / 60)).padStart(2,'0');
      const s = String(elapsed % 60).padStart(2,'0');
      const txt = `${m}:${s}`;
      if ($id('timer-display'))         $id('timer-display').textContent = txt;
      if ($id('timer-overlay-display')) $id('timer-overlay-display').textContent = txt;
    }, 1000);
  }

  function stopTimer(cancel = false) {
    if (!_timerStart) return;
    const elapsed = Math.floor((Date.now() - _timerStart) / 1000);
    clearInterval(_timerInterval);
    _timerInterval = null;
    _timerStart = null;
    $id('timer-overlay')?.classList.add('hidden');
    const display = $id('timer-display');
    if (display) { display.textContent = '00:00'; display.classList.add('hidden'); }

    if (!cancel && elapsed > 10) {
      const m = Math.floor(elapsed / 60);
      const s = elapsed % 60;
      const durationStr = m > 0 ? `${m}min ${s}s` : `${s}s`;
      // PrÃ©-remplir le commentaire et ouvrir le drawer
      openDrawer();
      setTimeout(() => {
        const commentEl = $id('comment');
        if (commentEl) commentEl.value = `â±ï¸ DurÃ©e : ${durationStr}`;
      }, 100);
    }
  }

  // ===================================================
  //  SERVICE WORKER
  // ===================================================
  function registerSW() {
    if (!('serviceWorker' in navigator)) return;

    // updateViaCache:'none' â†’ le navigateur ne met JAMAIS sw.js en cache HTTP
    // â†’ il dÃ©tecte toujours les nouvelles versions du SW
    navigator.serviceWorker.register('./sw.js', { updateViaCache: 'none' }).then(reg => {
      $debug('SW registered');

      // VÃ©rifier une mise Ã  jour immÃ©diatement au chargement
      reg.update();

      // Si un nouveau SW attend dÃ©jÃ  (rechargement aprÃ¨s update)
      if (reg.waiting) showUpdateBanner(reg.waiting);

      // Nouveau SW trouvÃ© â†’ attendre qu'il soit installÃ©
      reg.addEventListener('updatefound', () => {
        const newWorker = reg.installing;
        newWorker.addEventListener('statechange', () => {
          if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
            // Nouveau SW installÃ© et en attente â†’ montrer la banniÃ¨re
            showUpdateBanner(newWorker);
          }
        });
      });
    }).catch(e => $debug('SW err: ' + e.message));

    // Quand le SW actif change (aprÃ¨s SKIP_WAITING) â†’ recharger la page
    navigator.serviceWorker.addEventListener('controllerchange', () => {
      window.location.reload();
    });
  }

  function showUpdateBanner(worker) {
    const banner = $id('update-banner');
    if (!banner) return;
    banner.classList.remove('hidden');
    banner.addEventListener('click', () => {
      banner.textContent = 'â³ Mise Ã  jour en coursâ€¦';
      worker.postMessage('SKIP_WAITING');
    }, { once: true });
  }

  function showInstallBanner() {
    // iOS standalone check
    const isIos = /iphone|ipad|ipod/i.test(navigator.userAgent);
    const isStandalone = window.navigator.standalone === true;
    const dismissed = LS_OK && localStorage.getItem('install-dismissed');
    if (isIos && !isStandalone && !dismissed) {
      setTimeout(() => $id('install-banner')?.classList.remove('hidden'), 2000);
    }
  }

  // ===================================================
  //  PULL-TO-REFRESH  (feature 2)
  // ===================================================
  function setupPullToRefresh() {
    const main = document.querySelector('main');
    if (!main || !('ontouchstart' in window)) return;

    // Create indicator (injected into body, fixed at top)
    const indicator = document.createElement('div');
    indicator.id = 'ptr-indicator';
    indicator.className = 'hidden';
    indicator.textContent = 'â¬‡ï¸ Tire pour actualiser';
    document.body.appendChild(indicator);

    let startY = 0;
    let pulling = false;
    const THRESHOLD = 72;

    document.addEventListener('touchstart', e => {
      // Trigger only on social tab when scrolled to top
      const socialTab = $id('social-tab');
      if (!socialTab?.classList.contains('active')) return;
      if (window.scrollY > 5) return;
      startY = e.touches[0].clientY;
      pulling = true;
    }, { passive: true });

    document.addEventListener('touchmove', e => {
      if (!pulling) return;
      const dy = e.touches[0].clientY - startY;
      if (dy > 20) {
        indicator.classList.remove('hidden');
        indicator.textContent = dy > THRESHOLD ? 'ğŸ”„ RelÃ¢che pour actualiser' : 'â¬‡ï¸ Tire vers le bas';
        indicator.style.transform = `translateY(${Math.min(dy - 20, 40)}px)`;
      }
    }, { passive: true });

    document.addEventListener('touchend', e => {
      if (!pulling) return;
      const dy = e.changedTouches[0].clientY - startY;
      if (dy > THRESHOLD) {
        indicator.textContent = 'â³ Actualisationâ€¦';
        window.SocialModule?.renderSocialTab().then(() => {
          indicator.classList.add('hidden');
          indicator.style.transform = '';
        });
      } else {
        indicator.classList.add('hidden');
        indicator.style.transform = '';
      }
      pulling = false;
    }, { passive: true });
  }

  // ===================================================
  //  EVENTS
  // ===================================================
  function setupEvents() {
    $id('poop-btn').addEventListener('click', openDrawer);
    $id('cancel-drawer').addEventListener('click', closeDrawer);
    $id('save-poop').addEventListener('click', addPoop);
    $id('export-btn').addEventListener('click', exportData);
    $id('export-pdf-btn')?.addEventListener('click', exportMedicalPDF);

    // Pull-to-refresh sur le social tab (feature 2)
    setupPullToRefresh();

    // Offline â†’ online : vider la queue
    window.addEventListener('online', () => {
      $debug('ğŸŒ Connexion rÃ©tablie â€” traitement de la queue offlineâ€¦');
      processOfflineQueue();
    });
    $id('import-input').addEventListener('change', importData);
    $id('clear-btn').addEventListener('click', clearAll);

    // Close drawer on backdrop click
    $id('drawer-outer').addEventListener('click', e => {
      if (e.target === $id('drawer-outer')) closeDrawer();
    });

    // Tab buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => switchTab(btn.dataset.tab));
    });

    // Texture buttons
    document.querySelectorAll('.texture-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        selectedTexture = btn.dataset.texture;
        document.querySelectorAll('.texture-btn').forEach(b => b.classList.remove('border-amber-500', 'bg-amber-100', 'selected'));
        btn.classList.add('border-amber-500', 'bg-amber-100', 'selected');
        $id('texture-err')?.classList.add('hidden');
      });
    });

    // Color buttons
    document.querySelectorAll('.color-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        selectedColor = btn.dataset.color;
        document.querySelectorAll('.color-btn').forEach(b => b.style.transform = '');
        btn.style.transform = 'scale(1.25)';
        btn.style.outline = '3px solid var(--accent)';
        document.querySelectorAll('.color-btn').forEach(b => { if (b !== btn) b.style.outline = ''; });
        $id('color-err')?.classList.add('hidden');
      });
    });

    // Retro toggle
    $id('retro-chk').addEventListener('change', e => {
      $id('retro-date-wrap').classList.toggle('hidden', !e.target.checked);
      if (e.target.checked) refreshRetroMax();
    });

    // Theme dots (delegation â€” works for dynamically-added profile grid buttons too)
    document.addEventListener('click', e => {
      const btn = e.target.closest('[data-theme-btn]');
      if (!btn) return;
      const t = btn.dataset.themeBtn;
      applyTheme(t);
      state.theme = t;
      saveState(state);
    });

    // Install banner dismiss
    $id('dismiss-banner')?.addEventListener('click', () => {
      $id('install-banner').classList.add('hidden');
      if (LS_OK) localStorage.setItem('install-dismissed', '1');
    });

    // Swipe horizontal entre onglets (mobile)
    const _tabOrder = ['dashboard','stats','badges','admin','social'];
    let _swipeStartX = 0;
    document.querySelector('main')?.addEventListener('touchstart', e => {
      _swipeStartX = e.touches[0].clientX;
    }, { passive: true });
    document.querySelector('main')?.addEventListener('touchend', e => {
      const dx = e.changedTouches[0].clientX - _swipeStartX;
      if (Math.abs(dx) < 120) return;
      // Ne pas swiper si le drawer est ouvert
      if (!$id('drawer')?.classList.contains('hidden')) return;
      const current = document.querySelector('.tab-content.active')?.id?.replace('-tab','');
      const idx = _tabOrder.indexOf(current);
      if (dx < -120 && idx < _tabOrder.length - 1) switchTab(_tabOrder[idx + 1]);
      if (dx >  120 && idx > 0)                    switchTab(_tabOrder[idx - 1]);
    }, { passive: true });

    // Blague alÃ©atoire
    $id('random-joke-btn')?.addEventListener('click', () => window.JokesModule?.showRandomJoke());

    // User badge â†’ toujours ouvrir le profil modal (thÃ¨me + avatar + login si besoin)
    $id('user-badge')?.addEventListener('click', () => openProfileModal());

    // Social tab login button
    $id('social-login-btn')?.addEventListener('click', () => openAuthModal('login'));

    // Auth modal tabs
    $id('auth-tab-login')?.addEventListener('click', () => switchAuthTab('login'));
    $id('auth-tab-signup')?.addEventListener('click', () => switchAuthTab('signup'));

    // Auth guest
    $id('auth-guest-btn')?.addEventListener('click', closeAuthModal);

    // Auth submit (login)
    $id('auth-submit')?.addEventListener('click', async () => {
      const email = $id('auth-email').value.trim();
      const pass = $id('auth-password').value;
      if (!email || !pass) return;
      $id('auth-submit').textContent = 'â³ Connexionâ€¦';
      $id('auth-submit').disabled = true;
      try {
        await window.SupabaseClient.signIn(email, pass);
        closeAuthModal();
        await window.SocialModule?.afterLogin();
      } catch(e) {
        const err = $id('auth-error');
        err.textContent = e.message || 'Erreur de connexion';
        err.classList.remove('hidden');
      } finally {
        $id('auth-submit').textContent = 'Se connecter';
        $id('auth-submit').disabled = false;
      }
    });

    // Forgot password
    $id('forgot-password-btn')?.addEventListener('click', async () => {
      const email = $id('auth-email').value.trim();
      if (!email) { alert('Entre ton adresse email d\'abord.'); return; }
      const btn = $id('forgot-password-btn');
      btn.textContent = 'â³ Envoiâ€¦';
      btn.disabled = true;
      try {
        await window.SupabaseClient.resetPassword(email);
        alert('ğŸ“§ Email envoyÃ© ! VÃ©rifie ta boÃ®te mail pour rÃ©initialiser ton mot de passe.');
        closeAuthModal();
      } catch(e) {
        alert('Erreur : ' + e.message);
      } finally {
        btn.textContent = 'Mot de passe oubliÃ© ?';
        btn.disabled = false;
      }
    });

    // Nouveau mot de passe (retour du lien de reset)
    $id('new-password-submit')?.addEventListener('click', async () => {
      const pwd     = $id('new-password-input').value;
      const confirm = $id('new-password-confirm').value;
      const errEl   = $id('new-password-error');
      errEl.classList.add('hidden');
      if (pwd.length < 6) {
        errEl.textContent = 'Mot de passe trop court (min. 6 caractÃ¨res)';
        errEl.classList.remove('hidden'); return;
      }
      if (pwd !== confirm) {
        errEl.textContent = 'Les mots de passe ne correspondent pas';
        errEl.classList.remove('hidden'); return;
      }
      const btn = $id('new-password-submit');
      btn.textContent = 'â³ Enregistrementâ€¦'; btn.disabled = true;
      try {
        await window.SupabaseClient.updatePassword(pwd);
        $id('new-password-modal').classList.add('hidden');
        alert('âœ… Mot de passe modifiÃ© avec succÃ¨s !');
      } catch(e) {
        errEl.textContent = 'Erreur : ' + e.message;
        errEl.classList.remove('hidden');
      } finally {
        btn.textContent = 'Enregistrer le mot de passe'; btn.disabled = false;
      }
    });

    // Signup submit
    $id('signup-submit')?.addEventListener('click', async () => {
      const username = $id('signup-username').value.trim();
      const email = $id('signup-email').value.trim();
      const pass = $id('signup-password').value;
      const avatar = document.querySelector('.avatar-opt.selected')?.dataset.avatar || 'ğŸ’©';
      if (!username || !email || !pass) return;
      $id('signup-submit').textContent = 'â³ CrÃ©ationâ€¦';
      $id('signup-submit').disabled = true;
      try {
        await window.SupabaseClient.signUp(email, pass, username, avatar);
        closeAuthModal();
        await window.SocialModule?.afterLogin();
      } catch(e) {
        const err = $id('signup-error');
        err.textContent = e.message || 'Erreur Ã  la crÃ©ation du compte';
        err.classList.remove('hidden');
      } finally {
        $id('signup-submit').textContent = 'CrÃ©er mon compte';
        $id('signup-submit').disabled = false;
      }
    });

    // Mood picker
    document.querySelectorAll('.mood-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const mood = btn.dataset.mood;
        if (selectedMood === mood) {
          // DÃ©sÃ©lectionner si on reclique
          selectedMood = null;
          document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('border-amber-400','bg-amber-50'));
        } else {
          selectedMood = mood;
          document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('border-amber-400','bg-amber-50'));
          btn.classList.add('border-amber-400','bg-amber-50');
        }
      });
    });

    // Avatar picker
    document.querySelectorAll('.avatar-opt').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.avatar-opt').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
      });
    });

    // Profile modal
    $id('close-profile-modal')?.addEventListener('click', closeProfileModal);
    $id('signout-btn')?.addEventListener('click', async () => {
      await window.SupabaseClient?.signOut();
      updateUserBadge(null);
      closeProfileModal();
      renderAll();
      $debug('ğŸšª signed out');
    });
    $id('profile-login-btn')?.addEventListener('click', () => {
      closeProfileModal();
      openAuthModal('login');
    });
    $id('sync-cloud-btn')?.addEventListener('click', async () => {
      const btn = $id('sync-cloud-btn');
      const errDiv = $id('sync-error-msg');
      btn.textContent = 'â³ Synchronisationâ€¦';
      if (errDiv) errDiv.classList.add('hidden');
      try {
        await window.SupabaseClient.syncLocalToCloud(state.logs);
        btn.textContent = 'âœ… SynchronisÃ© !';
        setTimeout(() => { btn.textContent = 'â˜ï¸ Synchroniser mes donnÃ©es'; }, 3000);
      } catch(e) {
        btn.textContent = 'âŒ Erreur sync';
        if (errDiv) { errDiv.textContent = e.message || 'Erreur inconnue'; errDiv.classList.remove('hidden'); }
        setTimeout(() => { btn.textContent = 'â˜ï¸ Synchroniser mes donnÃ©es'; if (errDiv) errDiv.classList.add('hidden'); }, 6000);
      }
    });

    // â”€â”€ QR Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    $id('close-qr-modal')?.addEventListener('click', () => $id('qr-modal').classList.add('hidden'));
    $id('qr-modal')?.addEventListener('click', e => { if (e.target === $id('qr-modal')) $id('qr-modal').classList.add('hidden'); });

    // â”€â”€ Avatar picker (profile modal) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const AVATARS = ['ğŸ’©','ğŸ»','ğŸ¦Š','ğŸ¼','ğŸ±','ğŸ¶','ğŸ¸','ğŸ·','ğŸ®','ğŸ¦','ğŸ¯','ğŸ»â€â„ï¸','ğŸ¦„','ğŸ™','ğŸ¦‹','ğŸŒ¸','ğŸŒ™','â­','ğŸŒˆ','ğŸ€','ğŸ‘‘','ğŸ¦','ğŸ¸','ğŸ§','ğŸŒº','ğŸ¦©','ğŸ¢','ğŸ¦€','ğŸ§¸','ğŸ­'];
    const avatarGrid = $id('avatar-picker-grid');
    if (avatarGrid) {
      avatarGrid.innerHTML = AVATARS.map(a => `
        <button class="profile-avatar-opt w-10 h-10 rounded-[0.75rem] flex items-center justify-center text-xl hover:scale-110 transition-transform"
          data-av="${a}" style="background:color-mix(in srgb,var(--accent) 8%,transparent)">${a}</button>`
      ).join('');
      avatarGrid.querySelectorAll('.profile-avatar-opt').forEach(btn => {
        btn.addEventListener('click', async () => {
          const av = btn.dataset.av;
          avatarGrid.querySelectorAll('.profile-avatar-opt').forEach(b =>
            b.style.outline = b.dataset.av === av ? '2px solid var(--accent)' : 'none');
          $id('profile-avatar-display').textContent = av;
          $id('user-avatar').textContent = av;
          if (window.SupabaseClient?.isLoggedIn()) {
            try { await window.SupabaseClient.updateProfile({ avatar: av }); } catch(e) {}
          }
        });
      });
    }

    // â”€â”€ Theme picker (profile modal) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const ALL_THEMES = [
      { id:'default',   label:'Chaud ğŸŸ ',       grad:'linear-gradient(135deg,#d97706,#ea580c)' },
      { id:'dark',      label:'Dark ğŸŒ™',         grad:'linear-gradient(135deg,#1e1b4b,#312e81)' },
      { id:'medical',   label:'MÃ©dical ğŸ©º',      grad:'linear-gradient(135deg,#059669,#0284c7)' },
      { id:'kawaii',    label:'Kawaii ğŸŒ¸',        grad:'linear-gradient(135deg,#e91e8c,#9c27b0)' },
      { id:'foret',     label:'ForÃªt ğŸŒ¿',         grad:'linear-gradient(135deg,#2e7d32,#558b2f)' },
      { id:'ocean',     label:'OcÃ©an ğŸŒŠ',         grad:'linear-gradient(135deg,#0277bd,#00838f)' },
      { id:'sunset',    label:'Sunset ğŸŒ…',        grad:'linear-gradient(135deg,#ff6b6b,#c77dff)' },
      { id:'galaxy',    label:'Galaxy ğŸŒŒ',        grad:'linear-gradient(135deg,#6a0572,#3a0ca3)' },
      { id:'sakura',    label:'Sakura ğŸŒ¸',        grad:'linear-gradient(135deg,#e91e8c,#ff6b9d)' },
      { id:'mint',      label:'Mint ğŸŒ¿',          grad:'linear-gradient(135deg,#00b894,#00cec9)' },
      { id:'lavande',   label:'Lavande ğŸ’œ',       grad:'linear-gradient(135deg,#7c3aed,#9d4edd)' },
      { id:'rose-gold', label:'Rose Gold ğŸŒ¹',     grad:'linear-gradient(135deg,#c97b6a,#e0a87c)' },
      { id:'tropicale', label:'Tropicale ğŸŒ´',     grad:'linear-gradient(135deg,#00b8a9,#0097a7)' },
      { id:'nordique',  label:'Nordique â„ï¸',      grad:'linear-gradient(135deg,#2c5f8a,#3a7bd5)' },
      { id:'automne',   label:'Automne ğŸ‚',       grad:'linear-gradient(135deg,#b45309,#c2410c)' },
      { id:'neon',      label:'Neon âš¡',           grad:'linear-gradient(135deg,#00ff88,#00e5cc)' },
    ];
    const themeGrid = $id('profile-theme-grid');
    if (themeGrid) {
      themeGrid.innerHTML = ALL_THEMES.map(t => `
        <button class="profile-theme-btn rounded-[0.75rem] p-2 text-xs font-bold text-white text-center leading-tight hover:scale-105 transition-transform"
          data-theme-btn="${t.id}" style="background:${t.grad};min-height:52px;box-shadow:0 2px 8px #0002"
          title="${t.label}">${t.label}</button>`
      ).join('');
    }

    // Notifications settings
    setupNotifications();
  }

  // ===================================================
  //  NOTIFICATIONS
  // ===================================================
  function setupNotifications() {
    const toggle    = $id('notif-toggle');
    const threshold = $id('notif-threshold');
    const permBtn   = $id('notif-permission-btn');
    const statusEl  = $id('notif-status');
    if (!toggle) return;

    // Charger Ã©tat sauvÃ©
    toggle.checked       = localStorage.getItem('notifEnabled') === 'true';
    threshold.value      = localStorage.getItem('notifThreshold') || '24';

    function updatePermStatus() {
      if (!('Notification' in window)) {
        if (statusEl) statusEl.textContent = 'âš ï¸ Notifications non supportÃ©es par ce navigateur';
        if (permBtn) permBtn.classList.add('hidden');
        return;
      }
      const p = Notification.permission;
      if (p === 'granted') {
        if (permBtn) permBtn.classList.add('hidden');
        if (statusEl) statusEl.textContent = 'âœ… Notifications autorisÃ©es';
      } else if (p === 'denied') {
        if (permBtn) permBtn.classList.add('hidden');
        if (statusEl) statusEl.textContent = 'ğŸš« Notifications bloquÃ©es â€” Ã  autoriser dans les rÃ©glages du navigateur';
      } else {
        if (permBtn) permBtn.classList.remove('hidden');
        if (statusEl) statusEl.textContent = 'En attente d\'autorisation';
      }
    }
    updatePermStatus();

    toggle.addEventListener('change', () => {
      localStorage.setItem('notifEnabled', toggle.checked);
    });
    threshold.addEventListener('change', () => {
      localStorage.setItem('notifThreshold', threshold.value);
    });
    permBtn?.addEventListener('click', async () => {
      if (!('Notification' in window)) return;
      const result = await Notification.requestPermission();
      updatePermStatus();
      if (result === 'granted' && toggle.checked) checkPoopNotification();
    });
  }

  function checkPoopNotification() {
    if (!('Notification' in window)) return;
    if (Notification.permission !== 'granted') return;
    if (localStorage.getItem('notifEnabled') !== 'true') return;

    const lastPoop   = parseInt(localStorage.getItem('notifLastPoopTime') || '0');
    if (!lastPoop) return; // Jamais eu de caca enregistrÃ©
    const threshold  = parseInt(localStorage.getItem('notifThreshold') || '24');
    const thresholdMs = threshold * 60 * 60 * 1000;
    // Ne pas rÃ©pÃ©ter la notif plus d'une fois toutes les 4h
    const lastNotif  = parseInt(localStorage.getItem('notifLastSent') || '0');
    if (Date.now() - lastNotif < 4 * 60 * 60 * 1000) return;

    if (Date.now() - lastPoop > thresholdMs) {
      const username = window.SupabaseClient?.getCurrentProfile()?.username || '';
      const greeting = username ? `, tout va bien ${username}` : ', tout va bien';
      new Notification('ğŸ’© Caca-Tracker', {
        body: `Ã‡a fait ${threshold}h sans caca${greeting} ? ğŸ’©`,
        icon: './favicon.svg',
        badge: './favicon.svg',
        tag: 'caca-reminder'
      });
      localStorage.setItem('notifLastSent', Date.now());
    }
  }

  // ===================================================
  //  RAPPEL INTELLIGENT
  // ===================================================
  function renderSmartReminder() {
    const el = $id('smart-reminder-banner');
    if (!el) return;

    const realLogs = state.logs.filter(l => !l.isRetro);
    if (realLogs.length < 5) { el.classList.add('hidden'); return; }

    // Heure moyenne des cacas
    const avgHour = Math.round(
      realLogs.map(l => new Date(l.date).getHours()).reduce((a, b) => a + b, 0) / realLogs.length
    );

    const today = new Date().toDateString();
    const poopedToday = realLogs.some(l => new Date(l.date).toDateString() === today);
    const nowHour = new Date().getHours();

    if (!poopedToday && nowHour >= avgHour) {
      const diff = nowHour - avgHour;
      const msg = diff === 0
        ? `â° C'est gÃ©nÃ©ralement ton heure de caca (vers ${avgHour}h) !`
        : `â° Tu cacas gÃ©nÃ©ralement vers ${avgHour}h â€” Ã§a fait ${diff}h que tu attendsâ€¦ ğŸ‘€`;
      el.innerHTML = msg;
      el.classList.remove('hidden');

      // Notification intelligente (1 fois par jour)
      if ('Notification' in window && Notification.permission === 'granted' && localStorage.getItem('notifEnabled') === 'true') {
        const lastSmartNotif = parseInt(localStorage.getItem('notifSmartLastSent') || '0');
        const todayStart = new Date(); todayStart.setHours(0, 0, 0, 0);
        if (lastSmartNotif < todayStart.getTime()) {
          new Notification('â° Caca-Tracker', {
            body: `Tu cacas gÃ©nÃ©ralement vers ${avgHour}h â€” pas encore de caca aujourd'hui ! ğŸ’©`,
            icon: './favicon.svg',
            tag: 'smart-reminder'
          });
          localStorage.setItem('notifSmartLastSent', Date.now());
        }
      }
    } else {
      el.classList.add('hidden');
    }
  }

  // ===================================================
  //  RÃ‰SUMÃ‰ DE LA SEMAINE ğŸ“Š
  // ===================================================
  function renderWeekSummary() {
    const el      = $id('week-summary');
    const trendEl = $id('week-trend');
    if (!el) return;

    const now = new Date();
    const dow = now.getDay() === 0 ? 6 : now.getDay() - 1; // 0=Lun, 6=Dim
    const monday = new Date(now); monday.setDate(now.getDate() - dow); monday.setHours(0,0,0,0);
    const lastMonday = new Date(monday); lastMonday.setDate(monday.getDate() - 7);
    const lastSunday = new Date(monday); lastSunday.setDate(monday.getDate() - 1); lastSunday.setHours(23,59,59,999);

    const thisWeek = state.logs.filter(l => l.date >= monday.getTime());
    const lastWeek = state.logs.filter(l => l.date >= lastMonday.getTime() && l.date <= lastSunday.getTime());

    const days = {};
    thisWeek.forEach(l => { const d = new Date(l.date).toDateString(); days[d] = (days[d]||0) + 1; });
    const bestDay = Math.max(0, ...Object.values(days));

    const tw = thisWeek.length, lw = lastWeek.length;
    if (trendEl) trendEl.textContent = lw === 0 ? '' : tw > lw ? 'ğŸ“ˆ' : tw < lw ? 'ğŸ“‰' : 'â¡ï¸';

    el.innerHTML = `
      <div class="rounded-[1.25rem] py-3 px-2" style="background:color-mix(in srgb,var(--accent) 10%,transparent)">
        <div class="text-2xl font-bold" style="color:var(--accent)">${tw}</div>
        <div class="text-[11px] opacity-60">Cette semaine</div>
      </div>
      <div class="rounded-[1.25rem] py-3 px-2" style="background:rgba(0,0,0,0.05)">
        <div class="text-2xl font-bold opacity-50">${lw}</div>
        <div class="text-[11px] opacity-60">Sem. derniÃ¨re</div>
      </div>
      <div class="rounded-[1.25rem] py-3 px-2" style="background:rgba(0,0,0,0.05)">
        <div class="text-2xl font-bold">${bestDay}</div>
        <div class="text-[11px] opacity-60">Meilleur jour</div>
      </div>`;
  }

  // ===================================================
  //  RAPPEL Ã€ HEURE FIXE â°
  // ===================================================
  function setupCustomReminder() {
    const timeInput = $id('custom-reminder-time');
    const enabledCb = $id('custom-reminder-enabled');
    if (!timeInput || !enabledCb) return;
    timeInput.value   = localStorage.getItem('customReminderTime') || '20:00';
    enabledCb.checked = localStorage.getItem('customReminderEnabled') === 'true';
    timeInput.addEventListener('change', () => localStorage.setItem('customReminderTime', timeInput.value));
    enabledCb.addEventListener('change', () => localStorage.setItem('customReminderEnabled', enabledCb.checked));
  }

  function checkCustomReminder() {
    if (localStorage.getItem('customReminderEnabled') !== 'true') return;
    if (!('Notification' in window) || Notification.permission !== 'granted') return;
    const [h, m] = (localStorage.getItem('customReminderTime') || '20:00').split(':').map(Number);
    const now = new Date();
    if (now.getHours() !== h || now.getMinutes() !== m) return;
    const lastSent = parseInt(localStorage.getItem('customReminderLastSent') || '0');
    if (Date.now() - lastSent < 60000) return;
    const today = now.toDateString();
    if (state.logs.some(l => new Date(l.date).toDateString() === today)) return;
    const label = m > 0 ? `${h}h${String(m).padStart(2,'0')}` : `${h}h`;
    new Notification('â° Caca-Tracker', {
      body: `Il est ${label} et pas encore de caca aujourd'hui ! ğŸ’©`,
      icon: './favicon.svg', tag: 'custom-reminder'
    });
    localStorage.setItem('customReminderLastSent', Date.now());
  }

  // ===================================================
  //  EXPORT iCal ğŸ“…
  // ===================================================
  function exportIcal() {
    if (!state.logs.length) { alert('Aucun caca Ã  exporter !'); return; }
    const lines = ['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//Caca-Tracker//FR','CALSCALE:GREGORIAN','METHOD:PUBLISH'];
    state.logs.forEach((log, i) => {
      const dt = new Date(log.date);
      const stamp = dt.toISOString().replace(/[-:.]/g, '').slice(0, 15) + 'Z';
      lines.push(
        'BEGIN:VEVENT',
        `UID:poop-${log.id || i}@caca-tracker`,
        `DTSTAMP:${stamp}`,
        `DTSTART:${stamp}`,
        `DTEND:${stamp}`,
        `SUMMARY:ğŸ’© Caca (${log.texture || ''} ${log.color || ''})`.trim(),
        `DESCRIPTION:${(log.comment || '').replace(/[\n\r]/g, '\\n')}`,
        'END:VEVENT'
      );
    });
    lines.push('END:VCALENDAR');
    const blob = new Blob([lines.join('\r\n')], { type: 'text/calendar;charset=utf-8' });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href = url; a.download = 'cacas-clemence.ics'; a.click();
    URL.revokeObjectURL(url);
  }

  // ===================================================
  //  PARTAGER L'APPLICATION ğŸ”—
  // ===================================================
  window.shareApp = async function() {
    const url      = window.location.origin + window.location.pathname;
    const feedback = $id('share-app-feedback');
    // Web Share API (iOS / Android natif)
    if (navigator.share) {
      try {
        await navigator.share({ title: 'Caca-Tracker 3000 Deluxe ğŸ’©', text: 'ğŸ’© Rejoins-moi sur Caca-Tracker !', url });
        return;
      } catch(e) { /* annulÃ© par l'utilisateur */ }
    }
    // Fallback : copier dans le presse-papier
    try {
      await navigator.clipboard.writeText(url);
      if (feedback) {
        feedback.textContent = 'âœ… Lien copiÃ© ! Partage-le par SMS, WhatsApp, mailâ€¦';
        feedback.classList.remove('hidden');
        setTimeout(() => feedback.classList.add('hidden'), 4000);
      }
    } catch(e) {
      if (feedback) { feedback.textContent = url; feedback.classList.remove('hidden'); }
    }
  };

  // ===================================================
  //  DÃ‰FI STREAK 7 JOURS ğŸ¯
  // ===================================================
  function renderStreakChallenge() {
    const streak = calculateStreak();
    const goal   = 7;
    const pct    = Math.min(100, Math.round((streak / goal) * 100));

    const bar   = $id('streak-challenge-bar');
    const label = $id('streak-challenge-label');
    const badge = $id('streak-challenge-badge');
    const msg   = $id('streak-challenge-msg');
    if (!bar) return;

    bar.style.width = pct + '%';
    label.textContent = streak + '/' + goal;

    if (streak >= goal) {
      badge.classList.remove('hidden');
      msg.textContent = 'ğŸ‰ Incroyable ! DÃ©fi relevÃ© ! Continue comme Ã§a !';
      bar.style.background = 'linear-gradient(90deg,#f59e0b,#ef4444)';
    } else {
      badge.classList.add('hidden');
      const left = goal - streak;
      msg.textContent = left === 1
        ? 'ğŸ”¥ Plus qu\'un jour â€” tu y es presque !'
        : `ğŸ’ª Encore ${left} jour${left > 1 ? 's' : ''} pour complÃ©ter le dÃ©fi !`;
      bar.style.background = streak >= 4 ? 'linear-gradient(90deg,var(--accent),#f59e0b)' : 'var(--accent)';
    }
  }

  // Auth modal helpers
  function openAuthModal(tab = 'login') {
    $id('auth-modal').classList.remove('hidden');
    switchAuthTab(tab);
  }
  function closeAuthModal() { $id('auth-modal').classList.add('hidden'); }
  function openProfileModal() {
    if (window.SocialModule) {
      window.SocialModule.openProfileModal();
    } else {
      $id('profile-modal').classList.remove('hidden');
    }
    // Sync Ã©tat du toggle mode nuit
    setTimeout(applyAutoNight, 50);
  }
  function closeProfileModal() { $id('profile-modal').classList.add('hidden'); }

  function switchAuthTab(tab) {
    const isLogin = tab === 'login';
    $id('form-login').classList.toggle('hidden', !isLogin);
    $id('form-signup').classList.toggle('hidden', isLogin);
    $id('auth-tab-login').style.borderColor = isLogin ? 'var(--accent)' : 'transparent';
    $id('auth-tab-login').style.color = isLogin ? 'var(--accent)' : '';
    $id('auth-tab-login').style.opacity = isLogin ? '1' : '0.6';
    $id('auth-tab-signup').style.borderColor = !isLogin ? 'var(--accent)' : 'transparent';
    $id('auth-tab-signup').style.color = !isLogin ? 'var(--accent)' : '';
    $id('auth-tab-signup').style.opacity = !isLogin ? '1' : '0.6';
  }

  function updateUserBadge(profile) {
    const avatar = $id('user-avatar');
    const name = $id('user-name');
    if (profile) {
      if (avatar) avatar.textContent = profile.avatar || 'ğŸ‘¤';
      if (name) name.textContent = profile.username || 'Moi';
    } else {
      if (avatar) avatar.textContent = 'ğŸ‘¤';
      if (name) name.textContent = 'Connexion';
    }
    // Lien admin visible uniquement pour les admins
    const adminLink = $id('admin-link');
    if (adminLink) adminLink.classList.toggle('hidden', !profile?.is_admin);
    // Superman icon for admins
    const heroEl = $id('admin-hero');
    if (heroEl) heroEl.classList.toggle('hidden', !profile?.is_admin);
  }
  window.updateUserBadge = updateUserBadge;

  // ===================================================
  //  THEME
  // ===================================================
  function applyTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme === 'default' ? '' : theme);
    const metaColor = {
      default:'#d97706', dark:'#1e1b4b', medical:'#059669',
      kawaii:'#e91e8c', foret:'#2e7d32', ocean:'#0277bd',
      sunset:'#ff6b6b', galaxy:'#6a0572', sakura:'#e91e8c',
      mint:'#00b894', lavande:'#7c3aed', 'rose-gold':'#c97b6a',
      tropicale:'#00b8a9', nordique:'#2c5f8a', automne:'#b45309', neon:'#00ff88'
    };
    $id('theme-color-meta').setAttribute('content', metaColor[theme] || '#d97706');

    // Update active dot
    document.querySelectorAll('[data-theme-btn]').forEach(b => {
      b.classList.toggle('selected', b.dataset.themeBtn === theme);
    });

    // Drawer bg selon le thÃ¨me
    const drawerBg = {
      dark:'#1e1b4b', medical:'#f0fdf4', kawaii:'#fce4ec',
      foret:'#f1f8e9', ocean:'#e0f7fa', sunset:'#ffd6a5',
      galaxy:'#0d0221', sakura:'#ffb7c5', mint:'#c8f7c5',
      lavande:'#e6d9f7', 'rose-gold':'#f9e4e8', tropicale:'#b3ffec',
      nordique:'#dce8f5', automne:'#fde8c8', neon:'#000000'
    };
    const drawerInner = $id('drawer-inner');
    if (drawerInner) drawerInner.style.background = drawerBg[theme] || '';
  }

  // ===================================================
  //  MODE NUIT AUTO ğŸŒ™
  // ===================================================
  function applyAutoNight() {
    const enabled = localStorage.getItem('autoNightMode') === 'true';
    const knob = $id('auto-night-knob');
    const btn  = $id('auto-night-toggle');
    if (btn) {
      btn.style.background = enabled ? '#4f46e5' : 'rgba(0,0,0,0.15)';
      if (knob) knob.style.transform = enabled ? 'translateX(20px)' : 'translateX(0)';
    }
    if (!enabled) return;
    const h = new Date().getHours();
    const isNight = h >= 22 || h < 7;
    if (isNight) {
      document.documentElement.setAttribute('data-theme', 'dark');
    } else {
      applyTheme(state.theme || 'default');
    }
  }

  window.toggleAutoNight = function() {
    const current = localStorage.getItem('autoNightMode') === 'true';
    localStorage.setItem('autoNightMode', !current);
    applyAutoNight();
  };

  // ===================================================
  //  STICKY HEADER ğŸ“Œ
  // ===================================================
  function applyStickyHeader() {
    const isSticky = localStorage.getItem('stickyHeader') !== 'false';
    const hdr = document.querySelector('header.app-header');
    if (hdr) {
      if (isSticky) { hdr.classList.add('sticky','top-0','z-50'); hdr.classList.remove('relative'); }
      else { hdr.classList.remove('sticky','top-0','z-50'); hdr.classList.add('relative'); }
    }
    const btn  = $id('sticky-header-toggle');
    const knob = $id('sticky-header-knob');
    if (btn)  btn.style.background  = isSticky ? '#4f46e5' : 'rgba(0,0,0,0.15)';
    if (knob) knob.style.transform  = isSticky ? 'translateX(20px)' : 'translateX(0)';
  }

  window.toggleStickyHeader = function() {
    const isSticky = localStorage.getItem('stickyHeader') !== 'false';
    localStorage.setItem('stickyHeader', String(!isSticky));
    applyStickyHeader();
  };

  // ===================================================
  //  TABS
  // ===================================================
  function switchTab(name) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    $id(name + '-tab')?.classList.add('active');
    document.querySelector(`.tab-btn[data-tab="${name}"]`)?.classList.add('active');
    if (name === 'stats') renderStats();
    if (name === 'badges') updateBadges();
    if (name === 'admin') renderHistory();
    if (name === 'dashboard') renderDashboard();
    if (name === 'social') window.SocialModule?.renderSocialTab();
    if (name === 'settings') { setupNotifications(); setupCustomReminder(); applyStickyHeader(); }
  }

  // ===================================================
  //  DRAWER
  // ===================================================
  function openDrawer() {
    refreshRetroMax();
    $id('drawer').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  }

  function closeDrawer() {
    $id('drawer').classList.add('hidden');
    document.body.style.overflow = '';
    // Reset
    $id('comment').value = '';
    selectedTexture = null;
    selectedColor   = null;
    selectedMood    = null;
    document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('border-amber-400','bg-amber-50'));
    $id('retro-chk').checked = false;
    $id('retro-date-wrap').classList.add('hidden');
    document.querySelectorAll('.texture-btn').forEach(b => b.classList.remove('border-amber-500', 'bg-amber-100', 'selected'));
    document.querySelectorAll('.color-btn').forEach(b => { b.style.transform = ''; b.style.outline = ''; });
    $id('texture-err')?.classList.add('hidden');
    $id('color-err')?.classList.add('hidden');
  }

  function refreshRetroMax() {
    const inp = $id('retro-date');
    if (!inp) return;
    // "now" in local timezone for datetime-local input
    const now = new Date();
    const offset = now.getTimezoneOffset() * 60000;
    const localIso = new Date(now - offset).toISOString().slice(0, 16);
    inp.max = localIso;
    if (!inp.value) inp.value = localIso;
  }

  // ===================================================
  //  ADD POOP
  // ===================================================
  function addPoop() {
    let valid = true;
    if (!selectedTexture) { $id('texture-err')?.classList.remove('hidden'); valid = false; }
    if (!selectedColor) { $id('color-err')?.classList.remove('hidden'); valid = false; }
    if (!valid) return;

    let timestamp = Date.now();
    const isRetro = $id('retro-chk').checked;

    if (isRetro) {
      const retroVal = $id('retro-date').value;
      if (!retroVal) { alert('Indique une date/heure !'); return; }
      const retroTs = new Date(retroVal).getTime();
      if (isNaN(retroTs)) { alert('Date invalide !'); return; }
      if (retroTs > Date.now() + 60000) { alert('La date ne peut pas Ãªtre dans le futur !'); return; }
      timestamp = retroTs;
    }

    const poop = {
      id: Date.now() + Math.random(),
      date: timestamp,
      texture: selectedTexture,
      color: selectedColor,
      comment: $id('comment').value.trim(),
      isRetro: isRetro,
      mood: selectedMood || null,
      updated_at: Date.now()
    };

    state.logs.push(poop);
    state.logs.sort((a, b) => b.date - a.date);
    if (state.logs.length > 2000) state.logs = state.logs.slice(0, 2000);
    saveState(state);

    closeDrawer();
    renderAll();

    // Son selon la texture
    if (!isRetro && typeof soundManager !== 'undefined') {
      soundManager.playPoopAdded(poop.texture);
    }

    // Modules v2.0
    if (!isRetro) {
      if (typeof celebratePoopAdded === 'function') {
        celebratePoopAdded(calculateStreak());
      } else {
        showConfetti();
      }
    }
    if (typeof achievementManager !== 'undefined') {
      achievementManager.checkAchievements(state.logs).forEach(a => achievementManager.showAchievementPopup(a));
    }

    // Sync cloud si connectÃ©
    if (window.SupabaseClient?.isLoggedIn()) {
      if (navigator.onLine) {
        window.SupabaseClient.savePoopCloud(poop).catch(e => $debug('cloud save err: ' + e.message));
      } else {
        // Hors ligne â†’ mettre en queue
        try {
          const queue = JSON.parse(localStorage.getItem('cacaTracker.offlineQueue') || '[]');
          queue.push({ type: 'add', poop });
          localStorage.setItem('cacaTracker.offlineQueue', JSON.stringify(queue));
          $debug('ğŸ“¥ Hors ligne â€” caca mis en queue (sync au retour)');
        } catch(e) { $debug('queue err: ' + e.message); }
      }
    }

    // Notifications : mettre Ã  jour l'heure du dernier caca
    if (!isRetro) localStorage.setItem('notifLastPoopTime', Date.now());

    $debug('â• ' + poop.texture + '/' + poop.color + (isRetro ? ' [rÃ©tro ' + new Date(timestamp).toLocaleString('fr') + ']' : ''));
  }

  // ===================================================
  //  RENDER ALL
  // ===================================================
  function renderAll() {
    renderDashboard();
    renderHistory();
    updateStreakBadge();
    updateBadges();
  }

  // ===================================================
  //  DASHBOARD
  // ===================================================
  function renderDashboard() {
    const today = new Date().toDateString();
    const todayCount = state.logs.filter(l => new Date(l.date).toDateString() === today).length;
    $id('today-count').textContent = todayCount;
    $id('total-count').textContent = state.logs.length;
    $id('mass').textContent = (state.logs.length * 0.15).toFixed(1) + ' kg';
    updateChart();
    updateGoalUI(parseInt(localStorage.getItem('dailyGoal') || '1'));

    // Tendances de santÃ© (feature 10)
    checkHealthTrends();

    // Rappel intelligent
    renderSmartReminder();

    // DÃ©fi streak
    renderStreakChallenge();

    // RÃ©sumÃ© semaine
    renderWeekSummary();

    // Anniversaires
    const anniv = checkAnniversaries();
    const annivEl = $id('anniversary-banner');
    if (annivEl) {
      if (anniv) {
        annivEl.innerHTML = `<div class="text-3xl mb-1">${anniv.emoji}</div>
          <div class="font-bold">Anniversaire !</div>
          <div class="text-sm mt-1 opacity-90">Il y a exactement ${anniv.yearsAgo} an${anniv.yearsAgo > 1 ? 's' : ''}, c'Ã©tait ton <strong>${anniv.label}</strong> ! ğŸ‚</div>`;
        annivEl.classList.remove('hidden');
      } else {
        annivEl.classList.add('hidden');
      }
    }

    // Blague du jour
    window.JokesModule?.displayDailyJoke();

    // PrÃ©diction
    const predEl = $id('prediction-text');
    if (predEl && typeof PredictionEngine !== 'undefined') {
      if (state.logs.length >= 2) {
        try {
          const pred = new PredictionEngine(state.logs).predictNextPoop();
          predEl.textContent = (pred.icon || 'ğŸ”®') + ' ' + pred.message;
        } catch(e) { predEl.textContent = 'ğŸ”® PrÃ©diction indisponible'; }
      } else {
        predEl.textContent = 'ğŸ”® Ajoute au moins 2 cacas pour une prÃ©dictionâ€¦';
      }
    }
  }

  // ===================================================
  //  HISTORY
  // ===================================================
  function renderHistory() {
    const list = $id('history-list');
    const recent = state.logs.slice(0, 20);
    if (!recent.length) {
      list.innerHTML = `<div class="text-center py-12 opacity-60">
        <div class="text-5xl mb-3">ğŸ“­</div>
        <div class="font-bold text-lg">Aucun caca enregistrÃ©</div>
        <div class="text-sm">ClÃ©mence, c'est le moment !</div>
      </div>`;
      return;
    }
    list.innerHTML = recent.map((log, i) => {
      const dt = new Date(log.date).toLocaleString('fr-FR', {weekday:'short',day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'});
      const icon = textureEmoji(log.texture);
      const retroTag = log.isRetro ? `<span class="text-xs bg-purple-100 text-purple-600 px-2 py-0.5 rounded-full ml-1 font-bold">âª retard</span>` : '';
      const note = (log.mood ? `<span class="text-xs px-2 py-0.5 rounded-full mr-1" style="background:color-mix(in srgb,var(--accent) 12%,transparent)">${{normal:'ğŸ˜Š',douloureux:'ğŸ˜«',urgent:'âš¡',difficile:'ğŸ˜´'}[log.mood] || ''} ${log.mood}</span>` : '') + (log.comment ? `<div class="text-xs mt-1 bg-amber-100 text-amber-800 px-2 py-1 rounded-xl">${esc(log.comment)}</div>` : '');
      return `<div class="card flex items-center gap-3 p-4 rounded-[1.5rem] shadow">
        <div class="w-12 h-12 rounded-[1rem] flex items-center justify-center text-2xl flex-shrink-0"
          style="background:linear-gradient(135deg,var(--header-from),var(--header-to))">${icon}</div>
        <div class="flex-1 min-w-0">
          <div class="font-bold capitalize text-sm">${esc(log.texture)} ${retroTag}</div>
          <div class="text-xs capitalize opacity-60">${esc(log.color)}</div>
          ${note}
          <div class="text-xs opacity-40 mt-1">${dt}</div>
        </div>
        <button class="p-2 text-red-400 hover:text-red-600 transition-colors" onclick="deleteLog('${log.id || i}')">
          <i class="fas fa-trash text-sm"></i>
        </button>
      </div>`;
    }).join('');
  }

  window.deleteLog = function(idOrIndex) {
    const idx = state.logs.findIndex(l => String(l.id) === String(idOrIndex) || String(state.logs.indexOf(l)) === String(idOrIndex));
    if (idx === -1) return;
    const deleted = state.logs[idx];
    state.logs.splice(idx, 1);
    saveState(state);
    renderAll();
    if (window.SupabaseClient?.isLoggedIn()) {
      if (navigator.onLine) {
        window.SupabaseClient.deletePoopCloud(deleted.id).catch(e => $debug('cloud del err: ' + e.message));
      } else {
        try {
          const queue = JSON.parse(localStorage.getItem('cacaTracker.offlineQueue') || '[]');
          queue.push({ type: 'del', id: deleted.id });
          localStorage.setItem('cacaTracker.offlineQueue', JSON.stringify(queue));
        } catch(e) { $debug('queue del err: ' + e.message); }
      }
    }
    $debug('ğŸ—‘ï¸ deleted');
  };

  // ===================================================
  //  STATS
  // ===================================================
  function renderStats() {
    // FrÃ©quence 7j
    const now = new Date();
    let totalLast7 = 0;
    for (let i = 0; i < 7; i++) {
      const d = new Date(now); d.setDate(d.getDate() - i);
      totalLast7 += state.logs.filter(l => new Date(l.date).toDateString() === d.toDateString()).length;
    }
    const avgPerDay = totalLast7 / 7;
    const maxFreq = 2.5;

    $id('bar-me').style.width = Math.min(100, (avgPerDay / maxFreq) * 100) + '%';
    $id('val-me').textContent = avgPerDay.toFixed(1) + '/j';

    // Verdict
    const fv = $id('freq-verdict');
    if (!fv) return;
    if (avgPerDay === 0) {
      fv.textContent = 'ğŸ“­ Aucune donnÃ©e cette semaineâ€¦';
      fv.style.cssText = 'background:rgba(100,116,139,0.1);color:#64748b';
    } else if (avgPerDay < 0.5) {
      fv.textContent = 'ğŸ˜¬ Attention Ã  la constipation ! En dessous des normes.';
      fv.style.cssText = 'background:rgba(239,68,68,0.1);color:#dc2626';
    } else if (avgPerDay < 1.0) {
      fv.textContent = 'ğŸ™‚ Norme basse â€” tout va bien !';
      fv.style.cssText = 'background:rgba(234,179,8,0.12);color:#b45309';
    } else if (avgPerDay <= 2.0) {
      fv.textContent = 'ğŸ† Dans les normes franÃ§aises et mondiales, bravo ClÃ©mence !';
      fv.style.cssText = 'background:rgba(5,150,105,0.12);color:#059669';
    } else {
      fv.textContent = 'ğŸš¨ Plus de 2/j â€” surveille peut-Ãªtre l\'alimentation ?';
      fv.style.cssText = 'background:rgba(249,115,22,0.12);color:#ea580c';
    }

    // Transit
    const sorted = [...state.logs].sort((a, b) => a.date - b.date);
    let avgTransitH = null;
    if (sorted.length >= 2) {
      let totalGap = 0;
      for (let i = 1; i < sorted.length; i++) totalGap += sorted[i].date - sorted[i-1].date;
      avgTransitH = totalGap / (sorted.length - 1) / 3600000;
    }
    if (avgTransitH !== null) {
      const h = Math.round(avgTransitH);
      $id('val-transit-me').textContent = h + 'h';
      $id('bar-transit-me').style.width = Math.min(100, (h / 72) * 100) + '%';
    } else {
      $id('val-transit-me').textContent = 'â€”';
      $id('bar-transit-me').style.width = '0%';
    }

    // Textures
    const textures = ['normal','dur','mou','spray','liquide','explosif'];
    const total = state.logs.length || 1;
    const tstats = $id('texture-stats');
    tstats.innerHTML = textures.map(t => {
      const count = state.logs.filter(l => l.texture === t).length;
      const pct = Math.round((count / total) * 100);
      const emoji = textureEmoji(t);
      let fillColor = '#f59e0b';
      if (t === 'normal') fillColor = '#10b981';
      if ((t === 'liquide' || t === 'explosif') && pct > 5) fillColor = '#ef4444';
      return `<div style="display:grid;grid-template-columns:28px 64px 1fr 40px 36px;align-items:center;gap:6px;">
        <span>${emoji}</span>
        <span class="text-xs font-bold capitalize opacity-80">${t}</span>
        <div class="stat-bar"><div class="stat-fill" style="width:${pct}%;background:${fillColor}"></div></div>
        <span class="text-xs font-bold text-right">${pct}%</span>
        <span class="text-xs opacity-40">(${count})</span>
      </div>`;
    }).join('');

    // Comparaison mensuelle
    renderMonthCompare();
    // Score santÃ© intestinale
    renderHealthScore();

    // Records personnels (feature 9)
    renderPersonalRecords();

    // Bristol Scale (feature 17)
    renderBristolScale();

    // Heatmap calendrier (charts.js)
    if (typeof createHeatmap === 'function') {
      const hmEl = $id('heatmap-container');
      if (hmEl) {
        hmEl.innerHTML = state.logs.length > 0 ? createHeatmap(state.logs) : '';
        // Clic sur un jour
        hmEl.addEventListener('click', e => {
          const cell = e.target.closest('[data-date]');
          if (cell) showDayDetail(cell.dataset.date);
        });
      }
    }
    // Graphiques avancÃ©s (charts.js)
    if (typeof createAllCharts === 'function' && state.logs.length > 0) {
      const chartsEl = $id('advanced-charts-container');
      if (chartsEl) chartsEl.innerHTML = createAllCharts(state.logs);
    }
  }

  // ===================================================
  //  STREAK
  // ===================================================
  function calculateStreak() {
    const hasDay = d => state.logs.some(l => new Date(l.date).toDateString() === d.toDateString());
    const today = new Date();
    if (!hasDay(today)) return 0;
    let streak = 1;
    for (let i = 1; i < 90; i++) {
      const d = new Date(); d.setDate(d.getDate() - i);
      if (hasDay(d)) streak++;
      else break;
    }
    return streak;
  }

  function updateStreakBadge() {
    const streak = calculateStreak();
    const el = $id('streak-badge');
    if (!el) return;
    if (streak >= 2) {
      el.style.display = 'flex';
      $id('streak-val').textContent = streak;
    } else {
      el.style.display = 'none';
    }
  }

  // ===================================================
  //  BADGES
  // ===================================================
  const BADGE_DEFS = [
    // â”€â”€ Originals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    { id:'first',        icon:'â­', label:'PremiÃ¨re Ã‰toile',         desc:'1er caca enregistrÃ©',               color:'#eab308' },
    { id:'streak3',      icon:'ğŸ”¥', label:'Flamme x3',               desc:'3 jours d\'affilÃ©e',                color:'#ef4444' },
    { id:'rainbow',      icon:'ğŸŒˆ', label:'Arcâ€‘enâ€‘Ciel',             desc:'Couleur arc-en-ciel utilisÃ©e',      color:'#8b5cf6' },
    { id:'veteran',      icon:'ğŸ†', label:'VÃ©tÃ©ran',                 desc:'10 cacas au total',                 color:'#f59e0b' },
    { id:'retro',        icon:'âª', label:'Archiviste',              desc:'1 caca en retard saisi',            color:'#7c3aed' },
    { id:'frenchie',     icon:'ğŸ‡«ğŸ‡·',label:'Ã€ la FranÃ§aise',         desc:'â‰¥ 1.1/j sur 7 jours',              color:'#3b82f6' },
    { id:'centenaire',   icon:'ğŸ’¯', label:'Centenaire',              desc:'100 cacas',                         color:'#059669' },
    { id:'nightcaca',    icon:'ğŸŒ™', label:'Caca de nuit',            desc:'Caca entre minuit et 5h',           color:'#1e293b' },
    // â”€â”€ Streak badges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    { id:'streak5',      icon:'ğŸ”¥', label:'En Feu !',               desc:'5 jours d\'affilÃ©e',                color:'#f97316' },
    { id:'streak7',      icon:'âš¡', label:'Semaine Parfaite',        desc:'7 jours d\'affilÃ©e',                color:'#eab308' },
    { id:'streak14',     icon:'ğŸŒŸ', label:'Deux Semaines',           desc:'14 jours d\'affilÃ©e',               color:'#a855f7' },
    { id:'streak30',     icon:'ğŸ‘‘', label:'Mois de Feu',             desc:'30 jours d\'affilÃ©e',               color:'#ec4899' },
    // â”€â”€ Volume â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    { id:'poops25',      icon:'ğŸ¥ˆ', label:'Argent',                  desc:'25 cacas',                          color:'#94a3b8' },
    { id:'poops50',      icon:'ğŸ¥‡', label:'Or Massif',               desc:'50 cacas',                          color:'#d97706' },
    { id:'poops200',     icon:'ğŸ’', label:'Diamant',                  desc:'200 cacas',                         color:'#38bdf8' },
    { id:'poops365',     icon:'ğŸŒŸ', label:'LÃ©gende',                  desc:'365 cacas',                         color:'#f59e0b' },
    { id:'poops500',     icon:'ğŸš€', label:'Astronaute',              desc:'500 cacas',                         color:'#6366f1' },
    { id:'poops1000',    icon:'ğŸŒŒ', label:'Galactique',              desc:'1000 cacas',                        color:'#0ea5e9' },
    // â”€â”€ Time of day â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    { id:'earlyBird',    icon:'ğŸ¦', label:'LÃ¨ve-TÃ´t',               desc:'Caca avant 7h du matin',            color:'#fbbf24' },
    { id:'morningPerson',icon:'â˜€ï¸', label:'MatinaliÃ¨re',             desc:'10 cacas avant 8h',                 color:'#fb923c' },
    { id:'afterLunch',   icon:'ğŸŒ¤ï¸', label:'Sieste Digestive',       desc:'5 cacas entre 12h et 14h',          color:'#34d399' },
    { id:'eveningCaca',  icon:'ğŸŒ†', label:'SoirÃ©e Tranquille',       desc:'5 cacas entre 18h et 21h',          color:'#818cf8' },
    { id:'nightOwl5',    icon:'ğŸ¦‰', label:'Hibou',                   desc:'5 cacas entre minuit et 5h',        color:'#7c3aed' },
    { id:'earlyMorning', icon:'ğŸŒ…', label:'L\'Aube',                 desc:'Caca avant 6h du matin',            color:'#f472b6' },
    // â”€â”€ Multi dans la mÃªme journÃ©e â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    { id:'double',       icon:'ğŸ¯', label:'Double Dose',             desc:'2 cacas le mÃªme jour',              color:'#22d3ee' },
    { id:'triple',       icon:'ğŸ°', label:'Triple',                  desc:'3 cacas le mÃªme jour',              color:'#a3e635' },
    { id:'quad',         icon:'ğŸ³', label:'QuadruplÃ©',               desc:'4 cacas le mÃªme jour',              color:'#fb7185' },
    { id:'volcano',      icon:'ğŸŒ‹', label:'Volcan',                  desc:'5 cacas le mÃªme jour',              color:'#ef4444' },
    // â”€â”€ Jours de la semaine â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    { id:'mondayBlues',  icon:'ğŸ˜«', label:'Le Lundi Ã§a part vite',   desc:'Caca un lundi',                     color:'#6b7280' },
    { id:'weekendW',     icon:'ğŸ‰', label:'Weekend Warrior',         desc:'5 cacas au total le weekend',        color:'#f59e0b' },
    { id:'fridayFun',    icon:'ğŸ•º', label:'TGIF',                    desc:'Caca un vendredi soir (â‰¥ 18h)',      color:'#84cc16' },
    // â”€â”€ Textures â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    { id:'allTextures',  icon:'ğŸ¨', label:'Artiste ComplÃ¨te',        desc:'Toutes les textures utilisÃ©es',     color:'#c084fc' },
    { id:'softie',       icon:'ğŸ’§', label:'Toute Douce',             desc:'10 cacas mous',                     color:'#38bdf8' },
    { id:'hardRock',     icon:'ğŸª¨', label:'Dure Ã  Cuire',            desc:'5 cacas durs',                      color:'#78716c' },
    { id:'normalNormal', icon:'ğŸ’ª', label:'Bien RÃ©glÃ©e',             desc:'20 cacas normaux',                  color:'#10b981' },
    { id:'explosive',    icon:'ğŸ’¥', label:'Explosive',               desc:'5 cacas explosifs',                 color:'#dc2626' },
    // â”€â”€ Couleurs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    { id:'colorCollect', icon:'ğŸ¨', label:'Chasseuse de Couleurs',   desc:'5 couleurs diffÃ©rentes utilisÃ©es',  color:'#ec4899' },
    { id:'allColors',    icon:'ğŸ–Œï¸', label:'Tableau de MaÃ®tre',       desc:'Toutes les couleurs utilisÃ©es',     color:'#8b5cf6' },
    { id:'brownMaster',  icon:'ğŸŸ¤', label:'Classique',               desc:'20 cacas marrons',                  color:'#92400e' },
    { id:'greenPower',   icon:'ğŸ’š', label:'VÃ©gÃ©tarienne ?',          desc:'5 cacas verts',                     color:'#16a34a' },
    // â”€â”€ Vitesse â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    { id:'speedRunner',  icon:'âš¡', label:'Speed Run',               desc:'3 cacas en moins de 12h',           color:'#facc15' },
    { id:'ultraSpeed',   icon:'ğŸŒªï¸', label:'Tornade',                 desc:'4 cacas en moins de 8h',            color:'#06b6d4' },
    { id:'sigma',        icon:'ğŸ˜', label:'Sigma',                   desc:'2 cacas en moins d\'1h',            color:'#1e293b' },
    // â”€â”€ Commentaires & humeur â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    { id:'journaliste',  icon:'ğŸ“', label:'Journaliste',             desc:'1er commentaire ajoutÃ©',            color:'#0ea5e9' },
    { id:'philosopher',  icon:'ğŸ¤”', label:'Philosophe',              desc:'10 commentaires',                   color:'#6366f1' },
    { id:'novelist',     icon:'ğŸ“š', label:'RomanciÃ¨re',              desc:'30 commentaires',                   color:'#a855f7' },
    { id:'moodStart',    icon:'ğŸ˜Š', label:'En Mode Mood',            desc:'PremiÃ¨re humeur enregistrÃ©e',       color:'#f472b6' },
    { id:'allMoods',     icon:'ğŸ­', label:'Actrice',                 desc:'Toutes les humeurs utilisÃ©es',      color:'#c084fc' },
    // â”€â”€ SpÃ©ciaux â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    { id:'worldChamp',   icon:'ğŸŒ', label:'Championne Mondiale',     desc:'DÃ©passe la moyenne mondiale (1.4/j)',color:'#059669' },
    { id:'retroMaster',  icon:'â°', label:'Archiviste Pro',          desc:'5 cacas en retard saisis',          color:'#7c3aed' },
    { id:'consistent',   icon:'ğŸ“…', label:'Comme une Horloge',       desc:'MÃªme heure Â±2h pendant 5 jours',   color:'#0284c7' },
    { id:'comeback',     icon:'ğŸ”„', label:'Le Grand Retour',         desc:'Revenir aprÃ¨s 7 jours sans caca',   color:'#64748b' },
    { id:'veteran50',    icon:'ğŸ–ï¸', label:'50 Jours',               desc:'50 jours depuis le 1er caca',       color:'#78716c' },
    { id:'veteran100',   icon:'ğŸ…', label:'100 Jours',              desc:'100 jours depuis le 1er caca',       color:'#d97706' },
    { id:'anniversary',  icon:'ğŸ‚', label:'Joyeux Anniversaire !',   desc:'1 an depuis le 1er caca',           color:'#ec4899' },
    { id:'bingo',        icon:'ğŸ±', label:'Bingo 42',                desc:'Le 42Ã¨me caca (Easter Egg)',        color:'#1e293b' },
    { id:'lucky7',       icon:'ğŸ²', label:'Lucky 7',                 desc:'7 cacas un 7 du mois',              color:'#16a34a' },
    { id:'midnight',     icon:'ğŸ•›', label:'Minuit',                  desc:'Caca entre 23h et 1h',              color:'#312e81' },
    { id:'allWeekDays',  icon:'ğŸ—“ï¸', label:'Toute la Semaine',       desc:'Caca chaque jour lunâ†’dim',          color:'#0891b2' },
  ];

  function buildBadgesGrid() {
    const grid = $id('badges-grid');
    if (!grid) return;
    grid.innerHTML = BADGE_DEFS.map(b => `
      <div class="card p-4 rounded-[1.5rem] text-center border-2 border-transparent transition-all" data-badge="${b.id}" style="border-color:transparent">
        <div class="text-4xl mb-2">${b.icon}</div>
        <div class="font-bold text-sm">${b.label}</div>
        <div class="text-xs opacity-60 mb-2">${b.desc}</div>
        <div class="w-full rounded-full overflow-hidden" style="height:6px;background:rgba(0,0,0,0.1)">
          <div class="badge-bar" style="height:100%;border-radius:99px;width:0%;background:${b.color};transition:width .5s ease"></div>
        </div>
      </div>`).join('');
  }

  function updateBadges() {
    const logs  = state.logs;
    const total = logs.length;
    const streak = calculateStreak();
    const now   = new Date();

    // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const countsByDay = {}; // 'YYYY-MM-DD' â†’ count
    logs.forEach(l => {
      const key = new Date(l.date).toDateString();
      countsByDay[key] = (countsByDay[key] || 0) + 1;
    });

    const last7Logs = (() => {
      let c = 0;
      for (let i = 0; i < 7; i++) {
        const d = new Date(now); d.setDate(d.getDate() - i);
        c += logs.filter(l => new Date(l.date).toDateString() === d.toDateString()).length;
      }
      return c;
    })();
    const avg7 = last7Logs / 7;

    const maxPerDay = Math.max(...Object.values(countsByDay), 0);

    // Fast same-day counts
    const dayGroups = {};
    logs.forEach(l => {
      const k = new Date(l.date).toDateString();
      if (!dayGroups[k]) dayGroups[k] = [];
      dayGroups[k].push(l);
    });

    // Streak speed: X cacas in N hours
    function minHoursForN(n) {
      if (logs.length < n) return Infinity;
      const sorted = [...logs].sort((a,b) => a.date - b.date);
      let min = Infinity;
      for (let i = 0; i <= sorted.length - n; i++) {
        const diff = (sorted[i+n-1].date - sorted[i].date) / 3600000;
        min = Math.min(min, diff);
      }
      return min;
    }

    // First log date
    const firstDate = logs.length ? new Date(Math.min(...logs.map(l => l.date))) : null;
    const daysSinceFirst = firstDate ? Math.floor((now - firstDate) / 86400000) : 0;

    // Comments, moods
    const commentCount = logs.filter(l => l.comment?.trim()).length;
    const moodsUsed    = new Set(logs.map(l => l.mood).filter(Boolean));
    const allMoodsList = ['normal','douloureux','urgent','difficile'];

    // Colors & textures
    const colorsUsed   = new Set(logs.map(l => l.color).filter(Boolean));
    const texturesUsed = new Set(logs.map(l => l.texture).filter(Boolean));
    const allTexList   = ['normal','dur','mou','spray','liquide','explosif'];

    // Comeback: last gap > 7 days followed by new logs
    const hasComeback = (() => {
      const s = [...logs].sort((a,b) => a.date - b.date);
      for (let i = 1; i < s.length; i++) {
        if ((s[i].date - s[i-1].date) / 86400000 > 7) return true;
      }
      return false;
    })();

    // Consistent same hour Â±2h over 5 days
    const isConsistent = (() => {
      if (logs.length < 5) return false;
      const sorted = [...logs].sort((a,b) => b.date - a.date);
      const hours = sorted.slice(0, 5).map(l => new Date(l.date).getHours());
      const avg = hours.reduce((a,b)=>a+b,0)/5;
      return hours.every(h => Math.abs(h - avg) <= 2);
    })();

    // Whole-week coverage (Mon-Sun same calendar week)
    const allWeekDaysDone = (() => {
      const weekMap = {};
      logs.forEach(l => {
        const d = new Date(l.date);
        const mon = new Date(d); mon.setDate(d.getDate() - (d.getDay()===0?6:d.getDay()-1)); mon.setHours(0,0,0,0);
        const wk = mon.getTime();
        if (!weekMap[wk]) weekMap[wk] = new Set();
        weekMap[wk].add(d.getDay()===0?7:d.getDay()); // 1=Monâ€¦7=Sun
      });
      return Object.values(weekMap).some(s => s.size >= 7);
    })();

    // Lucky 7: 7 cacas on a 7th of the month
    const hasLucky7 = (() => {
      const on7th = logs.filter(l => new Date(l.date).getDate() === 7);
      const days7 = new Set(on7th.map(l => new Date(l.date).toDateString()));
      return days7.size >= 1 &&
        [...days7].some(d => logs.filter(l => new Date(l.date).toDateString() === d).length >= 7);
    })();

    // â”€â”€ Badge conditions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const badges = {
      // Originals
      first:        { pct: total>=1?100:0,                               done: total>=1 },
      streak3:      { pct: Math.min(100,(streak/3)*100),                 done: streak>=3 },
      rainbow:      { pct: colorsUsed.has('arc-en-ciel')?100:0,          done: colorsUsed.has('arc-en-ciel') },
      veteran:      { pct: Math.min(100,(total/10)*100),                 done: total>=10 },
      retro:        { pct: logs.some(l=>l.isRetro)?100:0,                done: logs.some(l=>l.isRetro) },
      frenchie:     { pct: Math.min(100,(avg7/1.1)*100),                 done: avg7>=1.1 },
      centenaire:   { pct: Math.min(100,(total/100)*100),                done: total>=100 },
      nightcaca:    { pct: logs.some(l=>{const h=new Date(l.date).getHours();return h<5;})?100:0,
                      done: logs.some(l=>{const h=new Date(l.date).getHours();return h<5;}) },
      // Streaks
      streak5:      { pct: Math.min(100,(streak/5)*100),                 done: streak>=5 },
      streak7:      { pct: Math.min(100,(streak/7)*100),                 done: streak>=7 },
      streak14:     { pct: Math.min(100,(streak/14)*100),                done: streak>=14 },
      streak30:     { pct: Math.min(100,(streak/30)*100),                done: streak>=30 },
      // Volume
      poops25:      { pct: Math.min(100,(total/25)*100),                 done: total>=25 },
      poops50:      { pct: Math.min(100,(total/50)*100),                 done: total>=50 },
      poops200:     { pct: Math.min(100,(total/200)*100),                done: total>=200 },
      poops365:     { pct: Math.min(100,(total/365)*100),                done: total>=365 },
      poops500:     { pct: Math.min(100,(total/500)*100),                done: total>=500 },
      poops1000:    { pct: Math.min(100,(total/1000)*100),               done: total>=1000 },
      // Time of day
      earlyBird:    { pct: logs.some(l=>new Date(l.date).getHours()<7)?100:0,
                      done: logs.some(l=>new Date(l.date).getHours()<7) },
      morningPerson:{ pct: Math.min(100,(logs.filter(l=>new Date(l.date).getHours()<8).length/10)*100),
                      done: logs.filter(l=>new Date(l.date).getHours()<8).length>=10 },
      afterLunch:   { pct: Math.min(100,(logs.filter(l=>{const h=new Date(l.date).getHours();return h>=12&&h<14;}).length/5)*100),
                      done: logs.filter(l=>{const h=new Date(l.date).getHours();return h>=12&&h<14;}).length>=5 },
      eveningCaca:  { pct: Math.min(100,(logs.filter(l=>{const h=new Date(l.date).getHours();return h>=18&&h<21;}).length/5)*100),
                      done: logs.filter(l=>{const h=new Date(l.date).getHours();return h>=18&&h<21;}).length>=5 },
      nightOwl5:    { pct: Math.min(100,(logs.filter(l=>new Date(l.date).getHours()<5).length/5)*100),
                      done: logs.filter(l=>new Date(l.date).getHours()<5).length>=5 },
      earlyMorning: { pct: logs.some(l=>new Date(l.date).getHours()<6)?100:0,
                      done: logs.some(l=>new Date(l.date).getHours()<6) },
      // Multi per day
      double:       { pct: maxPerDay>=2?100:0,                          done: maxPerDay>=2 },
      triple:       { pct: maxPerDay>=3?100:0,                          done: maxPerDay>=3 },
      quad:         { pct: maxPerDay>=4?100:0,                          done: maxPerDay>=4 },
      volcano:      { pct: maxPerDay>=5?100:0,                          done: maxPerDay>=5 },
      // Week days
      mondayBlues:  { pct: logs.some(l=>new Date(l.date).getDay()===1)?100:0,
                      done: logs.some(l=>new Date(l.date).getDay()===1) },
      weekendW:     { pct: Math.min(100,(logs.filter(l=>{const d=new Date(l.date).getDay();return d===0||d===6;}).length/5)*100),
                      done: logs.filter(l=>{const d=new Date(l.date).getDay();return d===0||d===6;}).length>=5 },
      fridayFun:    { pct: logs.some(l=>new Date(l.date).getDay()===5&&new Date(l.date).getHours()>=18)?100:0,
                      done: logs.some(l=>new Date(l.date).getDay()===5&&new Date(l.date).getHours()>=18) },
      // Textures
      allTextures:  { pct: Math.min(100,(texturesUsed.size/allTexList.length)*100),
                      done: allTexList.every(t=>texturesUsed.has(t)) },
      softie:       { pct: Math.min(100,(logs.filter(l=>l.texture==='mou').length/10)*100),
                      done: logs.filter(l=>l.texture==='mou').length>=10 },
      hardRock:     { pct: Math.min(100,(logs.filter(l=>l.texture==='dur').length/5)*100),
                      done: logs.filter(l=>l.texture==='dur').length>=5 },
      normalNormal: { pct: Math.min(100,(logs.filter(l=>l.texture==='normal').length/20)*100),
                      done: logs.filter(l=>l.texture==='normal').length>=20 },
      explosive:    { pct: Math.min(100,(logs.filter(l=>l.texture==='explosif').length/5)*100),
                      done: logs.filter(l=>l.texture==='explosif').length>=5 },
      // Colors
      colorCollect: { pct: Math.min(100,(colorsUsed.size/5)*100),       done: colorsUsed.size>=5 },
      allColors:    { pct: Math.min(100,(colorsUsed.size/6)*100),        done: colorsUsed.size>=6 },
      brownMaster:  { pct: Math.min(100,(logs.filter(l=>l.color==='marron').length/20)*100),
                      done: logs.filter(l=>l.color==='marron').length>=20 },
      greenPower:   { pct: Math.min(100,(logs.filter(l=>l.color==='vert').length/5)*100),
                      done: logs.filter(l=>l.color==='vert').length>=5 },
      // Speed
      speedRunner:  { pct: minHoursForN(3)<=12?100:0,                   done: minHoursForN(3)<=12 },
      ultraSpeed:   { pct: minHoursForN(4)<=8?100:0,                    done: minHoursForN(4)<=8 },
      sigma:        { pct: minHoursForN(2)<=1?100:0,                    done: minHoursForN(2)<=1 },
      // Comments & mood
      journaliste:  { pct: commentCount>=1?100:0,                       done: commentCount>=1 },
      philosopher:  { pct: Math.min(100,(commentCount/10)*100),         done: commentCount>=10 },
      novelist:     { pct: Math.min(100,(commentCount/30)*100),         done: commentCount>=30 },
      moodStart:    { pct: moodsUsed.size>=1?100:0,                     done: moodsUsed.size>=1 },
      allMoods:     { pct: Math.min(100,(moodsUsed.size/allMoodsList.length)*100),
                      done: allMoodsList.every(m=>moodsUsed.has(m)) },
      // Special
      worldChamp:   { pct: Math.min(100,(avg7/1.4)*100),                done: avg7>=1.4 },
      retroMaster:  { pct: Math.min(100,(logs.filter(l=>l.isRetro).length/5)*100),
                      done: logs.filter(l=>l.isRetro).length>=5 },
      consistent:   { pct: isConsistent?100:0,                          done: isConsistent },
      comeback:     { pct: hasComeback?100:0,                           done: hasComeback },
      veteran50:    { pct: Math.min(100,(daysSinceFirst/50)*100),       done: daysSinceFirst>=50 },
      veteran100:   { pct: Math.min(100,(daysSinceFirst/100)*100),      done: daysSinceFirst>=100 },
      anniversary:  { pct: Math.min(100,(daysSinceFirst/365)*100),      done: daysSinceFirst>=365 },
      bingo:        { pct: total>=42?100:0,                             done: total===42||total>42 },
      lucky7:       { pct: hasLucky7?100:0,                             done: hasLucky7 },
      midnight:     { pct: logs.some(l=>{const h=new Date(l.date).getHours();return h>=23||h<1;})?100:0,
                      done: logs.some(l=>{const h=new Date(l.date).getHours();return h>=23||h<1;}) },
      allWeekDays:  { pct: allWeekDaysDone?100:0,                       done: allWeekDaysDone },
    };

    Object.entries(badges).forEach(([id, {pct, done}]) => {
      const card = document.querySelector(`[data-badge="${id}"]`);
      if (!card) return;
      const bar = card.querySelector('.badge-bar');
      if (bar) bar.style.width = pct.toFixed(0) + '%';
      const def = BADGE_DEFS.find(b => b.id === id);
      card.style.borderColor = done ? (def?.color || '#f59e0b') : 'transparent';
      card.style.opacity = done ? '1' : '0.65';
    });
  }

  // ===================================================
  //  CHART
  // ===================================================
  function initChart() {
    if (!window.Chart) {
      $id('chart-fallback')?.classList.remove('hidden');
      return;
    }
    try {
      const ctx = $id('week-chart').getContext('2d');
      weekChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: [],
          datasets: [{
            data: [],
            backgroundColor: 'rgba(251,191,36,.8)',
            borderColor: '#d97706',
            borderWidth: 2,
            borderRadius: 8,
            borderSkipped: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true, ticks: { stepSize: 1, precision: 0 } } }
        }
      });
      updateChart();
    } catch(e) {
      $id('chart-fallback')?.classList.remove('hidden');
      $debug('chart err: ' + e.message);
    }
  }

  function updateChart() {
    if (!weekChart) return;
    const labels = [], data = [];
    const now = new Date();
    for (let i = 6; i >= 0; i--) {
      const d = new Date(now); d.setDate(d.getDate() - i);
      labels.push(d.toLocaleDateString('fr-FR', {weekday:'short'}));
      data.push(state.logs.filter(l => new Date(l.date).toDateString() === d.toDateString()).length);
    }
    weekChart.data.labels = labels;
    weekChart.data.datasets[0].data = data;
    weekChart.update('none');
  }

  // ===================================================
  //  CLOUD â†’ LOCAL SYNC
  // ===================================================
  async function syncCloudData() {
    if (!window.SupabaseClient?.isLoggedIn()) return;
    try {
      const cloudPoops = await window.SupabaseClient.getMyPoops();
      if (!cloudPoops.length) return;

      // Build a map of local entries by ID
      const localMap = new Map(state.logs.map(l => [String(l.id), l]));
      let changed = 0;

      for (const p of cloudPoops) {
        const key = String(p.id);
        if (!localMap.has(key)) {
          // Absent en local â†’ ajouter
          state.logs.push(p);
          changed++;
        } else {
          // PrÃ©sent des deux cÃ´tÃ©s â†’ conserver le plus rÃ©cent (updated_at)
          const local = localMap.get(key);
          const cloudUpdAt = p.updated_at || 0;
          const localUpdAt = local.updated_at || 0;
          if (cloudUpdAt > localUpdAt) {
            Object.assign(local, p);
            changed++;
          }
        }
      }

      if (changed > 0) {
        state.logs.sort((a, b) => b.date - a.date);
        saveState(state);
        renderAll();
        $debug(`â˜ï¸ ${changed} entrÃ©e(s) synchronisÃ©e(s) depuis le cloud`);
      }
    } catch(e) {
      $debug('cloud sync err: ' + e.message);
    }
  }
  window.syncCloudData = syncCloudData;

  // ===================================================
  //  OFFLINE QUEUE  (feature 14)
  // ===================================================
  async function processOfflineQueue() {
    if (!window.SupabaseClient?.isLoggedIn()) return;
    const raw = localStorage.getItem('cacaTracker.offlineQueue');
    if (!raw) return;
    let queue;
    try { queue = JSON.parse(raw); } catch { return; }
    if (!queue.length) return;

    const remaining = [];
    for (const item of queue) {
      try {
        if (item.type === 'add') {
          await window.SupabaseClient.savePoopCloud(item.poop);
        } else if (item.type === 'del') {
          await window.SupabaseClient.deletePoopCloud(item.id);
        }
        $debug(`â˜ï¸ Queue: ${item.type} envoyÃ©`);
      } catch(e) {
        $debug('queue flush err: ' + e.message);
        remaining.push(item); // rÃ©essayer plus tard
      }
    }

    if (remaining.length) {
      localStorage.setItem('cacaTracker.offlineQueue', JSON.stringify(remaining));
    } else {
      localStorage.removeItem('cacaTracker.offlineQueue');
      $debug('âœ… File offline vidÃ©e â€” tout synchronisÃ©');
    }
  }
  window.processOfflineQueue = processOfflineQueue;

  // ===================================================
  //  EXPORT / CLEAR
  // ===================================================
  function exportData() {
    try {
      const blob = new Blob([JSON.stringify(state, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'clemence-caca-tracker.json'; a.click();
      URL.revokeObjectURL(url);
      $debug('ğŸ“¤ export ok');
    } catch(e) { $debug('export err: ' + e.message); }
  }

  function importData() {
    const file = this.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const imported = JSON.parse(e.target.result);
        if (!imported.logs || !Array.isArray(imported.logs)) {
          alert('Fichier invalide : aucun log trouvÃ©.');
          return;
        }
        const existingIds = new Set(state.logs.map(l => String(l.id)));
        const newLogs = imported.logs.filter(l => !existingIds.has(String(l.id)));
        state.logs = [...state.logs, ...newLogs].sort((a, b) => b.date - a.date);
        saveState(state);
        renderAll();
        alert(`âœ… ${newLogs.length} entrÃ©e(s) importÃ©e(s) !`);
      } catch(err) {
        alert('Erreur import : ' + err.message);
      }
    };
    reader.readAsText(file);
    this.value = '';
  }

  function clearAll() {
    if (!confirm('Supprimer absolument tous les cacas de ClÃ©mence ? ğŸ˜±')) return;
    state.logs = [];
    saveState(state);
    renderAll();
    $debug('ğŸ§¹ cleared');
  }

  // ===================================================
  //  CONFETTI
  // ===================================================
  function showConfetti() {
    const emojis = ['ğŸ‰','âœ¨','ğŸŒŸ','ğŸŠ','ğŸ’©','ğŸ«¶'];
    for (let i = 0; i < 30; i++) {
      const el = document.createElement('div');
      el.className = 'confetti';
      el.textContent = emojis[Math.floor(Math.random() * emojis.length)];
      el.style.left = Math.random() * 100 + 'vw';
      el.style.animationDelay = (Math.random() * 0.4) + 's';
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 3500);
    }
  }

  // ===================================================
  //  UTILS
  // ===================================================
  function textureEmoji(t) {
    return ({normal:'ğŸ’©',dur:'ğŸ—¿',mou:'ğŸ®',spray:'ğŸ’¦',liquide:'ğŸŒŠ',explosif:'ğŸ’¥'})[t] || 'ğŸ’©';
  }

  function esc(s) {
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }
  </script>

    <!-- Nouveaux modules JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="js/supabase-client.js"></script>
    <script src="js/social.js"></script>
    <script src="js/sounds.js"></script>
    <script src="js/jokes.js"></script>
    <script src="js/achievements.js"></script>
    <script src="js/predictions.js"></script>
    <script src="js/charts.js"></script>
    <script src="js/animations.js"></script>

  <!-- Rapport mÃ©dical (cachÃ©, imprimÃ© via @media print) -->
  <div id="print-report"></div>
</body>
</html>
